<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheckFlow - Check Printing</title>

    <!-- Google Analytics (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-E4RTNE5HCG"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-E4RTNE5HCG');
    </script>

    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* MICR E-13B Font - Base64 encoded GnuMICR */
        @font-face {
            font-family: 'MICR';
            src: url('data:font/truetype;base64,AAEAAAALAIAAAwAwT1MvMg8SBegAAAC8AAAAYGNtYXAaVsybAAABHAAAAExnYXNwAAAAEAAAAWgAAAAIZ2x5ZgJzAJsAAAFwAAAD9GhlYWQWKk6jAAAFZAAAADZoaGVhB+ID6gAABZwAAAAkaG10eBIAAJMAAAXAAAAAOGxvY2EEpgTuAAAF+AAAACBtYXhwABQAcwAABhgAAAAgbmFtZZxofswAAAY4AAABknBvc3QAAwAAAAAHzAAAACAAAwQAAZAABQAAApkCzAAAAI8CmQLMAAAB6wAzAQkAAAAAAAAAAAAAAAAAAAABEAAAAAAAAAAAAAAAAAAAAABAAADpCgPA/8D/wAPAAEAAAAABAAAAAAAAAAAAAAAgAAAAAAACAAAAAwAAABQAAwABAAAAFAAEADgAAAAKAAgAAgACAAEAIOkK//3//wAAAAAAIOkA//3//wAB/+MXBAADAAEAAAAAAAAAAAAAAAEAAf//AA8AAQAAAAAAAAAAAAIAADc5AQAAAAABAAAAAAAAAAAAAgAANzkBAAAAAAEAAAAAAAAAAAACAAA3OQEAAAAAAQAAABkDgANnABsAAAEHBgcWFxYXNjc2NzY3JicmJwYHBgcGBwYHJzcCAEsGCgYGDwgKDAoICwIGCQQRBwgMCgkKKUoDZwMjIwQEGAgLDAoKEyMeBQQUCAoMCgsYBCMAAAABAAAAMAOAAyYAEQAAATcXNxc3FzcnNycHJwcXBwcnAUBGbkZuRm5GLHAseixwLHAscAJARm5GbkZuRixwLHAscCxwLHAAAQAAAAEAADcPBs1fDzz1AAsEAAAAAADaAnHyAAAAANoCcfIAAP/ABAADwAAAAAgAAgAAAAAAAAABAAADwP/AAAAEAAAAAAAEAAABAAAAAAAAAAAAAAAAAAAADgQAAAAAAAAAAAAAAAIAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAAAAAAAAoAFAAeADYAQgBOAFoAZgByAH4AigCWAKIArgABAAAADgBxAAUAAAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAADgCuAAEAAAAAAAEADQAAAAEAAAAAAAIABwCWAAEAAAAAAAMADQBIAAEAAAAAAAQADQCrAAEAAAAAAAUACwAnAAEAAAAAAAYADQBvAAEAAAAAAAoAGgDGAAMAAQQJAAEAGgANAAMAAQQJAAIADgCdAAMAAQQJAAMAGgBVAAMAAQQJAAQAGgC4AAMAAQQJAAUAFgAyAAMAAQQJAAYAGgB8AAMAAQQJAAoANADgTUlDUiBFbmNvZGluZwBNAEkAQwBSACAARQBuAGMAbwBkAGkAbgBnVmVyc2lvbiAxLjAAVgBlAHIAcwBpAG8AbgAgADEALgAwTUlDUkVuY29kaW5nAE0ASQBDAFIARQBuAGMAbwBkAGkAbgBnTUlDUiBFbmNvZGluZwBNAEkAQwBSACAARQBuAGMAbwBkAGkAbgBnUmVndWxhcgBSAGUAZwB1AGwAYQByTUlDUiBFbmNvZGluZwBNAEkAQwBSACAARQBuAGMAbwBkAGkAbgBnTWF0dGhldyBXZWxjaCAtIGh0dHA6Ly93d3cuc3F1YXJlZ2Vhci5uZXQvZm9udHMvAE0AYQB0AHQAaABlAHcAIABXAGUAbABjAGgAIAAtACAAaAB0AHQAcAA6AC8ALwB3AHcAdwAuAHMAcQB1AGEAcgBlAGcAZQBhAHIALgBuAGUAdAAvAGYAbwBuAHQAcwAvAAAAAgAAAAAAAP+DADIAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAABAAIBAgEDAQQBBQEGAQcBCAEJAQoBCwEMBm9uLXVzB3RyYW5zaXQGYW1vdW50BGRhc2gAAAA=') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
    </style>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --accent: #2563eb;
            --accent-hover: #1d4ed8;
            --accent-light: #eff6ff;
            --border: #e2e8f0;
            --border-dark: #cbd5e1;
            --danger: #dc2626;
            --warning: #d97706;
            --success: #059669;
            --check-bg: #fffef7;
            --check-border: #c9c5b9;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .app-container {
            display: grid;
            grid-template-columns: 240px 1fr;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 20px 12px;
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 0;
            height: 100vh;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 28px;
            padding: 0 8px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--accent);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            color: var(--text-secondary);
            margin-bottom: 2px;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent-light);
            color: var(--accent);
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
        }

        .account-selector {
            margin-top: auto;
            padding: 14px;
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .account-selector-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .account-dropdown {
            width: 100%;
            padding: 8px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            cursor: pointer;
        }

        /* Main */
        .main-content {
            padding: 28px;
            overflow-y: auto;
            max-height: 100vh;
            background: var(--bg-primary);
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .page-title {
            font-size: 22px;
            font-weight: 700;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 2px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 9px 16px;
            border-radius: 7px;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn svg {
            width: 16px;
            height: 16px;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
        }

        .card-title svg {
            width: 18px;
            height: 18px;
            color: var(--accent);
        }

        /* Form */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 14px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-label .required {
            color: var(--danger);
        }

        .form-input,
        .form-select {
            padding: 9px 11px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            transition: all 0.15s;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        .form-input.mono {
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 1px;
        }

        .form-hint {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Check Preview */
        .check-preview-container {
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
            border-radius: 10px;
            padding: 24px;
            display: flex;
            justify-content: center;
            margin-bottom: 16px;
        }

        .check {
            width: 720px;
            height: 300px;
            background: var(--check-bg);
            border: 1px solid var(--check-border);
            border-radius: 2px;
            padding: 18px 24px;
            position: relative;
            font-family: 'DM Sans', sans-serif;
            color: #1a1a1a;
            box-shadow: var(--shadow-md);
        }

        .check-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 14px;
        }

        .check-issuer {
            font-size: 12px;
            line-height: 1.4;
        }

        .check-issuer-name {
            font-weight: 600;
            font-size: 14px;
        }

        .check-bank {
            text-align: center;
        }

        .check-bank-name {
            font-size: 15px;
            font-weight: 600;
        }

        .check-bank-code {
            font-size: 10px;
            color: #666;
        }

        .check-number-date {
            text-align: right;
        }

        .check-number {
            font-size: 14px;
            font-weight: 600;
        }

        .check-date-row {
            font-size: 11px;
            margin-top: 4px;
        }

        .check-date-value {
            border-bottom: 1px solid #888;
            padding: 2px 6px;
            min-width: 90px;
            display: inline-block;
        }

        .check-payee {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .check-payee-label {
            font-size: 10px;
            white-space: nowrap;
            line-height: 1.2;
        }

        .check-payee-line {
            flex: 1;
            border-bottom: 1px solid #888;
            font-size: 13px;
            padding: 2px 6px;
            min-height: 20px;
        }

        .check-amount-box {
            border: 1px solid #666;
            padding: 3px 8px;
            font-size: 14px;
            font-weight: 600;
            min-width: 100px;
            text-align: right;
            background: #fff;
        }

        .check-amount-box::before {
            content: '$';
            margin-right: 3px;
        }

        .check-written-amount {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 14px;
        }

        .check-written-line {
            flex: 1;
            border-bottom: 1px solid #888;
            font-size: 12px;
            padding: 2px 6px;
            min-height: 20px;
        }

        .check-dollars-label {
            font-size: 11px;
            font-weight: 600;
        }

        .check-memo-signature {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 20px;
        }

        .check-memo-label {
            font-size: 9px;
            color: #666;
        }

        .check-memo-line {
            border-bottom: 1px solid #888;
            font-size: 11px;
            padding: 2px 6px;
            min-height: 18px;
            max-width: 200px;
        }

        .check-signature-line {
            border-bottom: 1px solid #888;
            min-width: 180px;
            height: 40px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .check-signature-img {
            max-height: 38px;
            max-width: 170px;
        }

        .check-micr {
            position: absolute;
            bottom: 10px;
            left: 24px;
            right: 24px;
            font-family: 'MICR', 'Courier New', monospace;
            font-size: 14px;
            letter-spacing: 0;
            color: #1a1a1a;
        }

        /* Signature */
        .signature-container {
            border: 1px dashed var(--border);
            border-radius: 8px;
            padding: 14px;
            background: var(--bg-secondary);
        }

        .signature-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }

        .signature-tab {
            padding: 7px 14px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .signature-tab:hover {
            border-color: var(--border-dark);
        }

        .signature-tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .signature-canvas-wrapper {
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }

        /* OLD: #signatureCanvas removed - signature now in Account modal */
        .signature-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .signature-upload-area {
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: var(--bg-card);
            border-radius: 6px;
        }

        /* Section */
        .section-divider {
            border-top: 1px solid var(--border);
            margin: 18px 0;
            padding-top: 18px;
        }

        .section-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 14px;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 10px 14px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        td {
            padding: 12px 14px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }

        tr:hover td {
            background: var(--bg-hover);
        }

        .amount-cell {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }

        .status-badge {
            display: inline-flex;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-draft {
            background: #fef3c7;
            color: var(--warning);
        }

        .status-saved {
            background: #dbeafe;
            color: #2563eb;
        }

        .status-printed {
            background: #ecfdf5;
            color: var(--success);
        }

        .status-voided {
            background: #fee2e2;
            color: #dc2626;
            text-decoration: line-through;
        }

        .status-cleared {
            background: #e8f5e9;
            color: #2e7d32;
            font-weight: 600;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            max-width: 550px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 17px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
        }

        .modal-close:hover {
            background: var(--bg-hover);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Pricing Modal */
        .pricing-modal {
            max-width: 900px;
            width: 95%;
            max-height: 95vh;
        }

        .pricing-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .pricing-header h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .pricing-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            width: 100%;
        }

        .pricing-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            position: relative;
            transition: all 0.2s;
        }

        .pricing-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .pricing-card.recommended {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(59, 130, 246, 0.1));
        }

        .pricing-badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .pricing-card h3 {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .pricing-card .price {
            font-size: 32px;
            font-weight: 700;
            margin: 16px 0;
        }

        .pricing-card .price span {
            font-size: 14px;
            font-weight: 400;
            color: var(--text-secondary);
        }

        .pricing-card .trial {
            font-size: 12px;
            color: var(--success);
            margin-bottom: 16px;
        }

        .pricing-features {
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0;
        }

        .pricing-features li {
            padding: 8px 0;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid var(--border);
        }

        .pricing-features li:last-child {
            border-bottom: none;
        }

        .pricing-features .feat-check {
            color: var(--success);
            font-weight: bold;
        }

        .pricing-features .feat-cross {
            color: var(--text-muted);
        }

        .pricing-cta {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .pricing-cta.primary {
            background: var(--primary);
            color: white;
        }

        .pricing-cta.secondary {
            background: var(--bg-card);
            border: 1px solid var(--border);
        }

        .pricing-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 12px;
            color: var(--text-muted);
        }

        @media (max-width: 900px) {
            .pricing-grid {
                grid-template-columns: 1fr 1fr;
            }

            .pricing-modal {
                max-width: 95%;
            }
        }

        @media (max-width: 600px) {
            .pricing-grid {
                grid-template-columns: 1fr;
            }

            .pricing-modal {
                max-width: 98%;
                padding: 16px;
            }

            .pricing-card {
                padding: 16px;
            }
        }

        /* Import/Export */
        .ie-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .ie-card {
            background: var(--bg-secondary);
            border: 1px dashed var(--border);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
        }

        .ie-card:hover {
            border-color: var(--accent);
            background: var(--accent-light);
        }

        .ie-icon {
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            border: 1px solid var(--border);
        }

        .ie-icon svg {
            width: 20px;
            height: 20px;
            color: var(--accent);
        }

        .ie-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .ie-desc {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 18px;
            box-shadow: var(--shadow-md);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 3px solid var(--success);
        }

        .toast.error {
            border-left: 3px solid var(--danger);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.4;
        }

        .empty-state h3 {
            color: var(--text-primary);
            margin-bottom: 6px;
            font-size: 15px;
        }

        .file-input {
            display: none;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Print */
        @media print {

            body,
            html {
                margin: 0;
                padding: 0;
            }

            body * {
                visibility: hidden;
            }

            #printArea,
            #printArea * {
                visibility: visible !important;
            }

            #printArea {
                position: fixed;
                left: 0;
                top: 0;
                width: 8.5in;
                height: 11in;
                padding: 0;
                margin: 0;
                background: white;
            }

            .app-container,
            .sidebar,
            .main-content {
                display: none !important;
            }
        }

        #printArea {
            display: none;
        }

        /* ========== MOBILE STYLES (Phase 1) ========== */

        /* Hamburger Menu Button */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: var(--primary);
            color: white;
            z-index: 1000;
            padding: 0 16px;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .hamburger {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .hamburger span {
            display: block;
            width: 24px;
            height: 3px;
            background: white;
            border-radius: 2px;
            transition: transform 0.3s, opacity 0.3s;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        .mobile-title {
            font-weight: 600;
            font-size: 18px;
        }

        .mobile-header-spacer {
            width: 40px;
        }

        /* Slide-out Navigation */
        .mobile-nav-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .mobile-nav-overlay.active {
            opacity: 1;
        }

        .mobile-nav {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: var(--bg-dark);
            z-index: 1002;
            transition: left 0.3s ease;
            padding-top: 20px;
            overflow-y: auto;
        }

        .mobile-nav.active {
            left: 0;
        }

        .mobile-nav-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 10px;
        }

        .mobile-nav-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            font-size: 20px;
            font-weight: 600;
        }

        .mobile-nav-logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .mobile-nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
        }

        .mobile-nav-item:hover,
        .mobile-nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .mobile-nav-item svg {
            width: 24px;
            height: 24px;
        }

        /* Mobile Layout */
        @media (max-width: 768px) {
            .mobile-header {
                display: flex;
            }

            .mobile-nav-overlay {
                display: block;
                pointer-events: none;
            }

            .mobile-nav-overlay.active {
                pointer-events: auto;
            }

            .app-container {
                grid-template-columns: 1fr;
                padding-top: 56px;
                /* Space for fixed header */
            }

            .sidebar {
                display: none !important;
            }

            .main-content {
                padding: 16px;
                padding-bottom: 80px;
                /* Space for potential bottom actions */
            }

            /* Stacked form layout */
            .form-grid {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }

            /* Larger touch targets */
            .form-input,
            .form-select,
            select,
            input[type="text"],
            input[type="number"],
            input[type="date"] {
                min-height: 48px !important;
                font-size: 16px !important;
                /* Prevents iOS zoom */
                padding: 12px !important;
            }

            .btn {
                min-height: 48px;
                font-size: 16px;
                padding: 12px 20px;
            }

            /* Full-width buttons on mobile */
            .header-actions {
                flex-wrap: wrap;
                gap: 8px;
            }

            .header-actions .btn {
                flex: 1 1 calc(50% - 4px);
                min-width: 120px;
            }

            /* Check preview scaling */
            .check-preview-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .check {
                width: 100%;
                min-width: 320px;
                height: auto;
                aspect-ratio: 2.4/1;
                font-size: 12px;
            }

            .check-amount-box {
                font-size: 12px;
                min-width: 80px;
            }

            .check-amount-words {
                font-size: 10px;
            }

            /* Signature canvas full-width */
            .signature-canvas-container {
                width: 100% !important;
            }

            /* OLD: #signatureCanvas mobile styles removed - signature now in Account modal */

            /* Card headers */
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .card-header h2 {
                font-size: 18px;
            }

            /* Filter bar stacked */
            .filter-bar,
            [style*="display:flex"][style*="gap:12px"][style*="flex-wrap"] {
                flex-direction: column !important;
            }

            .filter-bar>div,
            [style*="flex:1;min-width"] {
                width: 100% !important;
                min-width: 100% !important;
            }

            /* Modal full-width on mobile */
            .modal {
                width: 95% !important;
                max-width: none !important;
                max-height: 85vh;
                margin: 10px;
            }

            /* Section dividers */
            .section-divider {
                margin: 16px 0;
            }

            /* Account selector prominent */
            #currentAccount {
                font-size: 16px !important;
                min-height: 48px !important;
            }

            /* Tabs */
            .signature-tabs {
                width: 100%;
            }

            .signature-tab {
                flex: 1;
                min-height: 44px;
            }
        }

        /* Extra small screens */
        @media (max-width: 400px) {
            .check {
                font-size: 10px;
            }

            .check-issuer-name {
                font-size: 12px;
            }

            .header-actions .btn {
                flex: 1 1 100%;
            }
        }
    </style>
</head>

<body>
    <!-- Mobile Header -->
    <header class="mobile-header">
        <button class="hamburger" onclick="toggleMobileNav()" aria-label="Menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="mobile-title">CheckFlow</div>
        <div class="mobile-header-spacer"></div>
    </header>

    <!-- Mobile Navigation Overlay -->
    <div class="mobile-nav-overlay" onclick="toggleMobileNav()"></div>

    <!-- Mobile Slide-out Navigation -->
    <nav class="mobile-nav">
        <div class="mobile-nav-header">
            <div class="mobile-nav-logo">
                <div class="mobile-nav-logo-icon">‚úì</div>
                <span>CheckFlow</span>
            </div>
        </div>
        <div class="mobile-nav-item active" data-page="write" onclick="mobileNavTo('write')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            Write Check
        </div>
        <div class="mobile-nav-item" data-page="history" onclick="mobileNavTo('history')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            History
        </div>
        <div class="mobile-nav-item" data-page="import-export" onclick="mobileNavTo('import-export')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
            </svg>
            Import/Export
        </div>
        <div class="mobile-nav-item" data-page="accounts" onclick="mobileNavTo('accounts')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
            Accounts
        </div>
        <div class="mobile-nav-item" data-page="settings" onclick="mobileNavTo('settings')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Settings
        </div>

        <!-- Mobile Plan Badge & Upgrade Button -->
        <div style="padding:12px 16px;border-top:1px solid var(--border);">
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:10px;">
                <span id="mobilePlanBadge"
                    style="background:var(--text-muted);padding:3px 8px;border-radius:12px;font-size:12px;font-weight:600;color:#fff;">Free</span>
            </div>
            <button id="mobileUpgradeBtn" class="btn btn-primary" onclick="showPricingModal();toggleMobileNav();"
                style="width:100%;padding:12px 16px;font-size:14px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Upgrade Plan
            </button>
        </div>

        <!-- Mobile Account Section -->
        <div style="padding:16px;border-top:1px solid var(--border);">
            <div style="margin-bottom:12px;">
                <label
                    style="font-size:11px;font-weight:600;color:var(--text-muted);display:block;margin-bottom:6px;">ACCOUNT</label>
                <select class="account-dropdown" id="mobileCurrentAccount"
                    style="width:100%;padding:12px;font-size:16px;border-radius:8px;"></select>
            </div>
            <div id="mobileUserDisplay" style="font-size:13px;color:var(--text-secondary);">
                <button class="btn btn-primary" style="width:100%;padding:12px;font-size:14px;"
                    onclick="showLoginModal();toggleMobileNav();">Sign In</button>
            </div>
        </div>
    </nav>

    <div class="app-container">
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon">‚úì</div>
                <div class="logo-text">CheckFlow</div>
            </div>
            <div class="nav-item active" data-page="write">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                Write Check
            </div>
            <div class="nav-item" data-page="history">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                History
            </div>
            <div class="nav-item" data-page="import-export">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                </svg>
                Import/Export
            </div>
            <div class="nav-item" data-page="accounts">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                Accounts
            </div>
            <div class="nav-item" data-page="settings">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Print Settings
            </div>
            <!-- Account Selector -->
            <div class="account-selector" style="margin-top:auto;">
                <div class="account-selector-label">Account</div>
                <select class="account-dropdown" id="currentAccount">
                    <option value="">Select...</option>
                </select>
            </div>

            <!-- User Profile & Plan (Matches Image 1) -->
            <div style="padding:16px;border-top:1px solid var(--border);">
                <!-- Plan Row -->
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <span id="planBadge"
                        style="background:var(--text-secondary);padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;color:#fff;">Free</span>
                    <button id="upgradeBtn" onclick="showPricingModal()"
                        style="background:none;border:none;padding:0;font-size:12px;color:var(--text-primary);text-decoration:underline;cursor:pointer;font-weight:500;">Upgrade</button>
                </div>

                <!-- User Display -->
                <div id="userDisplay" style="display:flex;flex-direction:column;gap:8px;">
                    <button class="btn btn-primary" style="padding:4px 8px;font-size:11px;"
                        onclick="showLoginModal()">Sign In</button>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <!-- Write Check -->
            <div class="page active" id="page-write">
                <!-- Company Stats Banner -->

                <div class="page-header">
                    <div>
                        <h1 class="page-title">Write a Check</h1>
                        <p class="page-subtitle">Enter all details needed for the check to clear</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="clearCheck()">Clear</button>
                        <button class="btn btn-secondary" onclick="saveCheckDraft()">Save Draft</button>
                        <button class="btn btn-primary" onclick="saveCheckAndNext()" style="background:#43a047;">‚úì Save
                            & Next</button>
                        <button class="btn btn-primary" onclick="saveAndPrint()" style="background:#1565c0;">üíæ Save &
                            Print</button>
                        <button class="btn btn-primary" onclick="printCheck()">üñ®Ô∏è Print Only</button>
                    </div>
                </div>

                <div class="check-preview-container">
                    <div class="check" id="checkPreview">
                        <div class="check-header">
                            <div class="check-issuer">
                                <div class="check-issuer-name" id="previewIssuerName">Your Name</div>
                                <div id="previewIssuerAddress">123 Main Street</div>
                                <div id="previewIssuerCity">City, ST 12345</div>
                            </div>
                            <div class="check-bank">
                                <div class="check-bank-name" id="previewBankName">Bank Name</div>
                                <div class="check-bank-code" id="previewBankCode"></div>
                            </div>
                            <div class="check-number-date">
                                <div class="check-number">No. <span id="previewCheckNo">1001</span></div>
                                <div class="check-date-row">Date <span class="check-date-value" id="previewDate"></span>
                                </div>
                            </div>
                        </div>
                        <div class="check-payee">
                            <div class="check-payee-label">Pay To The<br>Order Of</div>
                            <div style="flex:1;">
                                <div class="check-payee-line" id="previewPayee"></div>
                                <div id="previewPayeeAddress"
                                    style="font-size:9px;color:#555;padding-left:6px;min-height:12px;line-height:1.2;">
                                </div>
                            </div>
                            <div class="check-amount-box" id="previewAmount">0.00</div>
                        </div>
                        <div class="check-written-amount">
                            <div class="check-written-line" id="previewWrittenAmount"></div>
                            <div class="check-dollars-label">Dollars</div>
                        </div>
                        <div class="check-memo-signature">
                            <div class="check-memo">
                                <div class="check-memo-label">Memo</div>
                                <div class="check-memo-line" id="previewMemo"></div>
                            </div>
                            <div class="check-signature">
                                <div class="check-signature-line">
                                    <img id="previewSignature" class="check-signature-img" src="" alt=""
                                        style="display:none;">
                                </div>
                            </div>
                        </div>
                        <div class="check-micr" id="previewMicr">‚ëà00001001‚ëà ‚ëÜ021000021‚ëÜ 000000000‚ëà</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Check Details</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Check Number <span class="required">*</span></label>
                            <input type="text" class="form-input mono" id="checkNumber" placeholder="1001"
                                inputmode="numeric" pattern="[0-9]*">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date <span class="required">*</span></label>
                            <input type="date" class="form-input" id="checkDate">
                        </div>
                        <div class="form-group" style="position:relative;">
                            <label class="form-label">Pay To <span class="required">*</span></label>
                            <input type="text" class="form-input" id="payTo" placeholder="Recipient name"
                                autocomplete="off" oninput="showPayeeSuggestions(this.value)"
                                onfocus="showPayeeSuggestions(this.value)">
                            <div id="payeeSuggestions"
                                style="display:none;position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;border-radius:4px;max-height:200px;overflow-y:auto;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,0.15);">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payee Address</label>
                            <input type="text" class="form-input" id="payeeAddress"
                                placeholder="Street address (optional)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payee City</label>
                            <input type="text" class="form-input" id="payeeCity" placeholder="City">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payee State</label>
                            <input type="text" class="form-input" id="payeeState" placeholder="ST" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payee ZIP</label>
                            <input type="text" class="form-input" id="payeeZip" placeholder="12345">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount ($) <span class="required">*</span></label>
                            <input type="number" class="form-input mono" id="amount" placeholder="0.00" step="0.01"
                                min="0" inputmode="decimal">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Memo</label>
                            <input type="text" class="form-input" id="memo" placeholder="Optional note">
                        </div>
                    </div>

                    <div class="section-divider">
                        <div class="section-label"
                            style="display:flex;justify-content:space-between;align-items:center;">
                            <span>üè¶ Bank & Routing (Required for Clearing)</span>
                            <a href="#" onclick="event.preventDefault();navigateTo('accounts');"
                                style="font-size:11px;color:var(--accent);text-decoration:none;">Edit in Accounts ‚Üí</a>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Bank Name</label>
                            <input type="text" class="form-input" id="bankName" placeholder="e.g., Chase" readonly
                                style="background:var(--bg-secondary);cursor:not-allowed;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Routing Number <span class="required">*</span></label>
                            <input type="text" class="form-input mono" id="routingNumber" maxlength="9"
                                placeholder="9 digits" readonly
                                style="background:var(--bg-secondary);cursor:not-allowed;">
                            <span class="form-hint" id="routingHint">9-digit ABA routing number</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Account Number <span class="required">*</span></label>
                            <input type="text" class="form-input mono" id="accountNumber" placeholder="Account number"
                                readonly style="background:var(--bg-secondary);cursor:not-allowed;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Transit/Fraction Code</label>
                            <input type="text" class="form-input" id="transitCode" placeholder="e.g., 1-2/210" readonly
                                style="background:var(--bg-secondary);cursor:not-allowed;">
                        </div>
                    </div>

                    <div class="section-divider">
                        <div class="section-label"
                            style="display:flex;justify-content:space-between;align-items:center;">
                            <span>üìã Issuer Information</span>
                            <a href="#" onclick="event.preventDefault();navigateTo('accounts');"
                                style="font-size:11px;color:var(--accent);text-decoration:none;">Edit in Accounts ‚Üí</a>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Issuer Name <span class="required">*</span></label>
                            <input type="text" class="form-input" id="issuerName" placeholder="Your name or business"
                                readonly style="background:var(--bg-secondary);cursor:not-allowed;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <input type="text" class="form-input" id="issuerAddress" placeholder="Street address"
                                readonly style="background:var(--bg-secondary);cursor:not-allowed;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">City</label>
                            <input type="text" class="form-input" id="issuerCity" placeholder="City" readonly
                                style="background:var(--bg-secondary);cursor:not-allowed;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">State</label>
                            <input type="text" class="form-input" id="issuerState" placeholder="ST" maxlength="2"
                                readonly style="background:var(--bg-secondary);cursor:not-allowed;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ZIP</label>
                            <input type="text" class="form-input" id="issuerZip" placeholder="12345" readonly
                                style="background:var(--bg-secondary);cursor:not-allowed;">
                        </div>
                    </div>

                    <div class="section-divider">
                        <div class="section-label">‚úçÔ∏è Signature</div>
                    </div>
                    <div style="padding:16px;background:var(--bg-secondary);border-radius:8px;">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <input type="checkbox" id="includeSignature" checked onchange="updatePreview()"
                                style="width:18px;height:18px;cursor:pointer;">
                            <label for="includeSignature" style="cursor:pointer;margin:0;font-size:14px;">
                                Include signature on this check
                            </label>
                        </div>
                        <div id="signatureStatus"
                            style="margin-top:12px;padding:10px;background:var(--bg);border-radius:6px;font-size:12px;color:var(--text-secondary);">
                            <span id="sigStatusIcon">‚ÑπÔ∏è</span>
                            <span id="sigStatusText">Select an account to load signature</span>
                        </div>
                        <div style="margin-top:8px;font-size:11px;color:var(--text-muted);">
                            üí° Manage signatures in <a href="#" onclick="event.preventDefault();navigateTo('accounts');"
                                style="color:var(--accent);text-decoration:none;">Accounts ‚Üí</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History -->
            <div class="page" id="page-history">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Check History</h1>
                        <p class="page-subtitle">View and manage saved checks</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="printSelected()" style="margin-right:8px;">üñ®Ô∏è Print
                            Selected</button>
                        <button class="btn btn-secondary" onclick="openExportModal('excel')"
                            style="margin-right:8px;">üìä Export Excel</button>
                        <button class="btn btn-secondary" onclick="openExportModal('pdf')" style="margin-right:8px;">üìÑ
                            Export PDF</button>
                        <button class="btn btn-danger" onclick="deleteSelected()">Delete Selected</button>
                    </div>
                </div>
                <!-- Filter Bar -->
                <div class="card" style="margin-bottom:16px;padding:12px 16px;">
                    <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;">
                        <div style="flex:1;min-width:140px;">
                            <label style="font-size:11px;color:#666;display:block;margin-bottom:2px;">Account</label>
                            <select id="filterAccount" onchange="renderChecks()"
                                style="width:100%;padding:6px 8px;border:1px solid #ddd;border-radius:4px;">
                                <option value="">All Accounts</option>
                            </select>
                        </div>
                        <div style="flex:1;min-width:140px;">
                            <label style="font-size:11px;color:#666;display:block;margin-bottom:2px;">Payee</label>
                            <select id="filterPayeeSelect" onchange="renderChecks()"
                                style="width:100%;padding:6px 8px;border:1px solid #ddd;border-radius:4px;">
                                <option value="">All Payees</option>
                            </select>
                        </div>
                        <div style="flex:1;min-width:100px;">
                            <label style="font-size:11px;color:#666;display:block;margin-bottom:2px;">Status</label>
                            <select id="filterStatus" onchange="renderChecks()"
                                style="width:100%;padding:6px 8px;border:1px solid #ddd;border-radius:4px;">
                                <option value="">All Status</option>
                                <option value="draft">Draft</option>
                                <option value="saved">Saved</option>
                                <option value="printed">Printed</option>
                                <option value="cleared">Cleared</option>
                                <option value="voided">Voided</option>
                            </select>
                        </div>
                        <div style="flex:1;min-width:110px;">
                            <label style="font-size:11px;color:#666;display:block;margin-bottom:2px;">From Date</label>
                            <input type="date" id="filterDateFrom" onchange="renderChecks()"
                                style="width:100%;padding:6px 8px;border:1px solid #ddd;border-radius:4px;">
                        </div>
                        <div style="flex:1;min-width:110px;">
                            <label style="font-size:11px;color:#666;display:block;margin-bottom:2px;">To Date</label>
                            <input type="date" id="filterDateTo" onchange="renderChecks()"
                                style="width:100%;padding:6px 8px;border:1px solid #ddd;border-radius:4px;">
                        </div>
                        <div style="flex:1;min-width:90px;">
                            <label style="font-size:11px;color:#666;display:block;margin-bottom:2px;">Min Amount</label>
                            <input type="number" id="filterAmountMin" oninput="renderChecks()" placeholder="$0"
                                step="0.01" style="width:100%;padding:6px 8px;border:1px solid #ddd;border-radius:4px;">
                        </div>
                        <div style="flex:1;min-width:90px;">
                            <label style="font-size:11px;color:#666;display:block;margin-bottom:2px;">Max Amount</label>
                            <input type="number" id="filterAmountMax" oninput="renderChecks()" placeholder="‚àû"
                                step="0.01" style="width:100%;padding:6px 8px;border:1px solid #ddd;border-radius:4px;">
                        </div>
                        <div style="flex:1;min-width:90px;">
                            <label style="font-size:11px;color:#666;display:block;margin-bottom:2px;">Check #</label>
                            <input type="text" id="filterCheckNo" oninput="renderChecks()" placeholder="1001"
                                style="width:100%;padding:6px 8px;border:1px solid #ddd;border-radius:4px;">
                        </div>
                        <div style="flex:2;min-width:150px;">
                            <label style="font-size:11px;color:#666;display:block;margin-bottom:2px;">Search</label>
                            <input type="text" id="filterPayee" oninput="renderChecks()" placeholder="Payee, memo..."
                                style="width:100%;padding:6px 8px;border:1px solid #ddd;border-radius:4px;">
                        </div>
                        <div>
                            <button class="btn btn-secondary" onclick="clearFilters()"
                                style="padding:6px 12px;">Clear</button>
                        </div>
                    </div>
                </div>

                <!-- Summary Stats -->
                <div id="historySummary" class="card" style="margin-bottom:16px;padding:12px 16px;display:none;">
                    <div style="display:flex;flex-wrap:wrap;gap:20px;align-items:center;">
                        <div>
                            <span style="font-size:11px;color:#666;">Showing</span>
                            <span id="summaryCount" style="font-weight:600;margin:0 4px;">0</span>
                            <span style="font-size:11px;color:#666;">checks</span>
                        </div>
                        <div style="border-left:1px solid #ddd;padding-left:20px;">
                            <span style="font-size:11px;color:#666;">Total Amount</span>
                            <span id="summaryTotal"
                                style="font-weight:600;color:var(--accent);margin-left:4px;">$0.00</span>
                        </div>
                        <div style="border-left:1px solid #ddd;padding-left:20px;">
                            <span style="font-size:11px;color:#666;">Cleared</span>
                            <span id="summaryCleared"
                                style="font-weight:600;color:#16a34a;margin-left:4px;">$0.00</span>
                        </div>
                        <div style="border-left:1px solid #ddd;padding-left:20px;">
                            <span style="font-size:11px;color:#666;">Pending</span>
                            <span id="summaryPending"
                                style="font-weight:600;color:#d97706;margin-left:4px;">$0.00</span>
                        </div>
                        <div style="margin-left:auto;">
                            <button class="btn btn-secondary"
                                onclick="openPayeeProfile(document.getElementById('filterPayeeSelect').value)"
                                style="font-size:11px;padding:4px 10px;" id="viewPayeeProfileBtn" disabled>
                                View Payee Profile
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                <th>Check #</th>
                                <th>Date</th>
                                <th>Payee</th>
                                <th>Amount</th>
                                <th>Account</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="checksTable"></tbody>
                    </table>
                    <div class="empty-state" id="emptyState" style="display:none;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <h3>No checks yet</h3>
                        <p>Write your first check to get started</p>
                    </div>
                </div>
            </div>

            <!-- Import/Export -->
            <div class="page" id="page-import-export">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Import / Export</h1>
                        <p class="page-subtitle">Transfer data to other systems</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Import</div>
                    <div class="ie-section">
                        <label class="ie-card" for="importEz">
                            <div class="ie-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg></div>
                            <div class="ie-title">ezCheckPrinting CSV</div>
                            <div class="ie-desc">Import from ezCheckPrinting</div>
                            <input type="file" class="file-input" id="importEz" accept=".csv"
                                onchange="importEz(event)">
                        </label>
                        <label class="ie-card" for="importQB">
                            <div class="ie-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                </svg></div>
                            <div class="ie-title">QuickBooks</div>
                            <div class="ie-desc">Import from QuickBooks</div>
                            <input type="file" class="file-input" id="importQB" accept=".csv,.iif"
                                onchange="importQB(event)">
                        </label>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Export</div>
                    <div class="ie-section">
                        <div class="ie-card" onclick="exportCSV()">
                            <div class="ie-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg></div>
                            <div class="ie-title">Export CSV</div>
                            <div class="ie-desc">Standard format</div>
                        </div>
                        <div class="ie-card" onclick="exportEz()">
                            <div class="ie-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg></div>
                            <div class="ie-title">ezCheckPrinting Format</div>
                            <div class="ie-desc">Compatible export</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accounts -->
            <div class="page" id="page-accounts">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Saved Accounts</h1>
                        <p class="page-subtitle">Quick-fill account details</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="showAccountModal()">+ New Account</button>
                    </div>
                </div>
                <div id="accountsList"></div>
            </div>

            <!-- Print Settings / Calibration -->
            <div class="page" id="page-settings">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Print Settings & Calibration</h1>
                        <p class="page-subtitle">Align checks to your check stock</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:18px;height:18px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                        </svg>
                        Print Calibration Offsets
                    </div>
                    <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">
                        Adjust these values to align your checks with pre-printed check stock.
                        Use the "Print Alignment Test" to measure the offset needed.
                    </p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Horizontal Offset (X)</label>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <input type="number" class="form-input" id="calibOffsetX" value="0" step="0.01"
                                    style="width:100px;">
                                <span style="color:var(--text-secondary);font-size:12px;">inches</span>
                            </div>
                            <span class="form-hint">Positive = shift right, Negative = shift left</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Vertical Offset (Y)</label>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <input type="number" class="form-input" id="calibOffsetY" value="0" step="0.01"
                                    style="width:100px;">
                                <span style="color:var(--text-secondary);font-size:12px;">inches</span>
                            </div>
                            <span class="form-hint">Positive = shift down, Negative = shift up</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Scale</label>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <input type="number" class="form-input" id="calibScale" value="1.000" step="0.001"
                                    min="0.9" max="1.1" style="width:100px;">
                            </div>
                            <span class="form-hint">1.000 = 100%, adjust if check is too big/small</span>
                        </div>
                    </div>
                    <div style="margin-top:16px;display:flex;gap:10px;">
                        <button class="btn btn-primary" onclick="saveCalibration()">Save Calibration</button>
                        <button class="btn btn-secondary" onclick="resetCalibration()">Reset to Default</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:18px;height:18px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2" />
                        </svg>
                        Alignment Test Print
                    </div>
                    <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">
                        Print this test page on your check stock. Measure the offset from the crosshairs to the
                        actual check boundaries to determine your calibration values.
                    </p>
                    <button class="btn btn-secondary" onclick="printAlignmentTest()">üñ®Ô∏è Print Alignment Test</button>
                </div>

                <div class="card">
                    <div class="card-title">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:18px;height:18px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Print Settings Checklist
                    </div>
                    <p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px;">
                        Before printing checks, ensure your browser print settings are correct:
                    </p>
                    <ul style="color:var(--text-primary);font-size:13px;margin-left:20px;line-height:1.8;">
                        <li><strong>Scale:</strong> 100% or "Actual Size" (NOT fit to page)</li>
                        <li><strong>Margins:</strong> None or Minimum</li>
                        <li><strong>Headers/Footers:</strong> OFF</li>
                        <li><strong>Orientation:</strong> Portrait</li>
                        <li><strong>Paper Size:</strong> Letter (8.5" x 11")</li>
                    </ul>
                </div>

                <div class="card">
                    <div class="card-title">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:18px;height:18px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Check Stock Info
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Check Position</label>
                            <select class="form-select" id="checkPosition">
                                <option value="top" selected>Top (Check on top, 2 stubs below)</option>
                                <option value="middle">Middle (Stub, Check, Stub)</option>
                                <option value="bottom">Bottom (2 stubs, Check on bottom)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Check Height</label>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <input type="number" class="form-input" id="checkHeight" value="3.5" step="0.01"
                                    style="width:100px;">
                                <span style="color:var(--text-secondary);font-size:12px;">inches</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MICR Font Configuration -->
                <div class="card">
                    <div class="card-title">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:18px;height:18px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        MICR Font Configuration
                    </div>
                    <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">
                        To display real MICR symbols (‚ëà ‚ëÜ) instead of letters (C A), you need to load a MICR E-13B font.
                    </p>

                    <!-- Status Display -->
                    <div
                        style="background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:16px;font-family:monospace;font-size:12px;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                            <span>MICR Font Loaded:</span>
                            <span id="micrStatusLoaded" style="color:#e53935;">‚ùå No</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                            <span>Font Data Size:</span>
                            <span id="micrStatusSize">0 bytes</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span>Active Font:</span>
                            <span id="micrStatusFont">Courier (fallback)</span>
                        </div>
                    </div>

                    <!-- Font Upload -->
                    <div class="form-group">
                        <label class="form-label">Load MICR Font (TTF file)</label>
                        <input type="file" class="form-input" id="micrFontFile" accept=".ttf,.TTF" style="padding:8px;">
                        <span class="form-hint">Recommended: GnuMICR.ttf or MICR_Encoding.ttf (free fonts)</span>
                    </div>

                    <div style="display:flex;gap:10px;margin-top:12px;">
                        <button class="btn btn-secondary" onclick="printMICRTest()">üî¨ MICR Test PDF</button>
                        <button class="btn btn-secondary" onclick="updateMICRStatus()">üîÑ Refresh Status</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Login Modal -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <h2 class="modal-title">Sign In to CheckFlow</h2>
            </div>
            <p style="color:var(--text-secondary);font-size:13px;margin-bottom:20px;">
                Sign in to sync your accounts and checks across devices.
            </p>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="loginEmail" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" id="loginPassword" placeholder="Password"
                    onkeypress="if(event.key==='Enter')signInWithEmail()">
            </div>
            <button class="btn btn-primary" style="width:100%;margin-bottom:12px;" onclick="signInWithEmail()">
                Sign In / Create Account
            </button>
            <button class="btn btn-secondary"
                style="width:100%;margin-bottom:16px;display:flex;align-items:center;justify-content:center;gap:8px;"
                onclick="signInWithGoogle()">
                <svg width="18" height="18" viewBox="0 0 24 24">
                    <path fill="#4285F4"
                        d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                    <path fill="#34A853"
                        d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                    <path fill="#FBBC05"
                        d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                    <path fill="#EA4335"
                        d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                </svg>
                Sign in with Google
            </button>
            <div style="text-align:center;border-top:1px solid var(--border);padding-top:16px;">
                <button class="btn" style="color:var(--text-secondary);" onclick="continueAsGuest()">
                    Continue without signing in
                </button>
                <p style="font-size:11px;color:var(--text-muted);margin-top:8px;">Data will be stored locally only</p>
            </div>
        </div>
    </div>

    <!-- Account Modal -->
    <div class="modal-overlay" id="accountModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">New Account</h2>
                <button class="modal-close" onclick="closeAccountModal()">‚úï</button>
            </div>
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="form-label">Account Nickname <span class="required">*</span></label>
                    <input type="text" class="form-input" id="modalNickname" placeholder="e.g., Business Checking">
                </div>
                <div class="form-group">
                    <label class="form-label">Bank Name <span class="required">*</span></label>
                    <input type="text" class="form-input" id="modalBankName" placeholder="e.g., Chase">
                </div>
                <div class="form-group">
                    <label class="form-label">Transit Code</label>
                    <input type="text" class="form-input" id="modalTransit" placeholder="e.g., 1-2/210">
                </div>
                <div class="form-group">
                    <label class="form-label">Routing Number <span class="required">*</span></label>
                    <input type="text" class="form-input mono" id="modalRouting" maxlength="9" placeholder="9 digits">
                </div>
                <div class="form-group">
                    <label class="form-label">Account Number <span class="required">*</span></label>
                    <input type="text" class="form-input mono" id="modalAccount" placeholder="Account number">
                </div>
                <div class="form-group">
                    <label class="form-label">Starting Check #</label>
                    <input type="number" class="form-input" id="modalCheckNo" value="1001">
                </div>
                <div class="form-group" style="display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" id="modalIsDefault" style="width:18px;height:18px;">
                    <label for="modalIsDefault" class="form-label" style="margin:0;cursor:pointer;">Set as Default
                        Account</label>
                </div>
                <div class="form-group full-width"
                    style="border-top:1px solid var(--border);padding-top:14px;margin-top:6px;">
                    <label class="form-label">Issuer Name <span class="required">*</span></label>
                    <input type="text" class="form-input" id="modalName" placeholder="Name to appear on checks">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Address</label>
                    <input type="text" class="form-input" id="modalAddr" placeholder="Street address">
                </div>
                <div class="form-group">
                    <label class="form-label">City</label>
                    <input type="text" class="form-input" id="modalCity" placeholder="City">
                </div>
                <div class="form-group">
                    <label class="form-label">State</label>
                    <input type="text" class="form-input" id="modalState" maxlength="2" placeholder="ST">
                </div>
                <div class="form-group">
                    <label class="form-label">ZIP</label>
                    <input type="text" class="form-input" id="modalZip" placeholder="12345">
                </div>
                <div class="form-group full-width"
                    style="border-top:1px solid var(--border);padding-top:14px;margin-top:6px;">
                    <label class="form-label">Account Signature</label>
                    <div style="margin-bottom:8px;">
                        <button type="button" class="signature-tab" id="accountSigDrawTab"
                            onclick="switchAccountSigMode('draw')"
                            style="padding:6px 12px;background:var(--accent);color:white;border:none;border-radius:4px 0 0 4px;cursor:pointer;">Draw</button>
                        <button type="button" class="signature-tab" id="accountSigUploadTab"
                            onclick="switchAccountSigMode('upload')"
                            style="padding:6px 12px;background:var(--bg-secondary);color:var(--text-secondary);border:none;border-radius:0 4px 4px 0;cursor:pointer;">Upload</button>
                    </div>

                    <!-- Draw Mode -->
                    <div id="accountSigDrawMode">
                        <div
                            style="border:1px solid var(--border);border-radius:6px;background:white;margin-bottom:8px;">
                            <canvas id="accountSignatureCanvas" width="380" height="100"
                                style="display:block;width:100%;"></canvas>
                        </div>
                        <div style="display:flex;gap:8px;">
                            <button type="button" class="btn btn-secondary" onclick="clearAccountSignatureCanvas()"
                                style="flex:1;font-size:11px;padding:6px;">Clear</button>
                            <button type="button" class="btn btn-primary" onclick="applyAccountSignature()"
                                style="flex:1;font-size:11px;padding:6px;">Apply</button>
                        </div>
                    </div>

                    <!-- Upload Mode -->
                    <div id="accountSigUploadMode" style="display:none;">
                        <div style="display:flex;gap:8px;align-items:center;">
                            <div id="modalSigPreview"
                                style="flex:1;height:60px;border:1px dashed var(--border);border-radius:6px;display:flex;align-items:center;justify-content:center;background:var(--bg-secondary);overflow:hidden;">
                                <span id="modalSigPlaceholder" style="color:var(--text-muted);font-size:12px;">No
                                    signature</span>
                                <img id="modalSigImg" style="max-height:55px;max-width:100%;display:none;">
                            </div>
                            <div style="display:flex;flex-direction:column;gap:4px;">
                                <button type="button" class="btn btn-secondary"
                                    onclick="document.getElementById('modalSigInput').click()"
                                    style="font-size:11px;padding:6px 10px;">Upload</button>
                                <button type="button" class="btn btn-secondary" onclick="clearAccountSignature()"
                                    style="font-size:11px;padding:6px 10px;">Clear</button>
                            </div>
                        </div>
                    </div>

                    <input type="file" id="modalSigInput" accept="image/*" style="display:none;"
                        onchange="handleAccountSigUpload(event)">
                    <input type="hidden" id="modalSignature">
                    <div style="margin-top:6px;font-size:11px;color:var(--text-muted);">
                        üí° This signature will be used for all checks from this account
                    </div>
                </div>
            </div>
            <input type="hidden" id="editingId">
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeAccountModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveAccountModal()">Save</button>
            </div>
        </div>
    </div>

    <!-- Payee Profile Modal -->
    <div class="modal-overlay" id="payeeProfileModal">
        <div class="modal" style="max-width:800px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;">
            <div class="modal-header">
                <h2 class="modal-title" id="payeeProfileTitle">Payee Profile</h2>
                <button class="modal-close" onclick="closePayeeProfileModal()">‚úï</button>
            </div>
            <div style="flex:1;overflow-y:auto;padding:0 20px 20px;">
                <!-- Payee Info Card -->
                <div class="card" style="margin-bottom:16px;padding:16px;background:var(--bg-secondary);">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                        <div>
                            <h3 id="payeeProfileName" style="margin:0 0 8px 0;font-size:18px;"></h3>
                            <div id="payeeProfileAddress" style="font-size:13px;color:var(--text-secondary);"></div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:11px;color:var(--text-muted);">Total Paid (All Time)</div>
                            <div id="payeeProfileTotalAll" style="font-size:24px;font-weight:700;color:var(--accent);">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Row -->
                <div style="display:flex;gap:12px;margin-bottom:16px;">
                    <div class="card" style="flex:1;padding:12px;text-align:center;">
                        <div style="font-size:11px;color:var(--text-muted);">Checks Written</div>
                        <div id="payeeProfileCheckCount" style="font-size:20px;font-weight:600;"></div>
                    </div>
                    <div class="card" style="flex:1;padding:12px;text-align:center;">
                        <div style="font-size:11px;color:var(--text-muted);">Average Amount</div>
                        <div id="payeeProfileAvg" style="font-size:20px;font-weight:600;"></div>
                    </div>
                    <div class="card" style="flex:1;padding:12px;text-align:center;">
                        <div style="font-size:11px;color:var(--text-muted);">First Check</div>
                        <div id="payeeProfileFirstDate" style="font-size:14px;font-weight:500;"></div>
                    </div>
                    <div class="card" style="flex:1;padding:12px;text-align:center;">
                        <div style="font-size:11px;color:var(--text-muted);">Last Check</div>
                        <div id="payeeProfileLastDate" style="font-size:14px;font-weight:500;"></div>
                    </div>
                </div>

                <!-- Date Range Filter -->
                <div style="display:flex;gap:12px;margin-bottom:12px;align-items:center;">
                    <span style="font-size:12px;color:var(--text-secondary);">Date Range:</span>
                    <input type="date" id="payeeProfileDateFrom" onchange="updatePayeeProfile()"
                        style="padding:4px 8px;border:1px solid var(--border);border-radius:4px;">
                    <span style="color:var(--text-muted);">to</span>
                    <input type="date" id="payeeProfileDateTo" onchange="updatePayeeProfile()"
                        style="padding:4px 8px;border:1px solid var(--border);border-radius:4px;">
                    <span id="payeeProfileRangeTotal"
                        style="margin-left:auto;font-weight:600;color:var(--accent);"></span>
                </div>

                <!-- Check History Table -->
                <div class="card" style="padding:0;">
                    <table style="margin:0;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Check #</th>
                                <th>Amount</th>
                                <th>Memo</th>
                                <th>Account</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="payeeProfileChecks"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-actions" style="border-top:1px solid var(--border);padding:12px 20px;">
                <button class="btn btn-secondary" onclick="editPayeeInfo()">Edit Payee Info</button>
                <button class="btn btn-secondary" onclick="exportPayeeHistory()">Export History</button>
                <button class="btn btn-primary" onclick="writeCheckToPayee()">Write Check</button>
            </div>
        </div>
    </div>

    <!-- Pricing Modal -->
    <div class="modal-overlay" id="pricingModal">
        <div class="modal pricing-modal">
            <button class="modal-close" onclick="closePricingModal()">‚úï</button>

            <!-- View 1: Upgrade Options -->
            <div id="pricingUpgradeView">
                <div class="pricing-header">
                    <h2>Upgrade to Save & Sync</h2>
                    <p>Print checks free. Upgrade when you need history, bank accounts, and more.</p>
                </div>

                <div class="pricing-grid">
                    <!-- Free Plan -->
                    <div class="pricing-card">
                        <h3>Free</h3>
                        <div class="price">$0<span>/forever</span></div>
                        <p class="trial" style="color:var(--text-secondary);">No signup required</p>
                        <ul class="pricing-features">
                            <li style="color:var(--success);">‚úì Create & print checks</li>
                            <li style="color:var(--success);">‚úì MICR encoding</li>
                            <li style="color:var(--success);">‚úì Signature drawing</li>
                            <li style="color:var(--text-muted);">‚úï No saved history</li>
                            <li style="color:var(--text-muted);">‚úï No bank accounts</li>
                            <li style="color:var(--text-muted);">‚úï No cloud sync</li>
                        </ul>
                        <button class="btn btn-secondary" onclick="closePricingModal()"
                            style="width:100%;margin-top:auto;">Continue Free</button>
                    </div>

                    <!-- Pro - Per Account -->
                    <div class="pricing-card">
                        <h3>Pro ‚Äì Per Account</h3>
                        <div class="price">$1<span>/account/mo</span></div>
                        <p class="trial">‚ú® 60-day free trial</p>
                        <ul class="pricing-features">
                            <li style="color:var(--success);">‚úì Everything in Free</li>
                            <li style="color:var(--success);">‚úì Save checks & history</li>
                            <li style="color:var(--success);">‚úì Saved payee directory</li>
                            <li style="color:var(--success);">‚úì Export & audit trail</li>
                            <li style="color:var(--success);">‚úì Cloud sync across devices</li>
                            <li style="color:var(--success);">‚úì Pay only for what you use</li>
                        </ul>
                        <button class="btn btn-primary" onclick="startCheckout('per_account')"
                            style="width:100%;margin-top:auto;">Start Free Trial</button>
                    </div>

                    <!-- Pro - Unlimited -->
                    <div class="pricing-card recommended" style="border:2px solid var(--accent);">
                        <div class="pricing-badge">RECOMMENDED</div>
                        <h3>Pro ‚Äì Unlimited</h3>
                        <div class="price">$5<span>/month</span></div>
                        <p class="trial">‚ú® 60-day free trial</p>
                        <ul class="pricing-features">
                            <li style="color:var(--success);">‚úì Everything in Pro</li>
                            <li style="color:var(--success);">‚úì Unlimited bank accounts</li>
                            <li style="color:var(--success);">‚úì Unlimited checks</li>
                            <li style="color:var(--success);">‚úì Priority support</li>
                            <li style="color:var(--success);">‚úì Best for businesses</li>
                            <li style="color:var(--success);">‚úì One simple price</li>
                        </ul>
                        <button class="btn btn-primary" onclick="startCheckout('unlimited')"
                            style="width:100%;margin-top:auto;">Start Free Trial</button>
                    </div>
                </div>

                <p style="text-align:center;margin-top:20px;font-size:13px;color:var(--text-secondary);">
                    üîí No bank access. We don't move money. We only help you print checks.<br>
                    Cancel anytime during your trial. No charge until trial ends.
                </p>
            </div>

            <!-- View 2: Subscription Management -->
            <div id="pricingSubscriptionView" style="display:none;">
                <div class="pricing-header">
                    <h2>Your Subscription</h2>
                    <p>Manage your current plan and billing</p>
                </div>

                <div style="background:var(--bg-secondary);padding:24px;border-radius:12px;margin-bottom:24px;">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;">
                        <div>
                            <h3 id="subPlanName" style="font-size:20px;margin-bottom:4px;">Pro Plan</h3>
                            <div id="subPrice" style="font-size:14px;color:var(--text-secondary);">$5.00/month</div>
                        </div>
                        <div id="subStatus"
                            style="font-weight:600;padding:6px 12px;background:#dcfce7;color:#166534;border-radius:20px;font-size:14px;">
                            Active
                        </div>
                    </div>

                    <div
                        style="display:grid;grid-template-columns:1fr 1fr;gap:20px;border-top:1px solid var(--border);padding-top:20px;">
                        <div>
                            <div class="label"
                                style="font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:4px;"
                                id="subDateLabel">Next Billing</div>
                            <div id="subDate" style="font-size:15px;font-weight:500;">-</div>
                        </div>
                        <div>
                            <div class="label"
                                style="font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:4px;">
                                Member Since</div>
                            <div id="subMemberSince" style="font-size:15px;font-weight:500;">-</div>
                        </div>
                    </div>
                </div>

                <div class="modal-actions" style="justify-content:space-between;">
                    <button class="btn btn-secondary" onclick="openBillingPortal()"
                        style="display:flex;align-items:center;gap:8px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                        Manage Billing (Stripe)
                    </button>
                    <button id="cancelSubBtn" class="btn btn-secondary"
                        style="color:var(--danger);border-color:var(--danger);" onclick="cancelSubscription()">
                        Cancel Subscription
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payee Directory Modal -->
    <div class="modal-overlay" id="payeeDirectoryModal">
        <div class="modal" style="max-width:700px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;">
            <div class="modal-header">
                <h2 class="modal-title">Payee Directory</h2>
                <button class="modal-close" onclick="closePayeeDirectoryModal()">‚úï</button>
            </div>
            <div style="padding:0 20px;">
                <input type="text" id="payeeDirectorySearch" placeholder="Search payees..."
                    oninput="renderPayeeDirectory()"
                    style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:6px;margin-bottom:12px;">
            </div>
            <div style="flex:1;overflow-y:auto;padding:0 20px 20px;" id="payeeDirectoryList">
            </div>
            <div class="modal-actions" style="border-top:1px solid var(--border);padding:12px 20px;">
                <button class="btn btn-secondary" onclick="closePayeeDirectoryModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Export Options Modal -->
    <div class="modal-overlay" id="exportOptionsModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <h2 class="modal-title" id="exportModalTitle">Export to Excel</h2>
                <button class="modal-close" onclick="closeExportModal()">‚úï</button>
            </div>
            <div style="padding:20px;">
                <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">
                    Choose what data to include in your export:
                </p>

                <div class="form-group">
                    <label class="form-label">Account</label>
                    <select id="exportAccount" class="form-input">
                        <option value="">All Accounts</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Payee</label>
                    <select id="exportPayee" class="form-input">
                        <option value="">All Payees</option>
                    </select>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">From Date</label>
                        <input type="date" id="exportDateFrom" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">To Date</label>
                        <input type="date" id="exportDateTo" class="form-input">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select id="exportStatus" class="form-input">
                        <option value="">All Status</option>
                        <option value="draft">Draft</option>
                        <option value="saved">Saved</option>
                        <option value="printed">Printed</option>
                        <option value="cleared">Cleared</option>
                        <option value="voided">Voided</option>
                    </select>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Min Amount</label>
                        <input type="number" id="exportAmountMin" class="form-input" placeholder="$0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Amount</label>
                        <input type="number" id="exportAmountMax" class="form-input" placeholder="No limit" step="0.01">
                    </div>
                </div>

                <div class="form-group"
                    style="background:var(--bg-secondary);padding:12px;border-radius:6px;margin-top:16px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-size:13px;color:var(--text-secondary);">Matching checks:</span>
                        <span id="exportPreviewCount" style="font-weight:600;color:var(--accent);">0</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
                        <span style="font-size:13px;color:var(--text-secondary);">Total amount:</span>
                        <span id="exportPreviewTotal" style="font-weight:600;color:var(--accent);">$0.00</span>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeExportModal()">Cancel</button>
                <button class="btn btn-primary" id="exportConfirmBtn" onclick="confirmExport()">Export</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"><span id="toastMsg"></span></div>

    <!-- Print Area (hidden, used for printing) -->
    <div id="printArea"></div>

    <script>
        // Firebase Configuration
        // Note: These keys are for client-side app identification and are safe to be public.
        // Data security is handled by Firebase Security Rules.
        const firebaseConfig = {
            apiKey: "AIzaSyDXbIIyHz9zFpy_AVlzGvbSSR6tcrtOqkE",
            authDomain: "swiftcheckprint.firebaseapp.com",
            projectId: "swiftcheckprint",
            storageBucket: "swiftcheckprint.firebasestorage.app",
            messagingSenderId: "137967566098",
            appId: "1:137967566098:web:252734401ed0eb6c67c7cb",
            measurementId: "G-E4RTNE5HCG"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Analytics helper function - uses gtag (GA4)
        function trackEvent(eventName, params = {}) {
            try {
                gtag('event', eventName, params);
                console.log('üìä Analytics:', eventName, params);
            } catch (e) {
                console.log('Analytics not available');
            }
        }

        // App State
        let accounts = [];
        let checks = [];
        let payees = []; // Payee directory with intelligence
        let currentAcctId = '';
        let currentSig = '';
        let currentUser = null;
        let editingCheckId = null; // Track if we're editing an existing check
        let signatureCanvas, sigCtx, isDrawing = false, lastX = 0, lastY = 0;


        // Common US Bank Routing Numbers (for auto-populate)
        const bankRoutingDB = {
            'chase': { name: 'Chase Bank', routings: { 'NY': '021000021', 'CA': '322271627', 'TX': '111000614', 'IL': '071000013', 'FL': '267084131', 'default': '021000021' } },
            'bank of america': { name: 'Bank of America', routings: { 'CA': '121000358', 'NY': '026009593', 'TX': '111000025', 'FL': '063100277', 'default': '026009593' } },
            'wells fargo': { name: 'Wells Fargo', routings: { 'CA': '121042882', 'NY': '026012881', 'TX': '111900659', 'default': '121042882' } },
            'citi': { name: 'Citibank', routings: { 'NY': '021000089', 'CA': '322271724', 'default': '021000089' } },
            'citibank': { name: 'Citibank', routings: { 'NY': '021000089', 'CA': '322271724', 'default': '021000089' } },
            'pnc': { name: 'PNC Bank', routings: { 'PA': '031000053', 'NJ': '031207607', 'OH': '042000398', 'default': '031000053' } },
            'us bank': { name: 'US Bank', routings: { 'MN': '091000022', 'CA': '122105155', 'default': '091000022' } },
            'td bank': { name: 'TD Bank', routings: { 'NY': '026013673', 'NJ': '031201360', 'MA': '211370545', 'default': '031201360' } },
            'capital one': { name: 'Capital One', routings: { 'VA': '056073502', 'NY': '051405515', 'default': '056073502' } },
            'truist': { name: 'Truist Bank', routings: { 'NC': '053101121', 'FL': '063104668', 'default': '053101121' } },
            'regions': { name: 'Regions Bank', routings: { 'AL': '062005690', 'FL': '063104668', 'default': '062005690' } },
            'fifth third': { name: 'Fifth Third Bank', routings: { 'OH': '042000314', 'MI': '072405455', 'default': '042000314' } },
            'huntington': { name: 'Huntington Bank', routings: { 'OH': '044000024', 'MI': '072403473', 'default': '044000024' } },
            'santander': { name: 'Santander Bank', routings: { 'MA': '011075150', 'NJ': '231372691', 'default': '231372691' } },
            'citizens': { name: 'Citizens Bank', routings: { 'RI': '011500120', 'MA': '211070175', 'PA': '036076150', 'default': '011500120' } },
            'm&t': { name: 'M&T Bank', routings: { 'NY': '022000046', 'MD': '052000113', 'default': '022000046' } },
            'key bank': { name: 'KeyBank', routings: { 'OH': '041001039', 'NY': '021300077', 'default': '041001039' } },
            'comerica': { name: 'Comerica Bank', routings: { 'MI': '072000096', 'TX': '111000753', 'CA': '121137522', 'default': '072000096' } },
            'bmo': { name: 'BMO Harris', routings: { 'IL': '071000288', 'WI': '075000019', 'default': '071000288' } },
            'first republic': { name: 'First Republic', routings: { 'CA': '321081669', 'default': '321081669' } },
            'silicon valley': { name: 'Silicon Valley Bank', routings: { 'CA': '121140399', 'default': '121140399' } },
            'svb': { name: 'Silicon Valley Bank', routings: { 'CA': '121140399', 'default': '121140399' } }
        };

        // Print Calibration Settings (stored per account)
        let printCalibration = {
            offsetX: 0,      // inches
            offsetY: 0,      // inches
            scale: 1.000
        };

        // ============ MICR E-13B Configuration ============
        // MICR Encoding font by Digital Graphic Labs - Freeware for internal use
        // Character mapping: A=Transit(‚ëÜ), B=Amount(‚ëá), C=On-Us(‚ëà), D=Dash(‚ëâ), 0-9=digits
        let MICR_FONT_BASE64 = 'AAEAAAAKAIAAAwAgT1MvMhrDB94AAACsAAAATmNtYXBVqb7oAAAA/AAAA6ZnbHlmVzPUWAAABKQAADVAaGVhZODmvhYAADnkAAAANmhoZWEdMxCSAAA6HAAAACRobXR4ugQhhAAAOkAAAABcbG9jYYSUk8YAADqcAAAAMG1heHAAHADwAAA6zAAAACBuYW1lCAdeTwAAOuwAAAHQcG9zdAADAAAAADy8AAAAIAAACBYBkAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgsGAAUDAgICBAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAIPACB38AAAiBB38AAAAAAAAAAgABAAAAAAAUAAMAAQAAARoAAAEGAAABAAAAAAAAAAEDAAAAAgAAAAAAAAAAAAAAAAAAAAEAAAMAAAAAAAAAAAAAAAAAAAAEBQYHCAkKCwwNAAAAAAAAAA4REhUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADxATFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQCjAAAACIAIAAEAAIA/wFTAWEBeAGSAsYC3CAUIBogHiAiICYgMCA6ISIiGf//AAAAIAFSAWABeAGSAsYC3CATIBggHCAgICYgMCA5ISIiGf//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAiAeAB4gHkAeQB5AHkAeQB5gHqAe4B8gHyAfIB9AH0AfQAAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAUABgAHAAgACQAKAAsADAANAAAAAAAAAAAAAAAAAAAADgARABIAFQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8AEAATABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAgABB38HfwAvAI8AAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAAAAAAAAAEAAAEAAAEAAAAAAAAAAAEAAAAAAAAAAAEAAAEAAAEAAAAAAAAAAAEAAAAAAAAAAAEAAAEAAAEAAAAAAAAAAAEAAAAAAAAAAAEAAAEAAAEAAAAAAAAAAAPB/53/RP+q/6v/Zv++/7//mP/b/9z/2QAAAAAAJwAkACUAaABBAEIAmgBVAFYAvABjAGMAuwBWAFUAmgBCAEEAaAAlACQAJwAAAAD/2f/c/9z/l/+//77/Zv+r/6r/Rf+dABMAJwAnACUAJgAkACQAIwARAEQAewA0ADMAVAAdAAf/+//v/+X/4v/h/+j/8AAAAAAAEAAYAB8AHgAbABEABf/5/+P/rf/M/8z/hf+8/+//3f/c/9z/2v/b/9n/2f/t/+z/2f/Z/9v/2v/c/9z/3f/v/7z/hP/N/8z/rf/j//gABQASABsAHwAfABgAEAAAAAD/8P/o/+H/4f/l/+7/+wAIAB0AUwA0ADQAegBFABEAIwAkACQAJgAlACcAJwABAAAAKAAkACQAaABCAEEAmgBVAFYAvABjAGMAvABVAFYAmgBBAEEAaQAkACUAJwAAAAD/2f/b/9z/l/+//7//Zv+q/6v/RP+d/53/RP+q/6v/Zv+//77/mP/c/9z/2AGQAAD/8P/n/+H/4v/l/+7/+wAHAB0AUwA0ADMAewBFABEAIwAkACUAJQAmACcAJgAUABQAJwAmACYAJQAlACQAIgASAEQAewA0ADMAVAAcAAj/+//u/+X/4f/i/+f/8QAAAAAADwAZAB4AHwAbABIABf/4/+T/rP/N/8z/hf+8/+7/3v/c/9v/2//a/9r/2f/s/+z/2v/Z/9r/2//b/9z/3f/v/7v/hv/M/83/rP/j//kABQASABsAHgAfABkAEAACASoAAAbRB1EANABrAAABAQEAAQABAAABAAABAQEAAAEAAAEAAAEAAAEBAQABAAABAAABAAABAQEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEBAQAAAQAAAQAAAQAAAQEBAAABAAABAAABAAABAQEAAAEAAQAAAQAAAQECvAE5ATgAOAAuAC8AJAAOABYACAAHAAkAAAAAAAAAAP/0//X/9v/l//D/7v/V/+j/6P/L/+P+4P7h/8T/zv/n/9X/7//0/+n/9//4//UAAAAAAAAAAAANAAkACQAZAA0AEAAiABQAEwAuAAb/0f+z/+D/4P/L/+j/5v/V//H/8P/vAAAAAAAAAAAADwAOAA4ALAAcABgAOwAiACIAUgAvATwBOwAxAFMAIwAjAD4AGgAcAC8AEQAQABQAAAABAAIAAP/x//L/5P/I/+v/xf/e/9//uv/g/qAAqgAAAAAAAAATABMAKQAQACYAEwAUACgAEwIXAhYAGwAyABYAFQAmAA4AEAAYAAcABwAIAAAAAAAAAAD/7//4/+T/7P/y/9v/7//v/+P/+P3D/cL/+f/h/+7/7v/b//T/8f/n//f/9//1/1YAAAATAA8AEAApABYAGABAACEAIQBBABgCRwJHABIAOgAgACEARAAdABcAKgAPAA8AEgAAAAAAAAAA//L/8//z/9n/6P/m/7//4P/f/7//5P3L/cv/2P+1/97/vf/G/+r/1f/w//D/7AAAAAAAAQOqAAAGzQdSAIYAAAEBAQAAAQAAAQAAAQAAAQEBAAABAAEAAAEAAQEBAAABAAEAAQABAQEAAAEAAAEAAAEAAAEBAQAAAQAAAQAAAQABAQEBAQAAAQAAAQAAAQABAQEAAAEAAAEAAAEAAAEBAQAAAQAAAQAAAQAAAQEBAAABAAABAAEAAAEBAQEBAAABAAABAAABAAUdAAAAAAAAAAYABgAFAA8ACAAIABYACwALABYACQBxAHEACQAQAAgAEAARAAQABwACAAQAAAAAAAAAAP/9//z/+v/2//T/8v/x//T+t/64//z/9P/6//v/8v/7//v/+P/8//3//AAAAAAAAAAAAAQAAwADAAkABAAEAA4ABwAPAAwACQAIAAoACQADAA0ABwAGAA8ABQAEAAoAAwAGAAAAAAAAAAD//P/8//3/9//7//v/8v/5//n/9P/9/+//7v/7//L/+f/6//L/+//7//f//f/9//wAAAAAAAAAAAAEAAMAAwAKAAUACQAMAAYADwAIADcANwA3ADYABgAPAAYABwAOAAUABgAIAAMABwcH/lD+T//0/+f/9P/1/+r/+P/4//L/+//8//oAAAAAAAAAAP////3/+f/p//v/9v/7//X/8/66/rr/+f/x//r/8//2//T/+f/5AAAAAAAAAAAAAwADAAMACAAGAAQADgAHAAYADgAFAUkBSQAGAA8ABgAHAA0ABAAFAAoAAwAHAAAAAAAAAAAAAAAAAAUAAwADAAoABQAFAAwABgAMAAkBSAFIAAcADQAGAAYADAAEAAUACQADAAMABAAAAAAAAAAAAAQAAwADAAkABQAFAA4ABgAHAA4ABgA6ADoACgAPAAYABgAMAAUACQAHAAMABAAAAAAAAAAAAAAAAP/8//3//f/4//v/+v/z//r/8gAAAQOqABkGzgdsAIYAAAEBAQABAAEAAAEAAAEBAQAAAQABAAABAAABAQEAAQABAAABAAABAQEAAAEAAAEAAQAAAQEBAAABAAABAAABAAABAQEAAQAAAQAAAQABAQEAAAEAAAEAAAEAAQEBAAABAAEAAAEAAAEBAQAAAQABAAABAAABAQEAAQAAAQAAAQABAAEAAQABAAP4AUMBQwAPAA0ADgALAA0ADAABAAH//wAAAAAAAAAA//v//f/5//X/+//0//r/+v/y//j/LP8r/+j/6f/p/+7/9//x//r/+//6AAAAAAAAAAAABQAEAAUADQAHABAAGQAMABYACQDaANoADwAcAAoACwAOAAAAAP/1//b/9v/j/+7+vv69//P/8f/5//L/+v/7//b//f/5AAD//wAAAAAABAAEAAMACwAFAAYADgAHAA8ACgDVANYADAAXAAwAGAARAAgADAAEAAUABQAAAAAAAAAA//v//P/3/+3/+v/t//X/9v/o//X/J/8o//f/8f/5//L/+v/6//f//P/5AAAAAAAHAAgADAALAA4AEAdsAAAAAAAA//r/+f/1//P/6//5//n/+P///k7+Tv/8//L/+v/y//b/+//2//3//P/8AAAAAAAAAAD/9v/2/+3/9//s//T/9f/p//X/Kf8q//b/6f/1//b/6v/4/+3/9f/7//kAAAAAAAAAAP/x//X/9P/i//D/8P/g//T/9P/wAAAAAAAAAAAACAADAAoABQAGAA4ABwAPAAwBrwGvAAcAEQAHAAgADQAFAAYACgACAAcAAAAAAAAAAAAHAAUACwAUAAgAFQAKAAsAGAAMANMA0gALABcADAAWABUABwAPAAUABgAIAAAAAAAAAAAABwADAAoABgAFAA8ABwAQAA8AEAASABEADAAMAAYABgAAAQLVABgGygdtAI8AAAEBAQAAAQABAAABAAEBAQAAAQABAAABAAABAQEAAAEAAQABAAABAQEAAAEAAQAAAQAAAQEBAAABAAABAAABAAABAQEAAAEAAAEAAAEAAAEBAQAAAQABAAEAAQEBAAABAAABAAABAAABAQEAAAEAAQAAAQAAAQEBAAABAAABAAABAAABAQEAAAEAAAEAAAEAAAMgAUYBRgAGAA4ABwAOAAwABgAKAAMABwAA//8AAAAAAAQAAwAHAA0ABgAQAAgACQATAAsAHgAeAAQACwAEAAoABwAHAAQAAgADAAAAAAAAAAD//f/+//r/+f/5//D/+P/4//L/+/5T/lP/9f/m//T/9f/uAAAAAAASAA0ADAAaAAgA2gDbAAQAFgAMAA0AGQAHAAkADQAFAAUABQAAAAAAAAAA//r/+//2/+7/8P/q/+r/5v8p/yn/6v/g//f/9//4AAAAAQAOAAoACwAdAA8A1gDXAA4AGAALABYAEgAJAA4ABAAFAAUAAAABAAIAAP/7//z//P/z//j/9f/m//T/8//n//b/Kf8p//X/5v/1//T/8AAAAAAAEAAMAAsAGgdtAAAAAAAA//3//f/6//X/+//0//r/8//z/n7+fv/3/+r/9//r/+7/+P/x//z/+//5AAAAAP//AAD//P/9//r/9v/3//P/+v/0//v+gf6B//r/9P/6//P/9//4//T//P/7//sAAAAAAAAAAAAKAAoACgAhABcAGgAiAAkACQAHAAAAAAABAAAABgAFAAUADwAJAAgAFQALAAoAFgAKANcA1wAMABgACwAZABIAEgAKAAsAAAAAAAAAAAAVAA4ADgAdAAkAEQAgAAsACwAOAAAAAAAAAAAABgAFAAkAEgAJABcACwAMABsADQDPANAADgAYAAoACgATAAkADAASAAYABQAFAAAAAAAAAAAACgAKAAoAIQAXABcAIQAKAAsACQABAf4AGQbPB20AewAAAQABAAABAAABAAABAQEAAAEAAQAAAQABAQEAAAEAAAEAAAEAAQEBAAABAAABAAABAAABAQEAAQABAAABAAEBAQABAAEAAAEAAAEBAQABAAABAAEAAQEBAAABAAABAAABAAEBAQABAAABAAABAAEBAQAAAQABAAABAAABAQMrAAwADgAGAA4ABgAFAAoABAAEAAQAAAAAAAAAAAAFAAUACgAUAAgAFQALABYAFQB0AHUACQAXAAsACwAWAAgACQANAAQACQAAAAAAAAAAAAMAAwACAAkABQAEAA4ABgAHAA0ABQB1AHYACgAMAA0ACwAGAAoAAgAIAAD//wAAAAD/+v/6//b/+//y//r/+f/x//n/kv+S//L/8P/5//L/+v/1//n/+QAAAAAAAAAA//n//P/7//H/+P/3/+z/9f/r/+v+uv66//P/8P/4//H/+f/8//n//f/6//4AAAAAAAAABAACAAYADAAHABAABwAHAA0ABABwB20AAP/5//3/9//6//v/8v/6//n/8f/5/ef95//1/+f/9P/n/+z/9//y//z/9gAAAAAAAAAAAAUAAwAEAA0ABwAJABUACgAXABQAEQAQAAcADQAGAAYADAAEAAUABgACAAIAAgAAAAAAAAAA//r/+f/1//v/8//6//L/9P65/rr/9P/y//P/9f/6//X//P/8//wAAAAAAAAAAAAHAAMACgAFAAsADwAOAAoAcQBxAAoAFgALAAwAFAAJAAgADgAEAAkAAAABAAAAAAAHAAQACwAIAAQACwAFAA0ADQKAAn8ACwAUAAkAEgAMAAYADAADAAQABQAAAAAAAQLRABcGzQdtAH8AAAEAAAEAAAEAAAEAAAEBAQAAAQAAAQABAAABAQEAAQABAAABAAABAQEAAQAAAQAAAQAAAQEBAAABAAABAAEAAQEBAAABAAABAAABAAABAQEAAAEAAAEAAQAAAQEBAAABAAABAAABAAEBAQAAAQABAAABAAEBAQAAAQABAAABAAEBBnoADgAeAAsADAAPAAAAAf/u//T/9P/j//f+wv7D//b/6P/1//X/6//3/+v/9f/7//kAAAABAAAAAAAJAAkAEAAJABUACwAMABoADgE/AUAADQAOAAcADgAFAAYACQACAAQAAwAAAAAAAAAA//z//f/9//j//P/0//D/8f/y/lL+Uv/z/+T/9P/1//EAAAAA//8ABgAGACMAJAFAAT8ACwAYAAsACwAWAAkAEQAKAAUABgAAAAAAAAAA//r/+v/7/+//9//3/+z/9v/r/+7+vv6+//r/8f/5//H/8//7//b//f/5AAAAAAAAAAEABQADAAYADAAEAA0ABgAPABABqwdsAAD/9//1//b/3//q/+n/3//2//b/9QAAAAAAAQAA//r/+//7//L/9//u/+j/9f/o//X/LP8s/+3/6v/q/+7/9v/u//r/+f/4AAAAAAAAAAD/+f/9//X/+//6//P/+v/5//L/+f5Q/k//+P/w//v/+f/1//v/8v/4//kAAAAAAAAAAAAPAAsADAAeABAAEwAhAAsADAAOAAAAAAAAAAAABgAFAAYADgAJAA8AFgAKABgADADbANoACQAWAAsACwAWAAkACAAOAAUACQAAAAAAAAAAAAUAAwAHAAwABQAOAAYADwANAbEBsAAHAA4ABwANAAwABAAJAAQABwADAAAAAgH9ABgGzAdtAG0AjQAAAQAAAQAAAQAAAQABAQEAAAEAAAEAAAEAAAEBAQAAAQAAAQABAAEBAQABAAABAAABAAABAQEAAAEAAQABAAABAQEAAAEAAAEBAQAAAQAAAQAAAQAAAQEBAAABAAABAAEAAAEBAQAAAQABAAEAAQEBAQEAAAEAAAEBAQAAAQAAAQEBAAABAAABAQEAAAEAAATSAAcAEgAHAAkADgAGAAUACQADAAYAAAAAAAAAAP/x//T/9P/h//D/7v/h//T/9P/xAAAAAP//AAD/+v/8//v/8f/3/+3/6v/n/+r/mv+Z/+j/6f/0/+v/9//3//D/+//6//oAAAABAAAAAAAFAAQACQAQABIAGAAMABoADgGqAaoADQAdAAsACwAPAAAAAAAAAAD/+//+//3/9v/7//r/8//5//r/8f/5/en95//6//D/+f/5//H/+v/2//r//f/9AAAAAP//AAAABQADAAcACwAMAA8ADwAMAUP/lwE8ATwAGgAuABAAEQAVAAAAAAAAAAD/6//v//D/0v/m/sT+xP/m/9L/7//w/+wAAAAAAAAAAAAUABAAEQAuB20AAP/7//z//P/0//n/+v/z//r/8v/z/17/Xv/v/+P/9f/2//QAAAAAAAYACAAIACAAGQA1ADQACgAYAAsADAAYAAkAEgALAAsAAAAAAAAAAP/2//v/8v/3//f/6f/1//T/5//1/r/+wP/2/+v/9f/q/+7/7P/1//r/+QAAAAAAAAAA//H/9f/1/+X/8/68/rv/+v/x//n/+f/y//r/+v/2//3//P/8AAAAAAAAAAAABQAEAAMACwAGAAsADQAHAA0ABwNZA1oABwAQAAYADgAMAAwABwAHAAAAAflWAAAAAAAAABYAEgASADIAHABhAGEAHAAyABIAEgAVAAAAAAAAAAD/6//u/+7/zv/k/5//n//k/87/7v/u/+oAAQLYABcG1AdtAIUAAAEAAAEAAAEAAAEAAAEBAQAAAQABAAABAAABAQEBAQAAAQABAAABAAABAQEAAAEAAAEAAAEAAAEBAQAAAQAAAQAAAQAAAQEBAAABAAABAAABAAEBAQAAAQAAAQAAAQABAQEAAQABAAABAAABAQEAAAEAAAEAAAEAAAEBAQAAAQAAAQABAAEBBngACgATAAgACAAPAAYABwAJAAMAAwAEAAAAAP//AAD//wAA//7/+//+//j/+//8//f/+/+z/7P/s/+z//j/8f/5//L/9v/8//f//v/+//wAAAABAAAAAP/x//T/9P/h/+//8P/g//T/8//xAAAAAAAAAAAABAACAAQACAAFAAUADAAFAAYADAAEAI0AjAAHABMACQAJABEABQACAAQAAAACAAAAAAAAAAD/+//8//z/8f/4//f/6v/0/+f/6P8u/y//7P/p/+n/7//3//D/+//7//sAAAAAAAAAAP/z//X/9f/j/+//6v/d//X/9P/0AAAAAAABAAAABAAEAAQACwAGAA0ADwAPABEBowdtAAD//P/9//z/9v/7//r/8v/6//n/8P/5/pz+nP/8//T/+v/z//b/+//2//3//P/5//7/3P/d/9z/3P/9//f/+//2//X/+v/z//r/+v/z//r+pP6k/+r/4f/3//b/9wAAAAAAEAALAAsAHQAOAZsBmwAHAA0ABgAHAA0ABQAFAAsABAAEAAcAAgA/AD4AAwAIAAUABQAQAAwAAwAKAAQACgAMALkAuQALABcADAAMABYACQAKABIABQANAAAAAAAAAAD/9f/2/+//9v/o//X/8//m//X/lv+X//H/4//1//T/8v////8AEgANAA0AHQAKANMA0gAPABYABwAIAAwABwAMAAYABwAAAAAAAwEhABkG0wd5AB8APwCqAAABAQEAAAEAAAEBAQAAAQAAAQEBAAABAAABAQEAAAEAAAEBAQAAAQAAAQEBAAABAAABAQEAAAEAAAEBAQAAAQAAAQEBAAEAAQAAAQABAQEAAAEAAAEAAAEAAQEBAAABAAABAAABAAABAQEAAQAAAQAAAQAAAQEBAAABAAABAAABAAABAQEAAAEAAAEAAQABAQEBAQAAAQAAAQABAAABAQEBAQAAAQAAAQAAAQADHQDcAN0AFwAqAA8ADwASAAAAAAAAAAD/7v/x//H/1v/p/yP/JP/o/9f/8f/x/+0AAAAAAAAAAAATAA8ADwApAB4A1gDXABgALAAQABEAEwAAAAAAAAAA/+3/7//w/9T/6P8p/yr/5//V/+//8P/tAAAAAAAAAAAAEwAQABEAK/4XAAAAAAAAAAcABQALAAcAEAAIABEADwAdAB0ABQAOAAYABwAPAAYABgAKAAQACAAAAAAAAAAAAAUABAAEAAoABgAFABAABgAHAAwAAgGqAaoADwARAAgAEgAHAAwADAADAAIAAQAAAAAAAAAAAAUAAwADAAsABQAFAAwABwAIABAACAAZABoACAAPAAYABgAMAAYACwAFAAYAAP//AAAAAAAAAAD/+//9//z/9v/6//P/8f/4//D/+P7C/sL+w/7C//f/7v/3//f/8P/5//n/9f/8//gEKQAAAAAAAAASABAAEAArABkA1ADUABkAKwAQABAAEwAAAAAAAAAA/+3/8P/w/9X/5/8s/yz/5//V//D/8P/u/KsAAAAAAAAAEwAPABAAKwAYAOAA3wAYACsAEAAPABMAAAAAAAAAAP/t//H/8f/U/+j/If8g/+j/1f/w//H/7f+mAYsBiwAMAAsACgAIAAUACgADAAYAAAAAAAAAAAAGAAMABAALAAYABgAMAAYADQAKAX4BfwAJABMACAAIABAABQAGAAsAAwAEAAQAAAAAAAEAAP/2//v/9P/4//X/6f/3//f/8v/8/ob+h//5//H/+v/5//T/+//8//j//P/9//sAAAAAAAAAAP/7//z//f/2//z/9v/y//H/8/8m/yX/Vf9V//j/7//4//j/8P/5//H/+f/8//sAAAAAAAAAAAAAAAAABgAEAAQADAAHAAcAEAAIABIAAAICAAAZBtMHbwBLAH8AAAEBAQABAAEAAAEAAAEBAQAAAQAAAQABAAEBAQAAAQAAAQABAAEBAQABAAABAAABAAABAQEAAAEAAQAAAQAAAQEBAAABAAABAAABAAABAQEAAAEAAAEAAQAAAQEBAAABAAABAAABAAABAQEAAQAAAQAAAQAAAQEBAAEAAAEAAQAAAloCDgIPABMAEAAQAA0ABgALAAMAAwAFAAAAAAAAAAD//f/9//3/+P/7//T/7f/u/+z/lv+X//r/8f/5//r/8f/7//X/+f/6AAAAAAAAAAD/9v/8//L/+P/3/+r/9f/0/+f/9P7B/sH/9//s//j/7//z//v/9//+//3//AAAAAAAAAAAAAUABAADAAsABwAGAA4ABwAIABEA2wE5ATkADQAbAAsADAAVAAkAEgAKAAUABgAAAAAAAAAA//r/+//8//H/9//3/+v/9P/1/+X/8/7H/sf/6P/r//X/7f/3//b/7f/6//r/+QAAAAAAAAAAAAoABQAPAAkAEwAWAAwAGgdvAAAAAAAA//n/+f/z//r/8f/4//n/7v/2/K78rv/4//H/+f/5//L/+//y//j/9wAAAAAAAAAAAAQABAAEAAsABQAKAA0ADAAMAUMBQgAZABgACwAVAAgACgARAAUABQAHAAAAAAAAAAAABAAEAAcADwAFAA8ACAAIABAABwGnAacACgATAAgACAAPAAYABgAJAAIAAwAE/KwAAAAAAAAABgAFAAUADwAJABIAGAAMABoADgDOAMwADgAbAAwADAAVAAkACQAPAAUABQAFAAAAAAAAAAD/+P/8//X/+f/3/+n/8//z/+L/8P80/zL/5v/n//T/6v/3/+3/9v/8//kAAwEqABcGwwdmACsAWACGAAABAAEAAQABAAEBAQABAAEAAQAAAQEBAAEAAQABAAEBAQAAAQABAAABAAABAQEAAAEAAQABAAEBAQAAAQABAAABAAABAQEAAAEAAQABAAEBAQABAAEAAQABAQEAAAEAAAEAAQABAQEAAAEAAQAAAQAAAQEBAAABAAEAAQABAQEAAQABAAEAAQEBdv/x//L/8v/1//X/+//6AAAAAAAAAAAABgAGAAoACgAPAAcADwAHAGoAawAPAA8ADgAKAAsABgAGAAAAAAAAAAD/+//9//n/8//7//T/+v/6//P/+f+VAun/+P/v//n/8f/1//T/+v/6AAAAAAAAAAAABAADAAYACwAGAA0ABwAHABEACADUANQACAAQAAgADwALAAwABgAGAAAAAAAAAAD/+v/5//X/9v/w//D/8P8s/yz/+P/v//n/+f/z//r/9P/6//oAAAAAAAAAAAAEAAMABgALAAYADQAHAAcAEQAIANQA1AAIABAACAAPAAsADAAGAAYAAAAAAAAAAP/6//r/9P/1//H/8f/v/ywBWwAAAAYABQALAAsADQAPAA8CHAIbAA4ADwAPAAoACgAGAAMABAAAAAAAAAAA//n/+//1//X/8v/x//L95f3k//f/7//5//H/9f/8//n//v////0AAAAA/rwAAAADAAMABwAKAAwADwAPABAA1QDVAAgAEAAHAA8ACwAGAAkAAwADAAQAAAAAAAAAAP/8//3/+f/1//X/8f/x//D/K/8r//D/8P/x//X/9v/5//oAAAAABQIAAAADAAMAAwAJAAYADAAOAA8AEQDUANUACAARAAcADwALAAYACQACAAQAAwAAAAAAAAAA//3//P/6//X/9f/x//D/8P8r/yz/7//x//L/9P/0//r/+gAAAAAAAAMBKgAXBsMHZgArAFgAhgAAAQABAAEAAQABAQEAAQABAAEAAAEBAQABAAEAAQABAQEAAAEAAQAAAQAAAQEBAAABAAEAAQABAQEAAAEAAQAAAQAAAQEBAAABAAEAAQABAQEAAQABAAEAAQEBAAABAAABAAEAAQEBAAABAAEAAAEAAAEBAQAAAQABAAEAAQEBAAEAAQABAAEBAXb/8f/y//L/9f/1//v/+gAAAAAAAAAAAAYABgAKAAoADwAHAA8ABwBqAGsADwAPAA4ACgALAAYABgAAAAAAAAAA//v//f/5//P/+//0//r/+v/z//n/lQLp//j/7//5//H/9f/0//r/+gAAAAAAAAAAAAQAAwAGAAsABgANAAcABwARAAgA1ADUAAgAEAAIAA8ACwAMAAYABgAAAAAAAAAA//r/+f/1//b/8P/w//D/LP8s//j/7//5//n/8//6//T/+v/6AAAAAAAAAAAABAADAAYACwAGAA0ABwAHABEACADUANQACAAQAAgADwALAAwABgAGAAAAAAAAAAD/+v/6//T/9f/x//H/7/8sAVsAAAAGAAUACwALAA0ADwAPAhwCGwAOAA8ADwAKAAoABgADAAQAAAAAAAAAAP/5//v/9f/1//L/8f/y/eX95P/3/+//+f/x//X//P/5//7////9AAAAAP68AAAAAwADAAcACgAMAA8ADwAQANUA1QAIABAABwAPAAsABgAJAAMAAwAEAAAAAAAAAAD//P/9//n/9f/1//H/8f/w/yv/K//w//D/8f/1//b/+f/6AAAAAAUCAAAAAwADAAMACQAGAAwADgAPABEA1ADVAAgAEQAHAA8ACwAGAAkAAgAEAAMAAAAAAAAAAP/9//z/+v/1//X/8f/w//D/K/8s/+//8f/y//T/9P/6//oAAAAAAAADASkAFwbFB2sAHwA/AF0AAAEAAAEAAAEBAQAAAQAAAQEBAAABAAABAQEAAAEAAAEBAQAAAQAAAQEBAAABAAABAQEAAAEAAAEBAQAAAQAAAQEBAQAAAQAAAQEBAAABAAABAQAAAQAAAQEBAAABAAABfv/v/+D/9f/0//MAAAAAAAAAAAANAAwACwAgABEAZwBmABIAHwALAAwADQAAAAAAAAAA//P/9P/1/+H/7v+aA77/7//g//X/9P/zAAAAAAAAAAAADQAMAAsAIAARAGcAZgASAB8ACwAMAA0AAAAAAAAAAP/z//T/9f/h/+7/mv3tAAEAEQAeAAwACwAOAAAAAAAAAAD/8v/1//X/4f/v////7//h//X/9f/yAAAAAAAAAAAADgALAAsAHwAXAAAADQAMAAwAHwASAT4BPgASACAADAALAA4AAAAAAAAAAP/y//X/9P/g/+7+wv7C/+7/4f/0//T/8wAAAAAEKgAAAA4ADAALACAAEgE+AT4AEgAgAAsADAAOAAAAAAAAAAD/8v/0//X/4P/u/sL+wv/u/+D/9f/0//IAAAAAAUsAAAAA//D/8v/z/9v/6/6Z/pj/7P/b//L/8//wAAAAAAAAABAADQANACYAFAFoAWcAFQAlAA0ADQARAAMBKQAXBsUHawAfAD8AXQAAAQAAAQAAAQEBAAABAAABAQEAAAEAAAEBAQAAAQAAAQEBAAABAAABAQEAAAEAAAEBAQAAAQAAAQEBAAABAAABAQEBAAABAAABAQEAAAEAAAEBAAABAAABAQEAAAEAAAF+/+//4P/1//T/8wAAAAAAAAAAAA0ADAALACAAEQBnAGYAEgAfAAsADAANAAAAAAAAAAD/8//0//X/4f/u/5oDvv/v/+D/9f/0//MAAAAAAAAAAAANAAwACwAgABEAZwBmABIAHwALAAwADQAAAAAAAAAA//P/9P/1/+H/7v+a/e0AAQARAB4ADAALAA4AAAAAAAAAAP/y//X/9f/h/+/////v/+H/9f/1//IAAAAAAAAAAAAOAAsACwAfABcAAAANAAwADAAfABIBPgE+ABIAIAAMAAsADgAAAAAAAAAA//L/9f/0/+D/7v7C/sL/7v/h//T/9P/zAAAAAAQqAAAADgAMAAsAIAASAT4BPgASACAACwAMAA4AAAAAAAAAAP/y//T/9f/g/+7+wv7C/+7/4P/1//T/8gAAAAABSwAAAAD/8P/y//P/2//r/pn+mP/s/9v/8v/z//AAAAAAAAAAEAANAA0AJgAUAWgBZwAVACUADQANABEAAwErAVwGzAcDAC4ASgBmAAABAAABAAABAAEAAAEBAQAAAQABAAEAAQEBAAABAAEAAQABAQEAAQABAAABAAABAQEAAAEAAAEBAQAAAQAAAQAAAQAAAQEBAAABAAABAAABAAABAQEAAAEAAAEAAAEAAAEBAQAAAQAABNL/+P/w//n/+f/z//v/9f/6//3//AAAAAAAAAAAAAQAAwAGAAsACgAPAA8AEADVANUACAAPAAcAEAAKAAoABwAHAAAAAAAAAAD/+f/7//T/+//y//n/+f/x//j/K/2E/+7/4v/0//X/8wAAAAAAAAAAAA0ACwAMAB4AEgARAB8ACwALAA4AAAAAAAAAAP/y//X/9f/h/kP/7v/i//X/9P/zAAAAAAAAAAAADQAMAAsAHgASABIAHgALAAwADQAAAAAAAAAA//P/9P/1/+ID4QAAAAMAAgACAAkABQAJAA4ABgAOAAgBSQFJAAgADgAGAA0ACgAKAAYABQAAAAAAAAAA//3//f/6//f/9//y//L/8v63/rf/8f/z//P/9v/7//f//v/+//0AAAAA/XsAAAAMAAsACgAcABACHAIbABAAHAAKAAsADAAAAAD/9P/1//b/5P/w/eX95P/w/+T/9v/1//QAAAAAAAwACwAKABwAEAIcAhsAEAAcAAoACwAMAAAAAP/0//X/9v/k//D95f3k//D/5P/2//X/9AAAAwErAVwGzAcDAC4ASgBmAAABAAABAAABAAEAAAEBAQAAAQABAAEAAQEBAAABAAEAAQABAQEAAQABAAABAAABAQEAAAEAAAEBAQAAAQAAAQAAAQAAAQEBAAABAAABAAABAAABAQEAAAEAAAEAAAEAAAEBAQAAAQAABNL/+P/w//n/+f/z//v/9f/6//3//AAAAAAAAAAAAAQAAwAGAAsACgAPAA8AEADVANUACAAPAAcAEAAKAAoABwAHAAAAAAAAAAD/+f/7//T/+//y//n/+f/x//j/K/2E/+7/4v/0//X/8wAAAAAAAAAAAA0ACwAMAB4AEgARAB8ACwALAA4AAAAAAAAAAP/y//X/9f/h/kP/7v/i//X/9P/zAAAAAAAAAAAADQAMAAsAHgASABIAHgALAAwADQAAAAAAAAAA//P/9P/1/+ID4QAAAAMAAgACAAkABQAJAA4ABgAOAAgBSQFJAAgADgAGAA0ACgAKAAYABQAAAAAAAAAA//3//f/6//f/9//y//L/8v63/rf/8f/z//P/9v/7//f//v/+//0AAAAA/XsAAAAMAAsACgAcABACHAIbABAAHAAKAAsADAAAAAD/9P/1//b/5P/w/eX95P/w/+T/9v/1//QAAAAAAAwACwAKABwAEAIcAhsAEAAcAAoACwAMAAAAAP/0//X/9v/k//D95f3k//D/5P/2//X/9AAAAwEqAjEGwAVUAC8AYACLAAABAAEAAAEAAAEAAQEBAAABAAEAAQAAAQEBAAABAAEAAAEAAAEBAQAAAQABAAEAAQEBAAEAAAEAAAEAAQEBAAABAAEAAAEAAAEBAQAAAQABAAABAAABAQEAAAEAAQABAAEBAQABAAABAAABAAEBAQAAAQABAAEAAAEAAQAAAQABAAABAQEAAQABAAEAAAF+/+//8P/5//L/+//6//f//f/5AAAAAAAAAAAABAADAAcACwALAA8ACAAQAAkAZQBmAAkAEQAHAA4ADAAGAAkAAwAEAAMAAAAAAAAAAP/8//3/+v/0//X/8f/w/+//mgIR/+//8P/5//P/+v/7//b//f/6AAAAAAAAAAAAAwADAAcACwAFAA4ABwAIABEACABmAGYACAARAAcADwAMAAUACgADAAMABAAAAAAAAAAA//z//f/6//T/9P/x//D/8P+aAhH/7//w//n/8v/7//r/9v/9//oAAAAAAAAAAAADAAIABAAKAAwAEAAJABIACgASAA8ABwAPAAUADAAGAAMABAAAAAAAAAAA//z//P/5//X/7f/3/+wCMQAAAAUAAwAIAAQABQAMAAUADQAPAUwBSwAHAA8ABQANAAkACgAFAAMAAwAAAAAAAAAA//3//f/7//b//P/0//r/+v/y//n+tf60//j/8v/6//T/9v/3//r/+wAAAAAAAAAAAAUAAwAIAAQABQAMAAUADQAPAUwBSwAHAA8ABQANAAkABQAIAAIAAwADAAAAAAAAAAD//f/9//v/9v/8//T/+v/6//L/+f61/rT/+P/y//r/9P/2//f/+v/7AAAAAAAAAAAABwADAAoABgAGAA8ACAAQABMBNwE4AAgAEAAHAA4ADAAQAAgABAAFAAAAAP/4//3/9v/6//T/8P/4/+7/9/7I/sn/8v/z//P/9f/u//b/+//6AAMBKgIxBsAFVAAvAGAAiwAAAQABAAABAAABAAEBAQAAAQABAAEAAAEBAQAAAQABAAABAAABAQEAAAEAAQABAAEBAQABAAABAAABAAEBAQAAAQABAAABAAABAQEAAAEAAQAAAQAAAQEBAAABAAEAAQABAQEAAQAAAQAAAQABAQEAAAEAAQABAAABAAEAAAEAAQAAAQEBAAEAAQABAAABfv/v//D/+f/y//v/+v/3//3/+QAAAAAAAAAAAAQAAwAHAAsACwAPAAgAEAAJAGUAZgAJABEABwAOAAwABgAJAAMABAADAAAAAAAAAAD//P/9//r/9P/1//H/8P/v/5oCEf/v//D/+f/z//r/+//2//3/+gAAAAAAAAAAAAMAAwAHAAsABQAOAAcACAARAAgAZgBmAAgAEQAHAA8ADAAFAAoAAwADAAQAAAAAAAAAAP/8//3/+v/0//T/8f/w//D/mgIR/+//8P/5//L/+//6//b//f/6AAAAAAAAAAAAAwACAAQACgAMABAACQASAAoAEgAPAAcADwAFAAwABgADAAQAAAAAAAAAAP/8//z/+f/1/+3/9//sAjEAAAAFAAMACAAEAAUADAAFAA0ADwFMAUsABwAPAAUADQAJAAoABQADAAMAAAAAAAAAAP/9//3/+//2//z/9P/6//r/8v/5/rX+tP/4//L/+v/0//b/9//6//sAAAAAAAAAAAAFAAMACAAEAAUADAAFAA0ADwFMAUsABwAPAAUADQAJAAUACAACAAMAAwAAAAAAAAAA//3//f/7//b//P/0//r/+v/y//n+tf60//j/8v/6//T/9v/3//r/+wAAAAAAAAAAAAcAAwAKAAYABgAPAAgAEAATATcBOAAIABAABwAOAAwAEAAIAAQABQAAAAD/+P/9//b/+v/0//D/+P/u//f+yP7J//L/8//z//X/7v/2//v/+gAEABwAEgmKA2YAMQA8AKIA3QAAAQEBAAABAAAAAAEAAAEAAAEAAAAAAQAAAQAAAQAAAQAAAQAAAAABAAABAAABAAABAAABAAAAAAEAAAAAAQEAAAEAAAAAAQAAAQAAAQAAAQAAAAABAAABAAAAAAEAAAEAAAAAAQAAAAABAAABAAABAAAAAAEAAAAAAQAAAQAAAAAAAAAAAQEAAAEAAAAAAQAAAQAAAQAAAAABAAABAAAAAAEAAAEBAQEAAAEAAAEAAAEAAQEBAAAAAAEAAAEAAAEBAQAAAAABAAABAAAAAAEAAAAAAAAAAAEAAAEAAAAAAH4AAP/4//T/5v/6/+X/7QAKACQAHAAAAAkAAwAAABAAAABHAJQAjwCCADQAGAAkAAwAGwAG/+f/9//j/+7/7v/N/+X/0v+G/37/gf/N/+7/3v/0//T/8AAAAAAAKwAVAAYAEACOAC0AZwBhAFIAGQAy/+r/lf9T/5wFNP/l/8z/6//L/4n/hv+K/8z/8f/k//f/9P/u//r/5//pAAAAAAAoAFkAiwBkAAYAFQAJABYALgAtAC0AFgADAAkAAAARAB4AFwAOAAAABQAK////8f/t//r/6v/0//T/7//9/+z/5P/Z/8H/yv/M/6P/uv/XAAAAAAAEAAAABwAVAB4AKAAyAD8ATABbADYAAP/9//X/+v/q/7f/vP/PAAAAAAAAAAAABgAqABgAIABdAGEAXAAeAAYACgAAAAD/7f/q/+0AAAAA//wBoAAAASgAAAAAAAsACQAJABcADAAMABsACQAYAAAAAP18//D/3//m/+8AAAAAAAwADAAMACYAEgBMAAD/7P/G/8v/2wAAAAAAAAAAAAL////6//j//QAMAC8APwBJAEsASQA/ADEADQAMAAwAAAAA/9v/zP/EAKwCFAAAAAAABAAAAAoAKwAtACIAAAAAAAAAAAAAAAQAAAAAAAr/9P/O/8T/5f/A/9//r/9Q/63/4v/H/+f/6P/T//H/5//uAAAABwAAAAAACwAJAAwAIgASABkAFwAAAAAABAAAAAD/+QAMACoAMQBzAKUAagAyAAD9pP/3/+v/+v/q/+gAAAAYABoABgAVAAkACQAXAAwAMwCBADgAUwCpAIcAVQAAAAD//AAAAAD/+f/3//gAAAAAAAgAAAAS//r/5P/Z/+//6f/Q/9H/1f/t//r/+gAAAAAABgAGACYANgAjABEAAAAA/+H/xf+p/8n/5f/F/+L/uf+k/8r/6wAAAA4AEgAOAAAAYAAAAAAAAAAA//sABwAeACQABAAIAAAAFwAhAAAACAAL////8v/w//r/8P/6/+D/z//S/8//4P/1/9gCR/3sAAAAgAAWACEACQAMAAwAAAAA//n/9//p/8/++AAAAAAACAAQABoAEgAVAB0ABgAGAAYAAAAAAhQAAP//AAoAHQAfAAIACQAAAAkABAABAAMABwANABYADwAJAAP//P/2/+3/8//0/+n/9//h/97/8QABAAEAAAAAAACMo9LHXw889QADEACkBAAAAAQqbdQ+Py0AAAAAAAIAAAmKB38AAAAIAAEAAAAAAAAAAQAAB38AAAiBEAAAAAB6DTIAAQAAAAAAAAAAAAAAAAAAABcIAAAAAAAAABAAAAAIAAAACAABKggAA6oIAAOqCAAC1QgAAf4IAALRCAAB/QgAAtgIAAEhCAACAAgAASoIAAEqCAABKQgAASkIAAErCAABKwgAASoIAAEqCgQAHAAAAXABcAFwAXAChgPfBTgGpwfkCSsKlgvsDaEO6RBEEZ8SkxOHFJIVnRcEGGsaoAABAAAAFwDeAAQAAAAAAAEAAAAQAAAAAAAAAAAAAAABAAAADACWAAEAAAAAAAEAEwAAAAEAAAAAAAIABwBHAAEAAAAAAAMAEwBOAAEAAAAAAAQAEwBhAAMAAQQJAAAAYgB0AAMAAQQJAAEAGgDWAAMAAQQJAAIADgDwAAMAAQQJAAMAGgD+AAMAAQQJAAQAGgEYAAMAAQQJAAUACAEyAAMAAQQJAAYAGAAGAAMAAQQJAAcAHAAeTUlDUiBFAE0ASQBDAFIARQBuAGMAbwBkAGkAbgBnACgAMgAwADQAKQAgADUAOAA5AC0ANAAzADQANW5jb2RpbmcgLSBER0xSZWd1bGFyTUlDUiBFbmNvZGluZyAtIERHTE1JQ1IgRW5jb2RpbmcgLSBER0wAqQAgADEAOQA5ADgAIABEAGkAZwBpAHQAYQBsACAARwByAGEAcABoAGkAYwAgAEwAYQBiAHMAIAAtACAAQQBsAGwAIABSAGkAZwBoAHQAcwAgAFIAZQBzAGUAcgB2AGUAZABNAEkAQwBSACAARQBuAGMAbwBkAGkAbgBnAFIAZQBnAHUAbABhAHIATQBJAEMAUgAgAEUAbgBjAG8AZABpAG4AZwBNAEkAQwBSACAARQBuAGMAbwBkAGkAbgBnADEALgAwADIAAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==';
        let micrFontLoaded = false;

        // MICR format helper
        function formatMICR(checkNo, routing, account) {
            const cn = checkNo.toString().padStart(8, '0');
            // Standard format: ‚ëàcheck‚ëà ‚ëÜrouting‚ëÜ account‚ëà
            // Using placeholder letters that map to symbols in MICR fonts
            return { checkNo: cn, routing, account };
        }

        // Debug helper - call micrDebug() in console to check status
        function micrDebug() {
            console.log('=== MICR DEBUG ===');
            console.log('MICR_FONT_BASE64 present:', !!MICR_FONT_BASE64);
            console.log('MICR_FONT_BASE64 length:', MICR_FONT_BASE64 ? MICR_FONT_BASE64.length : 0);
            console.log('micrFontLoaded flag:', micrFontLoaded);
            const rt = (document.getElementById('routingNumber')?.value || '123456789').padStart(9, '0');
            const ac = document.getElementById('accountNumber')?.value || '000000000';
            const cn = document.getElementById('checkNumber')?.value || '1001';
            const sample = formatMICR(cn, rt, ac);
            console.log('MICR data:', sample);
            return { fontPresent: !!MICR_FONT_BASE64, fontLength: MICR_FONT_BASE64?.length || 0, loaded: micrFontLoaded, sample };
        }

        // Draw MICR E-13B symbols programmatically (no font needed)
        // This draws the actual MICR symbol shapes
        function drawMICRLine(pdf, x, y, checkNo, routing, account) {
            const charWidth = 8.5;  // Width of each character in points
            const charHeight = 10;  // Height
            let currentX = x;

            pdf.setFillColor(0, 0, 0);
            pdf.setDrawColor(0, 0, 0);
            pdf.setLineWidth(0.8);

            // Draw On-Us symbol (‚ëà) - looks like vertical bars with gap
            function drawOnUs(px, py) {
                pdf.rect(px, py, 1.5, charHeight, 'F');
                pdf.rect(px + 4, py, 1.5, charHeight, 'F');
                return charWidth;
            }

            // Draw Transit symbol (‚ëÜ) - looks like vertical bar with dots  
            function drawTransit(px, py) {
                pdf.rect(px, py, 1.5, charHeight, 'F');
                pdf.circle(px + 5, py + 3, 1.2, 'F');
                pdf.circle(px + 5, py + 7, 1.2, 'F');
                return charWidth;
            }

            // Draw digit
            function drawDigit(px, py, digit) {
                pdf.setFontSize(12);
                pdf.setFont('courier', 'normal');
                pdf.text(digit.toString(), px + 1, py + charHeight - 1);
                return charWidth;
            }

            // Draw space
            function drawSpace() {
                return charWidth * 0.7;
            }

            // Build MICR line: ‚ëàcheckno‚ëà ‚ëÜrouting‚ëÜ account‚ëà

            // On-Us + Check Number + On-Us
            currentX += drawOnUs(currentX, y);
            for (let d of checkNo.padStart(8, '0')) {
                currentX += drawDigit(currentX, y, d);
            }
            currentX += drawOnUs(currentX, y);

            currentX += drawSpace();

            // Transit + Routing + Transit
            currentX += drawTransit(currentX, y);
            for (let d of routing.padStart(9, '0')) {
                currentX += drawDigit(currentX, y, d);
            }
            currentX += drawTransit(currentX, y);

            currentX += drawSpace();

            // Account + On-Us
            for (let d of account) {
                currentX += drawDigit(currentX, y, d);
            }
            currentX += drawOnUs(currentX, y);

            return currentX - x; // Return total width
        }

        // Generate MICR test PDF to verify symbols
        function printMICRTest() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });

            console.log('=== MICR TEST PDF ===');
            console.log('Font base64 present:', !!MICR_FONT_BASE64);
            console.log('Font base64 length:', MICR_FONT_BASE64 ? MICR_FONT_BASE64.length : 0);

            pdf.setFontSize(16);
            pdf.setFont('helvetica', 'bold');
            pdf.text('MICR E-13B Symbol Test', 36, 40);

            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            pdf.text(`Generated: ${new Date().toLocaleString()}`, 36, 60);

            // Debug info
            const debug = micrDebug();
            pdf.text(`Font Base64 Present: ${debug.fontPresent} (${MICR_FONT_BASE64 ? (MICR_FONT_BASE64.length / 1024).toFixed(1) + 'KB' : '0'})`, 36, 80);
            pdf.text(`Font Already Loaded: ${debug.loaded}`, 36, 95);

            // Try to load MICR font
            let fontLoadSuccess = false;
            if (MICR_FONT_BASE64) {
                try {
                    pdf.addFileToVFS('MICR.ttf', MICR_FONT_BASE64);
                    pdf.addFont('MICR.ttf', 'MICR', 'normal');
                    micrFontLoaded = true;
                    fontLoadSuccess = true;
                    console.log('MICR font registered successfully');
                    console.log('Available fonts:', pdf.getFontList());
                } catch (e) {
                    console.error('MICR font load failed:', e);
                }
            }

            pdf.text(`Font Registration: ${fontLoadSuccess ? 'SUCCESS' : 'FAILED'}`, 36, 110);

            // Test 1: MICR font characters (the real test)
            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'bold');
            pdf.text('TEST 1: MICR Font Character Test', 36, 150);

            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(10);
            pdf.text('If MICR font works, A B C D should appear as special symbols:', 36, 170);

            if (fontLoadSuccess) {
                pdf.setFont('MICR', 'normal');
            } else {
                pdf.setFont('courier', 'normal');
            }
            pdf.setFontSize(18);
            pdf.text('ABCD 0123456789', 36, 195);

            // Show what we expect
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(9);
            pdf.text('A = Transit ‚ëÜ   B = Amount ‚ëá   C = On-Us ‚ëà   D = Dash ‚ëâ', 36, 215);

            // Test 2: Full MICR line format
            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'bold');
            pdf.text('TEST 2: Complete MICR Line', 36, 255);

            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(10);
            pdf.text('Format: C{checkno}C A{routing}A {account}C', 36, 275);

            if (fontLoadSuccess) {
                pdf.setFont('MICR', 'normal');
            } else {
                pdf.setFont('courier', 'normal');
            }
            pdf.setFontSize(14);
            pdf.text('C00007862C A021000021A 730972523C', 36, 300);

            // Test 3: Programmatic drawing comparison
            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'bold');
            pdf.text('TEST 3: Programmatic Symbol Drawing (Fallback)', 36, 350);

            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(10);
            pdf.text('This uses drawn shapes instead of font glyphs:', 36, 370);

            drawMICRLine(pdf, 36, 390, '00007862', '021000021', '730972523');

            // Instructions
            pdf.setFontSize(12);
            pdf.setFont('helvetica', 'bold');
            pdf.text('HOW TO READ THIS TEST:', 36, 450);

            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(10);
            const instructions = [
                '‚Ä¢ If TEST 1 shows letters A B C D ‚Üí Font NOT working (still shows raw characters)',
                '‚Ä¢ If TEST 1 shows symbols ‚ëÜ ‚ëá ‚ëà ‚ëâ ‚Üí Font IS working correctly!',
                '‚Ä¢ TEST 2 should show: ‚ëà00007862‚ëà ‚ëÜ021000021‚ëÜ 730972523‚ëà',
                '‚Ä¢ TEST 3 is a fallback that draws symbols without needing a font'
            ];
            instructions.forEach((line, i) => {
                pdf.text(line, 36, 475 + (i * 16));
            });

            pdf.save('MICR_Test.pdf');
            toast('MICR test PDF generated - check console (F12) for debug info');
        }

        // ============ MICR STATUS & FONT LOADING ============

        function updateMICRStatus() {
            const debug = micrDebug();

            const loadedEl = document.getElementById('micrStatusLoaded');
            const sizeEl = document.getElementById('micrStatusSize');
            const fontEl = document.getElementById('micrStatusFont');

            if (loadedEl) {
                if (debug.loaded) {
                    loadedEl.textContent = '‚úÖ Yes';
                    loadedEl.style.color = '#43a047';
                } else {
                    loadedEl.textContent = '‚ùå No';
                    loadedEl.style.color = '#e53935';
                }
            }

            if (sizeEl) {
                sizeEl.textContent = debug.fontLength > 0 ? `${(debug.fontLength / 1024).toFixed(1)} KB` : '0 bytes';
            }

            if (fontEl) {
                fontEl.textContent = debug.loaded ? 'MICR E-13B' : 'Programmatic (fallback)';
            }
        }

        function loadMICRFont(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function (e) {
                    try {
                        // Get base64 without the data URL prefix
                        const base64 = e.target.result.split(',')[1];
                        MICR_FONT_BASE64 = base64;
                        micrFontLoaded = false; // Reset so it loads fresh in next PDF

                        console.log('MICR font loaded, size:', base64.length);

                        // Save to Firestore if signed in (more reliable than localStorage)
                        if (currentUser) {
                            try {
                                await db.collection('users').doc(currentUser.uid).set({
                                    micrFont: base64
                                }, { merge: true });
                                console.log('MICR font saved to Firestore');
                            } catch (e) {
                                console.log('Could not save font to Firestore:', e);
                            }
                        }

                        // Also save to localStorage as backup
                        try {
                            localStorage.setItem('cf_micr_font', base64);
                        } catch (e) {
                            console.log('localStorage save failed (font too large)');
                        }

                        updateMICRStatus();
                        toast('MICR font loaded! Generate a test PDF to verify.');
                        resolve(base64);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ========== MOBILE NAVIGATION ==========

        function toggleMobileNav() {
            const nav = document.querySelector('.mobile-nav');
            const overlay = document.querySelector('.mobile-nav-overlay');
            const hamburger = document.querySelector('.hamburger');

            nav.classList.toggle('active');
            overlay.classList.toggle('active');
            hamburger.classList.toggle('active');
        }

        function mobileNavTo(page) {
            // Close mobile nav
            toggleMobileNav();

            // Update active states in mobile nav
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === page);
            });

            // Also update sidebar active states (for consistency)
            document.querySelectorAll('.sidebar .nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === page);
            });

            // Show the appropriate page
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const targetPage = document.getElementById('page-' + page);
            if (targetPage) targetPage.classList.add('active');

            // Update mobile header title
            const titles = {
                'write': 'Write Check',
                'history': 'History',
                'import-export': 'Import/Export',
                'accounts': 'Accounts',
                'settings': 'Settings'
            };
            const mobileTitle = document.querySelector('.mobile-title');
            if (mobileTitle && titles[page]) {
                mobileTitle.textContent = titles[page];
            }

            // Track page view (mobile)
            trackEvent('page_view', { page_name: page, source: 'mobile_nav' });
        }

        // Universal navigation function (works on both mobile and desktop)
        function navigateTo(page) {
            // Update active states in sidebar
            document.querySelectorAll('.sidebar .nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === page);
            });

            // Update active states in mobile nav
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === page);
            });

            // Show the appropriate page
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const targetPage = document.getElementById('page-' + page);
            if (targetPage) targetPage.classList.add('active');

            // Update mobile header title
            const titles = {
                'write': 'Write Check',
                'history': 'History',
                'import-export': 'Import/Export',
                'accounts': 'Accounts',
                'settings': 'Settings'
            };
            const mobileTitle = document.querySelector('.mobile-title');
            if (mobileTitle && titles[page]) {
                mobileTitle.textContent = titles[page];
            }

            // Track page view
            trackEvent('page_view', { page_name: page, source: 'programmatic' });
        }

        // Close mobile nav when clicking outside or pressing Escape
        // Keyboard shortcuts for power users
        document.addEventListener('keydown', e => {
            // ESC - Close mobile nav
            if (e.key === 'Escape') {
                const nav = document.querySelector('.mobile-nav');
                if (nav && nav.classList.contains('active')) {
                    toggleMobileNav();
                    return;
                }

                // ESC - Clear form (with confirmation if data entered)
                const currentPage = document.querySelector('.page.active');
                if (currentPage && currentPage.id === 'page-write') {
                    const payTo = document.getElementById('payTo').value.trim();
                    const amount = document.getElementById('amount').value.trim();
                    if (payTo || amount) {
                        if (confirm('Clear all fields?')) {
                            clearCheck();
                        }
                    }
                }
            }

            // Ctrl+Enter or Cmd+Enter - Save & Next
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                const currentPage = document.querySelector('.page.active');
                if (currentPage && currentPage.id === 'page-write') {
                    saveCheckAndNext();
                }
            }

            // Ctrl+P or Cmd+P - Print (override browser print)
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                const currentPage = document.querySelector('.page.active');
                if (currentPage && currentPage.id === 'page-write') {
                    showPrintModal();
                }
            }

            // Ctrl+S or Cmd+S - Save Draft
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                const currentPage = document.querySelector('.page.active');
                if (currentPage && currentPage.id === 'page-write') {
                    saveCheckDraft();
                }
            }

            // Ctrl+Z or Cmd+Z - Undo last save (if available)
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && undoCheckId) {
                e.preventDefault();
                undoLastSave();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            initNav();
            initForm();
            // initSignature(); // REMOVED - Signature now in Account modal, not Write Check page
            setToday();

            // Load saved MICR font from localStorage
            const savedFont = localStorage.getItem('cf_micr_font');
            if (savedFont) {
                MICR_FONT_BASE64 = savedFont;
                console.log('Loaded MICR font from localStorage, size:', savedFont.length);
            }

            // Set up MICR font file input listener
            const fontInput = document.getElementById('micrFontFile');
            if (fontInput) {
                fontInput.addEventListener('change', async (e) => {
                    if (e.target.files && e.target.files[0]) {
                        try {
                            await loadMICRFont(e.target.files[0]);
                        } catch (err) {
                            toast('Error loading font: ' + err.message, 'error');
                        }
                    }
                });
            }

            // Update MICR status on load
            setTimeout(updateMICRStatus, 500);

            // Check for checkout success on page load
            handleCheckoutSuccess();

            // Auth state listener
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    console.log('Signed in as:', user.email || user.uid);

                    // Track login event
                    trackEvent('login', { method: user.providerData[0]?.providerId || 'unknown' });

                    hideLoginModal();
                    updateUserDisplay();
                    await loadDataFromFirebase();

                    // Update company stats
                    updateCompanyStats();
                } else {
                    currentUser = null;
                    // Show login modal or load from localStorage
                    showLoginModal();
                    loadFromLocalStorage();
                }
            });
        });

        // Login Modal Functions
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('active');
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.remove('active');
        }

        // ========== API ENDPOINTS CONFIGURATION ==========
        // Configure these for your deployment (relative paths work with any backend serving /api/)
        const API_BASE_URL = ''; // Leave empty for relative paths, or set full URL like 'https://your-domain.com'
        const FUNCTIONS_URLS = {
            createCheckoutSession: `${API_BASE_URL}/api/create-checkout-session`,
            verifyCheckout: `${API_BASE_URL}/api/verify-checkout`,
            getBillingPortal: `${API_BASE_URL}/api/get-billing-portal`,
            cancelSubscription: `${API_BASE_URL}/api/cancel-subscription`
        };

        // User plan state
        let userPlan = { plan: 'free', status: null };

        // ========== BILLING & SUBSCRIPTION FUNCTIONS ==========

        function showPricingModal() {
            stripeLog('showPricingModal', {
                currentPlan: userPlan.plan,
                status: userPlan.status,
                userId: currentUser?.uid
            });

            const upgradeView = document.getElementById('pricingUpgradeView');
            const subscriptionView = document.getElementById('pricingSubscriptionView');

            // Check if user has a paid plan
            if (hasPaidPlan()) {
                // Show subscription management view
                upgradeView.style.display = 'none';
                subscriptionView.style.display = 'block';

                // Populate subscription details
                const planName = userPlan.plan === 'unlimited' ? 'Pro ‚Äì Unlimited' : 'Pro ‚Äì Per Account';
                const price = userPlan.plan === 'unlimited' ? '$5/month' : '$1/account/mo';

                document.getElementById('subPlanName').textContent = planName;
                document.getElementById('subPrice').textContent = price;

                // Status
                const statusEl = document.getElementById('subStatus');
                if (userPlan.status === 'trialing') {
                    statusEl.textContent = '‚ú® Trial';
                    statusEl.style.color = 'var(--warning)';
                    document.getElementById('subDateLabel').textContent = 'Trial Ends';
                } else {
                    statusEl.textContent = '‚úì Active';
                    statusEl.style.color = 'var(--success)';
                    document.getElementById('subDateLabel').textContent = 'Next Billing';
                }

                // Dates
                if (userPlan.trialEndsAt) {
                    document.getElementById('subDate').textContent = new Date(userPlan.trialEndsAt).toLocaleDateString();
                } else if (userPlan.currentPeriodEnd) {
                    document.getElementById('subDate').textContent = new Date(userPlan.currentPeriodEnd).toLocaleDateString();
                } else {
                    document.getElementById('subDate').textContent = '-';
                }

                // Member since (use updatedAt as approximate)
                document.getElementById('subMemberSince').textContent = new Date().toLocaleDateString();

                trackEvent('subscription_modal_shown');
            } else {
                // Show upgrade view
                upgradeView.style.display = 'block';
                subscriptionView.style.display = 'none';
                trackEvent('pricing_modal_shown');
            }

            document.getElementById('pricingModal').classList.add('active');
        }

        function closePricingModal() {
            stripeLog('closePricingModal');
            document.getElementById('pricingModal').classList.remove('active');
            // Reset views for next open
            document.getElementById('pricingUpgradeView').style.display = 'block';
            document.getElementById('pricingSubscriptionView').style.display = 'none';
        }

        // Cancel subscription
        async function cancelSubscription() {
            if (!confirm('Are you sure you want to cancel your subscription? You will keep access until the end of your current billing period.')) {
                return;
            }

            stripeLog('cancelSubscription:start', { subscriptionId: userPlan.subscriptionId });

            if (!userPlan.subscriptionId) {
                toast('No subscription found to cancel', 'error');
                return;
            }

            try {
                const cancelBtn = document.getElementById('cancelSubBtn');
                cancelBtn.disabled = true;
                cancelBtn.textContent = 'Canceling...';

                const response = await fetch(FUNCTIONS_URLS.cancelSubscription, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subscriptionId: userPlan.subscriptionId,
                        uid: currentUser.uid
                    })
                });

                const data = await response.json();

                if (data.success) {
                    stripeLog('cancelSubscription:success', data, 'success');
                    toast('Subscription canceled. You will keep access until ' + new Date(data.currentPeriodEnd * 1000).toLocaleDateString());

                    // Update local status
                    userPlan.status = 'canceled';

                    closePricingModal();
                    updatePlanDisplay();
                } else {
                    throw new Error(data.error || 'Failed to cancel subscription');
                }
            } catch (error) {
                stripeLog('cancelSubscription:error', { message: error.message }, 'error');
                toast('Failed to cancel: ' + error.message, 'error');
            } finally {
                const cancelBtn = document.getElementById('cancelSubBtn');
                cancelBtn.disabled = false;
                cancelBtn.textContent = 'Cancel Subscription';
            }
        }

        // Check if user has a paid plan (active or trialing)
        function hasPaidPlan() {
            const result = userPlan.plan !== 'free' &&
                (userPlan.status === 'active' || userPlan.status === 'trialing');
            stripeLog('hasPaidPlan:check', {
                plan: userPlan.plan,
                status: userPlan.status,
                result
            });
            return result;
        }

        // Check if feature is allowed based on plan
        function canUseFeature(feature) {
            // Free features (always allowed)
            const freeFeatures = ['create_check', 'print_check', 'draw_signature'];
            if (freeFeatures.includes(feature)) return true;

            // Paid features require active subscription
            const paidFeatures = ['save_check', 'view_history', 'add_account', 'export_data', 'save_payee'];
            if (paidFeatures.includes(feature)) {
                return hasPaidPlan();
            }

            return true; // Default allow
        }

        // Soft gate: Show pricing modal if feature requires upgrade
        function requirePaidPlan(feature, callback) {
            if (!currentUser) {
                // Not logged in - show login first, then pricing
                showLoginModal();
                toast('Please sign in first', 'error');
                return false;
            }

            if (canUseFeature(feature)) {
                // User has access - execute callback
                if (callback) callback();
                return true;
            } else {
                // User needs to upgrade
                showPricingModal();
                trackEvent('upgrade_gate_triggered', { feature });
                return false;
            }
        }

        // Load user's subscription data from Firestore
        async function verifyAndActivatePlan(sessionId) {
            stripeLog('verifyAndActivatePlan:start', { sessionId, userId: currentUser?.uid });

            if (!currentUser) {
                stripeLog('verifyAndActivatePlan:noUser', {}, 'error');
                toast('Please sign in to complete verification', 'error');
                return;
            }

            try {
                toast('Verifying subscription...');
                stripeLog('verifyAndActivatePlan:fetching', { url: `${FUNCTIONS_URLS.verifyCheckout}?session_id=${sessionId}` });

                const res = await fetch(`${FUNCTIONS_URLS.verifyCheckout}?session_id=${sessionId}`);
                const data = await res.json();

                stripeLog('verifyAndActivatePlan:response', { data });

                if (data.verified) {
                    // UID check - allow if matching or if data.uid is missing
                    if (data.uid && data.uid !== currentUser.uid) {
                        stripeLog('verifyAndActivatePlan:uidMismatch', {
                            expected: currentUser.uid,
                            received: data.uid
                        }, 'error');
                        toast('Verification failed: User mismatch', 'error');
                        return;
                    }

                    // Update Firestore with plan info
                    const updateData = {
                        plan: data.plan || 'unlimited',
                        status: data.status || 'active',
                        subscriptionId: data.subscriptionId || null,
                        updatedAt: new Date().toISOString()
                    };

                    stripeLog('verifyAndActivatePlan:writingToFirestore', {
                        userId: currentUser.uid,
                        updateData
                    });

                    await db.collection('users').doc(currentUser.uid).set(updateData, { merge: true });

                    stripeLog('verifyAndActivatePlan:success', { updateData }, 'success');
                    toast('üéâ Plan upgraded successfully!');

                    // The real-time listener will pick up the change automatically
                } else {
                    stripeLog('verifyAndActivatePlan:notVerified', { data }, 'error');
                    toast('Verification failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                stripeLog('verifyAndActivatePlan:error', {
                    message: e.message,
                    stack: e.stack
                }, 'error');
                console.error('Verification error:', e);
                toast('Verification error: ' + e.message, 'error');
            }
        }

        let unsubscribePlan = null;

        async function loadUserPlan() {
            stripeLog('loadUserPlan:start', { userId: currentUser?.uid });

            if (!currentUser) {
                stripeLog('loadUserPlan:noUser', { result: 'Setting free plan' }, 'warn');
                userPlan = { plan: 'free', status: null };
                updatePlanDisplay();
                return;
            }

            if (unsubscribePlan) unsubscribePlan();

            try {
                stripeLog('loadUserPlan:setupListener', { userId: currentUser.uid });

                // Real-time listener
                unsubscribePlan = db.collection('users').doc(currentUser.uid)
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            // Fix: Check both 'status' and 'subscriptionStatus'
                            userPlan = {
                                plan: data.plan || 'free',
                                status: data.status || data.subscriptionStatus || null,
                                stripeCustomerId: data.stripeCustomerId || null,
                                subscriptionId: data.subscriptionId || null,
                                trialEndsAt: data.trialEndsAt ? (data.trialEndsAt.toDate ? data.trialEndsAt.toDate() : new Date(data.trialEndsAt)) : null,
                                currentPeriodEnd: data.currentPeriodEnd ? (data.currentPeriodEnd.toDate ? data.currentPeriodEnd.toDate() : new Date(data.currentPeriodEnd)) : null,
                                quantity: data.quantity || 0
                            };
                            stripeLog('loadUserPlan:loaded', { userPlan }, 'success');
                        } else {
                            userPlan = { plan: 'free', status: null };
                        }
                        updatePlanDisplay();
                        // Also update bank fields since permissions might change
                        if (typeof updateBankFieldsEditability === 'function') updateBankFieldsEditability();
                    }, (error) => {
                        console.error('Plan listener error:', error);
                        stripeLog('loadUserPlan:error', { message: error.message }, 'error');
                    });
            } catch (e) {
                console.error('Failed to setup plan listener:', e);
            }
        }

        // Update UI to show current plan
        function updatePlanDisplay() {
            const badge = document.getElementById('planBadge');
            const upgradeBtn = document.getElementById('upgradeBtn');
            const mobileBadge = document.getElementById('mobilePlanBadge');
            const mobileUpgradeBtn = document.getElementById('mobileUpgradeBtn');
            if (!badge) return;

            if (userPlan.status === 'trialing') {
                badge.textContent = '‚ú® Trial';
                badge.style.background = 'var(--warning)';
                badge.style.display = 'inline-block';
                if (upgradeBtn) {
                    upgradeBtn.textContent = 'Manage';
                    upgradeBtn.onclick = openBillingPortal;
                }
                // Mobile
                if (mobileBadge) {
                    mobileBadge.textContent = '‚ú® Trial';
                    mobileBadge.style.background = 'var(--warning)';
                }
                if (mobileUpgradeBtn) {
                    mobileUpgradeBtn.textContent = 'Manage';
                    mobileUpgradeBtn.onclick = function () { openBillingPortal(); toggleMobileNav(); };
                }
            } else if (hasPaidPlan()) {
                badge.textContent = userPlan.plan === 'unlimited' ? '‚≠ê Unlimited' : '‚≠ê Pro';
                badge.style.background = 'var(--success)';
                badge.style.display = 'inline-block';
                if (upgradeBtn) {
                    upgradeBtn.textContent = 'Manage';
                    upgradeBtn.onclick = openBillingPortal;
                }
                // Mobile
                if (mobileBadge) {
                    mobileBadge.textContent = userPlan.plan === 'unlimited' ? '‚≠ê Unlimited' : '‚≠ê Pro';
                    mobileBadge.style.background = 'var(--success)';
                }
                if (mobileUpgradeBtn) {
                    mobileUpgradeBtn.textContent = 'Manage';
                    mobileUpgradeBtn.onclick = function () { openBillingPortal(); toggleMobileNav(); };
                }
            } else {
                badge.textContent = 'Free';
                badge.style.background = 'var(--text-muted)';
                badge.style.display = 'inline-block';
                if (upgradeBtn) {
                    upgradeBtn.textContent = 'Upgrade';
                    upgradeBtn.onclick = showPricingModal;
                }
                // Mobile
                if (mobileBadge) {
                    mobileBadge.textContent = 'Free';
                    mobileBadge.style.background = 'var(--text-muted)';
                }
                if (mobileUpgradeBtn) {
                    mobileUpgradeBtn.textContent = 'Upgrade';
                    mobileUpgradeBtn.onclick = function () { showPricingModal(); toggleMobileNav(); };
                }
            }
        }

        // ========== STRIPE DEBUG LOGGER ==========
        const STRIPE_DEBUG = true; // Set to false to disable logging

        function stripeLog(action, data = {}, level = 'info') {
            if (!STRIPE_DEBUG) return;

            const timestamp = new Date().toISOString();
            const logEntry = {
                timestamp,
                action,
                ...data
            };

            const style = level === 'error' ? 'color: red; font-weight: bold;'
                : level === 'success' ? 'color: green; font-weight: bold;'
                    : level === 'warn' ? 'color: orange;'
                        : 'color: blue;';

            console.log(`%c[STRIPE ${level.toUpperCase()}] ${action}`, style);
            console.table(logEntry);

            // Store in session for debugging
            const logs = JSON.parse(sessionStorage.getItem('stripe_debug_logs') || '[]');
            logs.push(logEntry);
            if (logs.length > 100) logs.shift(); // Keep last 100 logs
            sessionStorage.setItem('stripe_debug_logs', JSON.stringify(logs));
        }

        function getStripeLogs() {
            return JSON.parse(sessionStorage.getItem('stripe_debug_logs') || '[]');
        }

        function clearStripeLogs() {
            sessionStorage.removeItem('stripe_debug_logs');
            console.log('%c[STRIPE] Logs cleared', 'color: gray;');
        }

        // Make debug functions globally available
        window.stripeDebug = {
            getLogs: getStripeLogs,
            clearLogs: clearStripeLogs,
            showLogs: () => console.table(getStripeLogs())
        };

        // ========== END STRIPE DEBUG LOGGER ==========

        // Open Stripe Billing Portal (for managing subscription)
        async function openBillingPortal() {
            stripeLog('openBillingPortal:start', { userId: currentUser?.uid, subscriptionId: userPlan.subscriptionId });

            if (!currentUser) {
                stripeLog('openBillingPortal:error', { reason: 'No user logged in' }, 'error');
                showLoginModal();
                return;
            }

            if (!userPlan.subscriptionId) {
                stripeLog('openBillingPortal:error', { reason: 'No subscription found' }, 'error');
                toast('No active subscription found', 'error');
                return;
            }

            try {
                stripeLog('openBillingPortal:gettingToken');
                const idToken = await currentUser.getIdToken();
                stripeLog('openBillingPortal:tokenObtained', { tokenLength: idToken.length });

                const url = FUNCTIONS_URLS.getBillingPortal;
                stripeLog('openBillingPortal:callingAPI', { url, subscriptionId: userPlan.subscriptionId });

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        subscriptionId: userPlan.subscriptionId,
                        uid: currentUser.uid
                    })
                });

                stripeLog('openBillingPortal:responseReceived', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });

                const data = await response.json();
                stripeLog('openBillingPortal:dataParsed', {
                    hasUrl: !!data.url,
                    error: data.error || null
                });

                if (data.url) {
                    stripeLog('openBillingPortal:success', { redirectUrl: data.url }, 'success');
                    window.location.href = data.url;
                } else {
                    throw new Error(data.error || 'Failed to open billing portal');
                }
            } catch (error) {
                stripeLog('openBillingPortal:error', {
                    message: error.message,
                    stack: error.stack
                }, 'error');
                console.error('Billing portal error:', error);
                toast('Unable to open billing portal', 'error');
            }
        }

        // Start Stripe Checkout
        async function startCheckout(plan) {
            stripeLog('startCheckout:start', { plan, userId: currentUser?.uid });

            if (!currentUser) {
                stripeLog('startCheckout:error', { reason: 'No user logged in' }, 'error');
                closePricingModal();
                showLoginModal();
                toast('Please sign in first to start your trial', 'error');
                return;
            }

            trackEvent('checkout_started', { plan });

            try {
                // Get current account count for per_account plan
                const accountCount = accounts.length || 1;
                stripeLog('startCheckout:accountCount', { accountCount, plan });

                // Get ID token for authentication
                stripeLog('startCheckout:gettingToken');
                const idToken = await currentUser.getIdToken();
                stripeLog('startCheckout:tokenObtained', {
                    tokenLength: idToken.length,
                    userEmail: currentUser.email
                });

                const url = FUNCTIONS_URLS.createCheckoutSession;
                const body = {
                    plan,
                    accountCount,
                    uid: currentUser.uid,
                    email: currentUser.email
                };
                stripeLog('startCheckout:callingAPI', { url, body });

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify(body)
                });

                stripeLog('startCheckout:responseReceived', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });

                const data = await response.json();
                stripeLog('startCheckout:dataParsed', {
                    hasUrl: !!data.url,
                    error: data.error || null,
                    fullResponse: data
                });

                if (data.url) {
                    stripeLog('startCheckout:success', {
                        redirectUrl: data.url,
                        plan
                    }, 'success');
                    // Redirect to Stripe Checkout
                    window.location.href = data.url;
                } else {
                    throw new Error(data.error || 'Failed to create checkout session');
                }
            } catch (error) {
                stripeLog('startCheckout:error', {
                    message: error.message,
                    stack: error.stack,
                    plan
                }, 'error');
                console.error('Checkout error:', error);
                toast('Unable to start checkout. Please try again.', 'error');
                trackEvent('checkout_error', { plan, error: error.message });
            }
        }

        // Handle successful checkout return
        async function handleCheckoutSuccess() {
            // Wait for auth to initialize if needed
            if (!currentUser) {
                // If called before auth, just return. loadDataFromFirebase will handle it after auth.
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');
            const canceled = urlParams.get('canceled');

            stripeLog('handleCheckoutSuccess:check', {
                sessionId: sessionId || null,
                canceled: canceled || null,
                fullUrl: window.location.href,
                userId: currentUser.uid
            });

            if (canceled) {
                stripeLog('handleCheckoutSuccess:canceled', {}, 'warn');
                toast('Checkout was canceled', 'error');
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }

            if (sessionId) {
                stripeLog('handleCheckoutSuccess:success', { sessionId }, 'success');

                // CRITICAL: Verify and activate the plan BEFORE cleaning URL
                // This writes to Firestore
                await verifyAndActivatePlan(sessionId);

                trackEvent('checkout_success');

                // Clean URL AFTER verification
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // ========== END BILLING FUNCTIONS ==========


        function updateUserDisplay() {
            const display = document.getElementById('userDisplay');
            if (currentUser && currentUser.email) {
                display.innerHTML = `<span style="font-size:12px;color:var(--text-secondary);">${currentUser.email}</span> <button class="btn btn-secondary" style="padding:4px 8px;font-size:11px;" onclick="signOut()">Sign Out</button>`;
            } else if (currentUser) {
                display.innerHTML = `<span style="font-size:12px;color:var(--text-secondary);">Guest</span> <button class="btn btn-secondary" style="padding:4px 8px;font-size:11px;" onclick="signOut()">Sign Out</button>`;
            } else {
                display.innerHTML = `<button class="btn btn-primary" style="padding:4px 8px;font-size:11px;" onclick="showLoginModal()">Sign In</button>`;
            }
        }

        async function signInWithEmail() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) return toast('Enter email and password', 'error');

            try {
                await auth.signInWithEmailAndPassword(email, password);
                toast('Signed in successfully');
            } catch (error) {
                console.error('Sign in error:', error);
                if (error.code === 'auth/user-not-found') {
                    // Create new account
                    try {
                        await auth.createUserWithEmailAndPassword(email, password);
                        toast('Account created and signed in');
                    } catch (createError) {
                        toast(createError.message, 'error');
                    }
                } else {
                    toast(error.message, 'error');
                }
            }
        }

        async function signInWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
                toast('Signed in with Google');
            } catch (error) {
                console.error('Google sign in error:', error);
                toast(error.message, 'error');
            }
        }

        async function signOut() {
            try {
                await auth.signOut();
                currentUser = null;
                accounts = [];
                checks = [];
                currentAcctId = '';
                renderDropdown();
                renderAccounts();
                renderChecks();
                updateUserDisplay();
                toast('Signed out');
            } catch (error) {
                toast(error.message, 'error');
            }
        }

        function continueAsGuest() {
            hideLoginModal();
            loadFromLocalStorage();
            toast('Using local storage (data won\'t sync)');
        }

        // Load data from Firebase
        async function loadDataFromFirebase() {
            try {
                // Load accounts
                const accountsSnap = await db.collection('users').doc(currentUser.uid).collection('accounts').get();
                accounts = accountsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Load checks
                const checksSnap = await db.collection('users').doc(currentUser.uid).collection('checks').orderBy('created', 'desc').get();
                checks = checksSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Load current account selection, calibration, MICR font, and payees
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    currentAcctId = userDoc.data().currentAccountId || '';
                    if (userDoc.data().calibration) {
                        printCalibration = userDoc.data().calibration;
                        localStorage.setItem('cf_calibration', JSON.stringify(printCalibration));
                    }
                    // Load custom MICR font if saved
                    if (userDoc.data().micrFont) {
                        MICR_FONT_BASE64 = userDoc.data().micrFont;
                        micrFontLoaded = false; // Will load on next PDF generation
                        console.log('Loaded custom MICR font from Firestore, size:', MICR_FONT_BASE64.length);
                    }
                    // Load payees
                    if (userDoc.data().payees) {
                        payees = userDoc.data().payees;
                    }
                }

                // If no current account, select default account or first account
                if (!currentAcctId && accounts.length > 0) {
                    const defaultAccount = accounts.find(a => a.isDefault);
                    currentAcctId = defaultAccount ? defaultAccount.id : accounts[0].id;
                    saveCurrentAccountSelection();
                }

                renderDropdown();
                renderAccounts();
                renderChecks();
                populateFilterDropdowns();
                loadDefaults();
                loadCalibration();
                updatePreview();
                updateMICRStatus();

                // Load user plan (subscription status) after loading data
                await loadUserPlan();

                // Check for Stripe checkout return
                const urlParams = new URLSearchParams(window.location.search);
                const sessionId = urlParams.get('session_id');
                if (sessionId) {
                    await verifyAndActivatePlan(sessionId);
                    // Clean URL after verification
                    window.history.replaceState({}, document.title, window.location.pathname);
                }

                toast('Data loaded from cloud');
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                toast('Error loading data', 'error');
                loadFromLocalStorage();
            }
        }

        // Fallback to localStorage
        function loadFromLocalStorage() {
            accounts = JSON.parse(localStorage.getItem('cf_accounts') || '[]');
            checks = JSON.parse(localStorage.getItem('cf_checks') || '[]');
            payees = JSON.parse(localStorage.getItem('cf_payees') || '[]');
            currentAcctId = localStorage.getItem('cf_current') || '';

            // If no current account, select default account or first account
            if (!currentAcctId && accounts.length > 0) {
                const defaultAccount = accounts.find(a => a.isDefault);
                currentAcctId = defaultAccount ? defaultAccount.id : accounts[0].id;
                localStorage.setItem('cf_current', currentAcctId);
            }

            renderDropdown();
            renderAccounts();
            renderChecks();
            populateFilterDropdowns();
            loadDefaults();
            loadCalibration();
            updatePreview();
            updateUserDisplay();
        }

        // Save account to Firebase
        async function saveAccountToFirebase(account) {
            if (!currentUser) return false;
            try {
                await db.collection('users').doc(currentUser.uid).collection('accounts').doc(account.id).set(account);
                return true;
            } catch (error) {
                console.error('Error saving account:', error);
                return false;
            }
        }

        // Delete account from Firebase
        async function deleteAccountFromFirebase(accountId) {
            if (!currentUser) return false;
            try {
                await db.collection('users').doc(currentUser.uid).collection('accounts').doc(accountId).delete();
                return true;
            } catch (error) {
                console.error('Error deleting account:', error);
                return false;
            }
        }

        // Save check to Firebase
        async function saveCheckToFirebase(check) {
            if (!currentUser) return false;
            try {
                await db.collection('users').doc(currentUser.uid).collection('checks').doc(check.id).set(check);
                return true;
            } catch (error) {
                console.error('Error saving check:', error);
                return false;
            }
        }

        // Delete check from Firebase
        async function deleteCheckFromFirebase(checkId) {
            if (!currentUser) return false;
            try {
                await db.collection('users').doc(currentUser.uid).collection('checks').doc(checkId).delete();
                return true;
            } catch (error) {
                console.error('Error deleting check:', error);
                return false;
            }
        }

        // Save current account selection
        async function saveCurrentAccountSelection() {
            if (!currentUser) return;
            try {
                await db.collection('users').doc(currentUser.uid).set({ currentAccountId: currentAcctId }, { merge: true });
            } catch (error) {
                console.error('Error saving selection:', error);
            }
        }

        function initNav() {
            document.querySelectorAll('.nav-item[data-page]').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.dataset.page;
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    item.classList.add('active');
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    document.getElementById('page-' + page).classList.add('active');

                    // Track page view
                    trackEvent('page_view', { page_name: page });
                });
            });
        }

        function initForm() {
            ['checkNumber', 'checkDate', 'payTo', 'amount', 'memo', 'routingNumber', 'accountNumber', 'bankName', 'transitCode', 'issuerName', 'issuerAddress', 'issuerCity', 'issuerState', 'issuerZip', 'payeeAddress', 'payeeCity', 'payeeState', 'payeeZip'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updatePreview);
            });
        }

        // Resize canvas to match displayed size * devicePixelRatio for sharp rendering
        function resizeSignatureCanvas() {
            // OLD FUNCTION - Write Check signature canvas removed
            // Keeping function for backward compatibility but doing nothing
            if (!signatureCanvas) return;
            const canvas = signatureCanvas;
            const rect = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;

            // Set internal pixel buffer to match display size * DPR
            canvas.width = Math.round(rect.width * dpr);
            canvas.height = Math.round(rect.height * dpr);

            sigCtx.setTransform(dpr, 0, 0, dpr, 0, 0); // draw in CSS pixels
            sigCtx.strokeStyle = '#1a1a1a';
            sigCtx.lineWidth = 2;
            sigCtx.lineCap = 'round';
            sigCtx.lineJoin = 'round';
        }

        // Get pointer position in canvas CSS-pixel space
        function getCanvasPoint(e) {
            if (!signatureCanvas) return { x: 0, y: 0 };
            const rect = signatureCanvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        // Signature points buffer for smoothing
        let sigPoints = [];

        function initSignature() {
            // OLD FUNCTION - Write Check signature canvas removed
            // Keeping function for backward compatibility but doing nothing
            signatureCanvas = document.getElementById('signatureCanvas');
            if (!signatureCanvas) return; // Canvas no longer exists, exit gracefully

            sigCtx = signatureCanvas.getContext('2d');

            resizeSignatureCanvas();
            window.addEventListener('resize', resizeSignatureCanvas);
            // Also resize on orientation change (mobile)
            window.addEventListener('orientationchange', () => setTimeout(resizeSignatureCanvas, 100));

            // Use Pointer Events for unified mouse/touch/pen support
            signatureCanvas.addEventListener('pointerdown', e => {
                signatureCanvas.setPointerCapture(e.pointerId);
                isDrawing = true;
                sigPoints = [];
                const p = getCanvasPoint(e);
                sigPoints.push(p);
                lastX = p.x;
                lastY = p.y;
            });

            signatureCanvas.addEventListener('pointermove', e => {
                if (!isDrawing) return;
                const p = getCanvasPoint(e);
                sigPoints.push(p);

                // Use quadratic curve smoothing for smoother lines
                if (sigPoints.length >= 3) {
                    const len = sigPoints.length;
                    const p0 = sigPoints[len - 3];
                    const p1 = sigPoints[len - 2];
                    const p2 = sigPoints[len - 1];

                    // Calculate midpoints for smooth curve
                    const mid1 = { x: (p0.x + p1.x) / 2, y: (p0.y + p1.y) / 2 };
                    const mid2 = { x: (p1.x + p2.x) / 2, y: (p1.y + p2.y) / 2 };

                    sigCtx.beginPath();
                    sigCtx.moveTo(mid1.x, mid1.y);
                    sigCtx.quadraticCurveTo(p1.x, p1.y, mid2.x, mid2.y);
                    sigCtx.stroke();
                } else if (sigPoints.length === 2) {
                    // First segment - just draw a line
                    sigCtx.beginPath();
                    sigCtx.moveTo(lastX, lastY);
                    sigCtx.lineTo(p.x, p.y);
                    sigCtx.stroke();
                }

                lastX = p.x;
                lastY = p.y;
            });

            signatureCanvas.addEventListener('pointerup', () => {
                isDrawing = false;
                sigPoints = [];
            });
            signatureCanvas.addEventListener('pointercancel', () => {
                isDrawing = false;
                sigPoints = [];
            });

            // Prevent touch scrolling on canvas
            signatureCanvas.style.touchAction = 'none';
        }


        // OLD FUNCTIONS - Write Check signature canvas removed
        // Keeping for backward compatibility
        function clearSignature() {
            if (!signatureCanvas) return; // Canvas no longer exists
            resizeSignatureCanvas(); // Reset canvas and clear
            currentSig = ''; // Clear the saved signature
            updatePreview(); // Update preview to remove signature
            toast('Signature cleared');
        }
        function applySignature() {
            if (!signatureCanvas) return; // Canvas no longer exists
            currentSig = signatureCanvas.toDataURL();
            updatePreview();
            toast('Signature applied');
        }
        function switchSignatureMode(mode, ev) {
            // OLD FUNCTION - Write Check signature tabs removed
            // Use switchAccountSigMode() for account modal instead
            if (!document.getElementById('signatureDrawMode')) return; // Elements no longer exist
            document.querySelectorAll('.signature-tab').forEach(t => t.classList.remove('active'));
            if (ev && ev.target) ev.target.classList.add('active');
            document.getElementById('signatureDrawMode').style.display = mode === 'draw' ? 'block' : 'none';
            document.getElementById('signatureUploadMode').style.display = mode === 'upload' ? 'block' : 'none';
            // Resize canvas when switching to draw mode (hidden tabs report wrong sizes)
            if (mode === 'draw') setTimeout(resizeSignatureCanvas, 50);
        }
        function handleSigUpload(e) {
            // OLD FUNCTION - Write Check signature upload removed
            const file = e.target.files[0]; if (!file) return;
            const previewEl = document.getElementById('sigUploadPreview');
            if (!previewEl) return; // Element no longer exists
            const reader = new FileReader();
            reader.onload = ev => {
                currentSig = ev.target.result;
                previewEl.src = currentSig;
                previewEl.style.display = 'block';
                updatePreview();
                toast('Signature uploaded');
            };
            reader.readAsDataURL(file);
        }

        function setToday() {
            // Use EST timezone
            const now = new Date();
            const estDate = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            const year = estDate.getFullYear();
            const month = String(estDate.getMonth() + 1).padStart(2, '0');
            const day = String(estDate.getDate()).padStart(2, '0');
            document.getElementById('checkDate').value = `${year}-${month}-${day}`;
        }

        function loadDefaults() {
            const a = accounts.find(x => x.id === currentAcctId);
            if (a) {
                // CRITICAL FIX: Use NEXT available check number, not last used!
                document.getElementById('checkNumber').value = getNextAvailableCheckNo(currentAcctId);
                document.getElementById('routingNumber').value = a.routing || '';
                document.getElementById('accountNumber').value = a.account || '';
                document.getElementById('bankName').value = a.bank || '';
                document.getElementById('transitCode').value = a.transit || '';
                document.getElementById('issuerName').value = a.name || '';
                document.getElementById('issuerAddress').value = a.addr || '';
                document.getElementById('issuerCity').value = a.city || '';
                document.getElementById('issuerState').value = a.state || '';
                document.getElementById('issuerZip').value = a.zip || '';

                // Load account signature if available
                if (a.signature) {
                    currentSig = a.signature;
                    // Update signature status
                    document.getElementById('sigStatusIcon').textContent = '‚úÖ';
                    document.getElementById('sigStatusText').textContent = `Signature loaded from ${a.nickname}`;
                    document.getElementById('signatureStatus').style.background = '#dcfce7';
                    document.getElementById('signatureStatus').style.color = '#16a34a';
                } else {
                    currentSig = '';
                    // Update signature status
                    document.getElementById('sigStatusIcon').textContent = '‚ö†Ô∏è';
                    document.getElementById('sigStatusText').textContent = `No signature saved for ${a.nickname}. Add one in Accounts.`;
                    document.getElementById('signatureStatus').style.background = '#fef3c7';
                    document.getElementById('signatureStatus').style.color = '#92400e';
                }
            } else {
                // No account selected
                document.getElementById('sigStatusIcon').textContent = '‚ÑπÔ∏è';
                document.getElementById('sigStatusText').textContent = 'Select an account to load signature';
                document.getElementById('signatureStatus').style.background = 'var(--bg)';
                document.getElementById('signatureStatus').style.color = 'var(--text-secondary)';
            }

            // CRITICAL FIX: Clear ALL transaction fields for fresh check
            document.getElementById('payTo').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('memo').value = '';
            document.getElementById('payeeAddress').value = '';
            document.getElementById('payeeCity').value = '';
            document.getElementById('payeeState').value = '';
            document.getElementById('payeeZip').value = '';

            // Reset editing state
            editingCheckId = null;

            // Set today's date
            setToday();

            // Update preview
            updatePreview();
        }

        function updatePreview() {
            const name = document.getElementById('issuerName').value || 'Your Name';
            const addr = document.getElementById('issuerAddress').value || '123 Main Street';
            const city = document.getElementById('issuerCity').value || 'City';
            const state = document.getElementById('issuerState').value || 'ST';
            const zip = document.getElementById('issuerZip').value || '12345';
            document.getElementById('previewIssuerName').textContent = name;
            document.getElementById('previewIssuerAddress').textContent = addr;
            document.getElementById('previewIssuerCity').textContent = `${city}, ${state} ${zip}`;
            document.getElementById('previewBankName').textContent = document.getElementById('bankName').value || 'Bank Name';
            document.getElementById('previewBankCode').textContent = document.getElementById('transitCode').value || '';
            document.getElementById('previewCheckNo').textContent = document.getElementById('checkNumber').value || '1001';
            const d = document.getElementById('checkDate').value;
            document.getElementById('previewDate').textContent = d ? new Date(d + 'T00:00:00').toLocaleDateString() : '';
            document.getElementById('previewPayee').textContent = document.getElementById('payTo').value || '';

            // Build payee address for preview
            const payeeAddr = document.getElementById('payeeAddress')?.value || '';
            const payeeCity = document.getElementById('payeeCity')?.value || '';
            const payeeState = document.getElementById('payeeState')?.value || '';
            const payeeZip = document.getElementById('payeeZip')?.value || '';
            let payeeAddressLine = '';
            if (payeeAddr) payeeAddressLine += payeeAddr;
            if (payeeCity || payeeState || payeeZip) {
                if (payeeAddressLine) payeeAddressLine += ', ';
                payeeAddressLine += [payeeCity, payeeState, payeeZip].filter(Boolean).join(' ');
            }
            document.getElementById('previewPayeeAddress').textContent = payeeAddressLine;

            const amt = parseFloat(document.getElementById('amount').value) || 0;
            document.getElementById('previewAmount').textContent = formatCurrency(amt);
            document.getElementById('previewWrittenAmount').textContent = amt > 0 ? toWords(amt) : '';
            document.getElementById('previewMemo').textContent = document.getElementById('memo').value || '';

            // Show signature in preview only if checkbox is checked
            const sig = document.getElementById('previewSignature');
            const includeSignature = document.getElementById('includeSignature')?.checked;
            if (currentSig && includeSignature) {
                sig.src = currentSig;
                sig.style.display = 'block';
            } else {
                sig.style.display = 'none';
            }

            const rt = (document.getElementById('routingNumber').value || '000000000').padStart(9, '0');
            const ac = document.getElementById('accountNumber').value || '000000000';
            const cn = document.getElementById('checkNumber').value || '1001';
            // Format MICR for preview display - using MICR Unicode symbols for realistic look
            const micr = formatMICR(cn, rt, ac);
            // Format: ‚ëàcheckNo‚ëà  ‚ëÜrouting‚ëÜ  account‚ëà
            document.getElementById('previewMicr').textContent = `‚ëà${micr.checkNo}‚ëà  ‚ëÜ${micr.routing}‚ëÜ  ${micr.account}‚ëà`;
        }

        // Format currency with thousand separators: 1234567.89 ‚Üí "1,234,567.89"
        function formatCurrency(amount, includeSymbol = false) {
            const formatted = amount.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            return includeSymbol ? '$' + formatted : formatted;
        }

        function toWords(n) {
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            const scales = ['', 'Thousand', 'Million', 'Billion', 'Trillion', 'Quadrillion'];

            const dollars = Math.floor(n), cents = Math.round((n - dollars) * 100);

            // Handle 0-999
            function convertHundreds(x) {
                if (x === 0) return '';
                if (x < 20) return ones[x];
                if (x < 100) return tens[Math.floor(x / 10)] + (x % 10 ? '-' + ones[x % 10] : '');
                return ones[Math.floor(x / 100)] + ' Hundred' + (x % 100 ? ' ' + convertHundreds(x % 100) : '');
            }

            // Convert full number using scale groups
            function convert(x) {
                if (x === 0) return 'Zero';

                let result = '';
                let scaleIndex = 0;

                while (x > 0) {
                    const chunk = x % 1000;
                    if (chunk > 0) {
                        const chunkWords = convertHundreds(chunk);
                        const scale = scales[scaleIndex];
                        result = chunkWords + (scale ? ' ' + scale : '') + (result ? ' ' + result : '');
                    }
                    x = Math.floor(x / 1000);
                    scaleIndex++;
                }

                return result.trim();
            }

            return convert(dollars) + ' and ' + cents.toString().padStart(2, '0') + '/100';
        }

        function clearCheck() {
            // Clear transaction fields but advance check number to next available
            ['payTo', 'amount', 'memo', 'payeeAddress', 'payeeCity', 'payeeState', 'payeeZip'].forEach(id => document.getElementById(id).value = '');

            // Advance to next available check number (don't clear it!)
            document.getElementById('checkNumber').value = getNextAvailableCheckNo(currentAcctId);

            setToday();
            // Note: Signature is managed by account, not individual check
            // currentSig remains loaded from account
            editingCheckId = null; // Reset editing state
            updatePreview();
        }

        // Clear only transaction fields (payee, amount, memo) - keep account info
        function clearTransactionFields() {
            document.getElementById('payTo').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('memo').value = '';
            document.getElementById('payeeAddress').value = '';
            document.getElementById('payeeCity').value = '';
            document.getElementById('payeeState').value = '';
            document.getElementById('payeeZip').value = '';
            editingCheckId = null; // Reset editing state
            setToday();
            updatePreview();
        }

        // Check for duplicate check numbers within same account
        function isDuplicateCheckNo(checkNo, accountId) {
            return checks.some(c =>
                c.checkNo === checkNo &&
                c.accountId === accountId &&
                c.id !== editingCheckId  // Exclude the check being edited
            );
        }

        // Get next available check number for an account
        function getNextAvailableCheckNo(accountId) {
            // Get all check numbers for this account
            const accountChecks = checks
                .filter(c => c.accountId === accountId && c.id !== editingCheckId)
                .map(c => parseInt(c.checkNo))
                .filter(n => !isNaN(n))
                .sort((a, b) => b - a); // Sort descending

            // If no checks exist, start from account's checkNo or 1001
            if (accountChecks.length === 0) {
                const acct = accounts.find(a => a.id === accountId);
                return acct?.checkNo || 1001;
            }

            // Return highest + 1
            return accountChecks[0] + 1;
        }

        // Save payee to directory with address and intelligence
        async function savePayee(name, amount = null, memo = null, address = null) {
            if (!name || name.trim().length < 2) return;
            const normalized = name.trim();

            // Get current address from form
            const currentAddress = address || {
                street: document.getElementById('payeeAddress')?.value?.trim() || '',
                city: document.getElementById('payeeCity')?.value?.trim() || '',
                state: document.getElementById('payeeState')?.value?.trim() || '',
                zip: document.getElementById('payeeZip')?.value?.trim() || ''
            };

            const existing = payees.find(p => p.name.toLowerCase() === normalized.toLowerCase());
            if (existing) {
                existing.lastUsed = new Date().toISOString();
                existing.useCount = (existing.useCount || 0) + 1;
                if (amount) existing.lastAmount = amount;
                if (memo) existing.defaultMemo = memo;
                if (currentAcctId) existing.lastAccountId = currentAcctId;
                // Update address if provided
                if (currentAddress.street || currentAddress.city) {
                    existing.address = currentAddress;
                }
            } else {
                payees.push({
                    id: Date.now().toString(),
                    name: normalized,
                    lastUsed: new Date().toISOString(),
                    useCount: 1,
                    lastAmount: amount || null,
                    defaultMemo: memo || '',
                    lastAccountId: currentAcctId || null,
                    address: currentAddress
                });
            }
            // Save to Firebase
            if (currentUser) {
                try {
                    await db.collection('users').doc(currentUser.uid).set({ payees }, { merge: true });
                } catch (e) { console.error('Payee save error:', e); }
            }
            localStorage.setItem('cf_payees', JSON.stringify(payees));
        }

        // Show payee suggestions with intelligence
        function showPayeeSuggestions(query) {
            const container = document.getElementById('payeeSuggestions');
            if (!query || query.length < 1) {
                // Show recent payees when empty
                if (payees.length > 0) {
                    const recent = [...payees].sort((a, b) => new Date(b.lastUsed) - new Date(a.lastUsed)).slice(0, 5);
                    container.innerHTML = `
                        <div style="padding:6px 12px;font-size:11px;color:#888;background:#f9f9f9;border-bottom:1px solid #eee;">Recent Payees</div>
                        ${recent.map(p => renderPayeeSuggestion(p)).join('')}
                        <div style="padding:8px 12px;text-align:center;border-top:1px solid #eee;">
                            <a href="#" onclick="event.preventDefault();openPayeeDirectory();" style="font-size:11px;color:var(--accent);">View All Payees ‚Üí</a>
                        </div>
                    `;
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
                return;
            }
            const matches = payees.filter(p => p.name.toLowerCase().includes(query.toLowerCase())).slice(0, 8);
            if (!matches.length) {
                // Show "Add new payee" option
                container.innerHTML = `
                    <div style="padding:10px 12px;color:#666;font-size:12px;">
                        No matching payees found.<br>
                        <span style="color:var(--text-muted);font-size:11px;">Press Enter to use "${query}" as new payee</span>
                    </div>
                `;
                container.style.display = 'block';
                return;
            }
            container.innerHTML = matches.map(p => renderPayeeSuggestion(p)).join('');
            container.style.display = 'block';
        }

        // Render a single payee suggestion item
        function renderPayeeSuggestion(p) {
            const hasAddress = p.address && (p.address.street || p.address.city);
            const addressPreview = hasAddress ? `${p.address.city || ''}, ${p.address.state || ''}`.replace(/^, |, $/g, '') : '';
            const totalPaid = getPayeeTotalPaid(p.name);

            return `<div style="padding:8px 12px;cursor:pointer;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;" 
                     onmouseover="this.style.background='#f5f5f5'" 
                     onmouseout="this.style.background='#fff'"
                     onclick="selectPayee('${p.name.replace(/'/g, "\\'")}')">
                    <div style="flex:1;">
                        <div style="font-weight:500;">${p.name}</div>
                        <div style="font-size:11px;color:#888;">${addressPreview || 'No address saved'}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:11px;color:#666;">${p.useCount || 1} check${(p.useCount || 1) > 1 ? 's' : ''}</div>
                        <div style="font-size:10px;color:#888;">${totalPaid > 0 ? formatCurrency(totalPaid, true) : ''}</div>
                    </div>
                    <button onclick="event.stopPropagation();openPayeeProfile('${p.name.replace(/'/g, "\\'")}')" 
                            style="margin-left:8px;padding:4px 8px;font-size:10px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;cursor:pointer;"
                            title="View payee history">üìã</button>
                </div>`;
        }

        // Get total paid to a payee
        function getPayeeTotalPaid(payeeName, startDate = null, endDate = null) {
            return checks
                .filter(c => c.payTo.toLowerCase() === payeeName.toLowerCase() &&
                    c.status !== 'voided' &&
                    (!startDate || c.date >= startDate) &&
                    (!endDate || c.date <= endDate))
                .reduce((sum, c) => sum + (c.amount || 0), 0);
        }

        function selectPayee(name) {
            document.getElementById('payTo').value = name;
            document.getElementById('payeeSuggestions').style.display = 'none';

            // Find payee and auto-fill fields
            const payee = payees.find(p => p.name.toLowerCase() === name.toLowerCase());
            if (payee) {
                // Auto-fill address if available
                if (payee.address) {
                    document.getElementById('payeeAddress').value = payee.address.street || '';
                    document.getElementById('payeeCity').value = payee.address.city || '';
                    document.getElementById('payeeState').value = payee.address.state || '';
                    document.getElementById('payeeZip').value = payee.address.zip || '';
                }

                // Auto-fill default memo if empty
                const memoField = document.getElementById('memo');
                if (payee.defaultMemo && !memoField.value) {
                    memoField.value = payee.defaultMemo;
                }

                // Suggest last amount if amount is empty
                const amountField = document.getElementById('amount');
                if (payee.lastAmount && !amountField.value) {
                    if (confirm(`Use last amount for ${name}?\n$${payee.lastAmount.toFixed(2)}`)) {
                        amountField.value = payee.lastAmount;
                    }
                }
            }

            updatePreview();
        }

        // Hide suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#payTo') && !e.target.closest('#payeeSuggestions')) {
                const container = document.getElementById('payeeSuggestions');
                if (container) container.style.display = 'none';
            }
        });

        // Core save function
        async function saveCheck(status = 'saved', advanceToNext = false) {
            const payTo = document.getElementById('payTo').value.trim();
            const amt = parseFloat(document.getElementById('amount').value);
            const rt = document.getElementById('routingNumber').value.trim();
            const ac = document.getElementById('accountNumber').value.trim();

            // Enhanced bank-ready validations
            const validationErrors = [];
            if (!payTo) validationErrors.push('Payee name is required');
            if (!amt || amt <= 0) validationErrors.push('Amount must be greater than 0');
            if (!rt) validationErrors.push('Routing number is required');
            if (rt && rt.length !== 9) validationErrors.push('Routing number must be exactly 9 digits');
            if (rt && !/^\d{9}$/.test(rt)) validationErrors.push('Routing number must contain only digits');
            if (!ac) validationErrors.push('Account number is required');

            if (validationErrors.length > 0) {
                toast(validationErrors.join('<br>'), 'error');
                return;
            }

            const cn = document.getElementById('checkNumber').value || '1001';

            // Duplicate check number handling
            if (isDuplicateCheckNo(cn, currentAcctId)) {
                if (editingCheckId) {
                    // EDITING: Warn about overriding existing check
                    const existingCheck = checks.find(c => c.checkNo === cn && c.accountId === currentAcctId && c.id !== editingCheckId);
                    if (existingCheck) {
                        if (!confirm(`‚ö†Ô∏è WARNING: Check #${cn} already exists!\n\nYou are overriding an existing ${existingCheck.status} check to ${existingCheck.payTo} for ${formatCurrency(existingCheck.amount, true)}.\n\nAre you sure you want to use this check number?`)) {
                            return;
                        }
                    }
                } else {
                    // CREATING NEW: Block and auto-increment to next available
                    const nextAvailable = getNextAvailableCheckNo(currentAcctId);
                    document.getElementById('checkNumber').value = nextAvailable;
                    toast(`Check #${cn} already exists. Auto-advanced to #${nextAvailable}`, 'warning');
                    return; // Stop and let user review the new number
                }
            }

            // Check for anomalies (duplicate payments, gaps, large amounts) - only for new checks
            if (!editingCheckId) {
                const warnings = checkForAnomalies(payTo, amt, cn);
                if (warnings.length > 0) {
                    const proceed = confirm(warnings.join('\n\n') + '\n\nProceed anyway?');
                    if (!proceed) return;
                }
            }

            const memo = document.getElementById('memo').value.trim();

            // Check if we're editing an existing check
            if (editingCheckId) {
                // Update existing check
                const existingCheck = checks.find(c => c.id === editingCheckId);
                if (existingCheck) {
                    existingCheck.checkNo = cn;
                    existingCheck.date = document.getElementById('checkDate').value;
                    existingCheck.payTo = payTo;
                    existingCheck.amount = amt;
                    existingCheck.memo = memo;
                    existingCheck.routing = rt;
                    existingCheck.account = ac;
                    existingCheck.accountId = currentAcctId;
                    existingCheck.bank = document.getElementById('bankName').value.trim();
                    existingCheck.transit = document.getElementById('transitCode').value.trim();
                    existingCheck.issuerName = document.getElementById('issuerName').value.trim();
                    existingCheck.issuerAddr = document.getElementById('issuerAddress').value.trim();
                    existingCheck.issuerCity = document.getElementById('issuerCity').value.trim();
                    existingCheck.issuerState = document.getElementById('issuerState').value.trim();
                    existingCheck.issuerZip = document.getElementById('issuerZip').value.trim();
                    existingCheck.payeeAddr = document.getElementById('payeeAddress').value.trim();
                    existingCheck.payeeCity = document.getElementById('payeeCity').value.trim();
                    existingCheck.payeeState = document.getElementById('payeeState').value.trim();
                    existingCheck.payeeZip = document.getElementById('payeeZip').value.trim();
                    existingCheck.signature = currentSig;
                    existingCheck.status = status;
                    existingCheck.updated = new Date().toISOString();

                    // Save to Firebase
                    const saved = await saveCheckToFirebase(existingCheck);
                    if (!saved) {
                        localStorage.setItem('cf_checks', JSON.stringify(checks));
                    }

                    // Update account's next check number to next available
                    const acct = accounts.find(a => a.id === currentAcctId);
                    if (acct) {
                        acct.checkNo = getNextAvailableCheckNo(currentAcctId);
                        await saveAccountToFirebase(acct);
                    }

                    // Clear editing state
                    editingCheckId = null;

                    renderChecks();
                    populateFilterDropdowns();

                    // Enhanced success message for Save & Next
                    if (advanceToNext) {
                        showSuccessToast(`‚úì Saved Check #${cn}`, cn);

                        // Increment check number in UI
                        document.getElementById('checkNumber').value = getNextAvailableCheckNo(currentAcctId);

                        // Clear transaction fields and set focus
                        clearTransactionFields();
                        document.getElementById('payTo').focus();
                    } else {
                        toast(saved ? `Check #${cn} updated in cloud` : `Check #${cn} updated locally`);
                    }
                    return;
                }
            }

            // Creating new check
            const check = {
                id: Date.now().toString(),
                checkNo: cn,
                date: document.getElementById('checkDate').value,
                payTo,
                amount: amt,
                memo: memo,
                routing: rt,
                account: ac,
                accountId: currentAcctId, // Link to account!
                bank: document.getElementById('bankName').value.trim(),
                transit: document.getElementById('transitCode').value.trim(),
                issuerName: document.getElementById('issuerName').value.trim(),
                issuerAddr: document.getElementById('issuerAddress').value.trim(),
                issuerCity: document.getElementById('issuerCity').value.trim(),
                issuerState: document.getElementById('issuerState').value.trim(),
                issuerZip: document.getElementById('issuerZip').value.trim(),
                payeeAddr: document.getElementById('payeeAddress').value.trim(),
                payeeCity: document.getElementById('payeeCity').value.trim(),
                payeeState: document.getElementById('payeeState').value.trim(),
                payeeZip: document.getElementById('payeeZip').value.trim(),
                signature: currentSig,
                status: status,
                created: new Date().toISOString(),
                printCount: 0,
                printedAt: null,
                printedBy: null
            };
            checks.push(check);

            // Save payee to directory with intelligence
            await savePayee(payTo, amt, memo);

            // Update account's next check number to next available
            const acct = accounts.find(a => a.id === currentAcctId);
            if (acct) {
                acct.checkNo = getNextAvailableCheckNo(currentAcctId);
                await saveAccountToFirebase(acct);
            }

            // Save to Firebase
            const saved = await saveCheckToFirebase(check);
            if (!saved) {
                localStorage.setItem('cf_checks', JSON.stringify(checks));
            }

            renderChecks();
            populateFilterDropdowns();

            // Track check saved event
            trackEvent('check_saved', {
                status: status,
                amount_range: amt < 100 ? 'under_100' : amt < 1000 ? '100_to_1000' : amt < 10000 ? '1000_to_10000' : 'over_10000',
                saved_to: saved ? 'cloud' : 'local'
            });

            // Enhanced Save & Next workflow
            if (advanceToNext) {
                // Show success toast with undo option
                showSuccessToast(`‚úì Saved Check #${cn}`, check.id);

                // Increment check number in UI
                document.getElementById('checkNumber').value = getNextAvailableCheckNo(currentAcctId);

                // Clear transaction fields and set focus
                clearTransactionFields();
                document.getElementById('payTo').focus();
            } else {
                toast(saved ? `Check #${cn} saved to cloud` : `Check #${cn} saved locally`);
            }
        }

        // Save & Next button handler (SOFT-GATED)
        async function saveCheckAndNext() {
            if (!requirePaidPlan('save_check')) return;
            await saveCheck('saved', true);
        }

        // Enhanced success toast with undo capability
        let undoCheckId = null;
        let undoTimeout = null;
        function showSuccessToast(message, checkId) {
            // Clear any existing undo timeout
            if (undoTimeout) {
                clearTimeout(undoTimeout);
            }

            undoCheckId = checkId;

            // Create enhanced toast with undo button
            const toastHtml = `
                <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
                    <span>${message}</span>
                    <button onclick="undoLastSave()" style="padding:4px 12px;background:#fff;color:#43a047;border:none;border-radius:4px;cursor:pointer;font-weight:600;">Undo</button>
                </div>
            `;

            toast(toastHtml, 'success', 10000); // Show for 10 seconds

            // Clear undo option after 10 seconds
            undoTimeout = setTimeout(() => {
                undoCheckId = null;
            }, 10000);
        }

        // Undo last saved check
        async function undoLastSave() {
            if (!undoCheckId) {
                toast('Nothing to undo', 'error');
                return;
            }

            const checkIndex = checks.findIndex(c => c.id === undoCheckId);
            if (checkIndex === -1) {
                toast('Check not found', 'error');
                return;
            }

            const check = checks[checkIndex];
            const checkNo = check.checkNo;

            // Remove from array
            checks.splice(checkIndex, 1);

            // Delete from Firebase
            if (currentUser) {
                const db = getFirestore();
                try {
                    await deleteDoc(doc(db, 'users', currentUser.uid, 'checks', undoCheckId));
                } catch (e) {
                    console.log('Error deleting from Firebase:', e);
                }
            }

            // Save to localStorage
            localStorage.setItem('cf_checks', JSON.stringify(checks));

            // Reload check into form
            document.getElementById('checkNumber').value = checkNo;
            document.getElementById('payTo').value = check.payTo;
            document.getElementById('amount').value = check.amount;
            document.getElementById('memo').value = check.memo || '';
            document.getElementById('payeeAddress').value = check.payeeAddr || '';
            document.getElementById('payeeCity').value = check.payeeCity || '';
            document.getElementById('payeeState').value = check.payeeState || '';
            document.getElementById('payeeZip').value = check.payeeZip || '';

            // Clear undo state
            undoCheckId = null;
            if (undoTimeout) {
                clearTimeout(undoTimeout);
                undoTimeout = null;
            }

            renderChecks();
            updatePreview();

            toast(`‚úì Restored Check #${checkNo}`, 'success');
        }

        // Save Draft button handler (SOFT-GATED)
        async function saveCheckDraft() {
            if (!requirePaidPlan('save_check')) return;
            await saveCheck('draft', false);
        }

        // Update check status to printed
        async function markCheckPrinted(checkNo, routing, account) {
            const check = checks.find(c =>
                c.checkNo === checkNo &&
                c.routing === routing &&
                c.account === account
            );
            if (check) {
                check.status = 'printed';
                check.printCount = (check.printCount || 0) + 1;
                check.printedAt = new Date().toISOString();
                check.printedBy = currentUser?.email || 'local';

                await saveCheckToFirebase(check);
                localStorage.setItem('cf_checks', JSON.stringify(checks));
                renderChecks();
            }
        }

        // Void a check
        async function voidCheck(checkId) {
            const check = checks.find(c => c.id === checkId);
            if (!check) return;

            const reason = prompt('Reason for voiding (optional):');
            if (reason === null) return; // Cancelled

            check.status = 'voided';
            check.voidedAt = new Date().toISOString();
            check.voidedBy = currentUser?.email || 'local';
            check.voidReason = reason || '';

            await saveCheckToFirebase(check);
            localStorage.setItem('cf_checks', JSON.stringify(checks));
            renderChecks();

            // Track void event
            trackEvent('check_voided', { had_reason: !!reason });

            toast(`Check #${check.checkNo} voided`);
        }

        // Mark check as cleared (for reconciliation)
        async function markCheckCleared(checkId) {
            const check = checks.find(c => c.id === checkId);
            if (!check) return;

            check.status = 'cleared';
            check.clearedAt = new Date().toISOString();
            check.clearedBy = currentUser?.email || 'local';

            await saveCheckToFirebase(check);
            localStorage.setItem('cf_checks', JSON.stringify(checks));
            renderChecks();
            toast(`Check #${check.checkNo} marked as cleared`);
        }

        // Unclear a check (reverse cleared status)
        async function unclearCheck(checkId) {
            const check = checks.find(c => c.id === checkId);
            if (!check) return;

            // Confirmation dialog
            if (!confirm(`Are you sure you want to mark Check #${check.checkNo} as uncleared?\n\nThis will change its status back to "printed".`)) {
                return;
            }

            check.status = 'printed';
            delete check.clearedAt;
            delete check.clearedBy;

            await saveCheckToFirebase(check);
            localStorage.setItem('cf_checks', JSON.stringify(checks));
            renderChecks();
            toast(`Check #${check.checkNo} marked as uncleared`);
        }

        // Print selected checks from history
        async function printSelected() {
            const selectedIds = Array.from(document.querySelectorAll('.chkSel:checked')).map(cb => cb.dataset.id);
            if (!selectedIds.length) return toast('Select checks to print', 'error');

            const selectedChecks = checks.filter(c => selectedIds.includes(c.id));
            if (!selectedChecks.length) return toast('No checks found', 'error');

            if (!confirm(`Print ${selectedChecks.length} selected check(s)?`)) return;

            // Get calibration settings - USE CORRECT KEYS (offsetX/offsetY, not hoffset/voffset)
            const calibration = JSON.parse(localStorage.getItem('cf_calibration') || '{}');
            const offsetX = (calibration.offsetX || 0) * 72; // Convert inches to points
            const offsetY = (calibration.offsetY || 0) * 72;
            const checkHeight = (parseFloat(document.getElementById('checkHeight')?.value) || 3.5) * 72;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });

            // Helper: Convert inches to points (1 inch = 72 points)
            const inch = (i) => i * 72;

            // Apply calibration offset + empirical Y-correction from print testing
            const offsetXPt = offsetX;
            const offsetYPt = offsetY + inch(0.09); // Add 0.09" DOWN (empirical correction)
            const micrOffsetYPt = offsetY + inch(0.25); // MICR-specific offset

            for (let i = 0; i < selectedChecks.length; i++) {
                const c = selectedChecks[i];

                if (i > 0) pdf.addPage();

                // Get check data
                const checkNo = c.checkNo || '1001';
                const payTo = c.payTo || '';
                const amount = c.amount || 0;
                const memo = c.memo || '';
                const dateStr = c.date ? new Date(c.date + 'T00:00:00').toLocaleDateString() : '';
                const issuerName = c.issuerName || '';
                const issuerAddr = c.issuerAddr || '';
                const issuerCity = c.issuerCity || '';
                const issuerState = c.issuerState || '';
                const issuerZip = c.issuerZip || '';
                const cityLine = `${issuerCity}${issuerState ? ', ' + issuerState : ''}${issuerZip ? ' ' + issuerZip : ''}`;
                const bankName = c.bank || '';
                const transit = c.transit || '';
                const rt = (c.routing || '000000000').padStart(9, '0');
                const ac = c.account || '000000000';

                // Payee address
                const payeeAddr = c.payeeAddr || '';
                const payeeCity = c.payeeCity || '';
                const payeeState = c.payeeState || '';
                const payeeZip = c.payeeZip || '';
                const payeeCityLine = `${payeeCity}${payeeState ? ', ' + payeeState : ''}${payeeZip ? ' ' + payeeZip : ''}`;

                // MICR line
                const micrLine = formatMICR(checkNo, rt, ac);

                // ========== CHECK SECTION - EXACT TEMPLATE MEASUREMENTS ==========

                // === ISSUER INFO (Centered Block) ===
                const issuerCenterX = inch(2.2) + offsetXPt;

                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(12);
                pdf.text(issuerName, issuerCenterX, inch(0.376) + offsetYPt, { align: 'center' });

                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(9);
                pdf.text(issuerAddr, issuerCenterX, inch(0.534) + offsetYPt, { align: 'center' });
                pdf.text(cityLine, issuerCenterX, inch(0.658) + offsetYPt, { align: 'center' });

                // === BANK NAME ===
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(10);
                pdf.text(bankName, inch(5.037) + offsetXPt, inch(0.453) + offsetYPt);

                if (transit) {
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(8);
                    pdf.setTextColor(100);
                    pdf.text(transit, inch(5.037) + offsetXPt, inch(0.580) + offsetYPt);
                    pdf.setTextColor(0);
                }

                // === CHECK NUMBER ===
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(14);
                pdf.text(checkNo, inch(7.518) + offsetXPt, inch(0.329) + 10 + offsetYPt);

                // === DATE ===
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(8);
                pdf.text('DATE', inch(6.492) + offsetXPt, inch(0.981) + offsetYPt);
                pdf.setLineWidth(inch(0.0136));
                pdf.line(inch(6.797) + offsetXPt, inch(1.118) + offsetYPt, inch(8.090) + offsetXPt, inch(1.118) + offsetYPt);
                pdf.setLineWidth(1);
                pdf.setFontSize(11);
                pdf.text(dateStr, inch(7.44) + offsetXPt, inch(1.09) + offsetYPt, { align: 'center' });

                // === PAY TO THE ORDER OF ===
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(8);
                pdf.text('PAY TO THE', inch(0.258) + offsetXPt, inch(1.355) + offsetYPt);
                pdf.text('ORDER OF', inch(0.258) + offsetXPt, inch(1.486) + offsetYPt);

                pdf.setFontSize(11);
                pdf.text(payTo, inch(0.950) + offsetXPt, inch(1.530) + offsetYPt);

                pdf.setLineWidth(inch(0.0136));
                pdf.line(inch(0.789) + offsetXPt, inch(1.618) + offsetYPt, inch(6.605) + offsetXPt, inch(1.618) + offsetYPt);
                pdf.setLineWidth(1);

                // Vertical separator
                pdf.setLineWidth(inch(0.0137));
                pdf.line(inch(6.623) + offsetXPt, inch(1.535) + offsetYPt, inch(6.623) + offsetXPt, inch(1.625) + offsetYPt);
                pdf.setLineWidth(1);

                // === AMOUNT BOX ===
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(12);
                pdf.text('$', inch(6.766) + offsetXPt, inch(1.405) + 9 + offsetYPt);
                pdf.rect(inch(6.75) + offsetXPt, inch(1.35) + offsetYPt, inch(1.35), inch(0.30));
                pdf.text(formatCurrency(amount), inch(8.05) + offsetXPt, inch(1.405) + 9 + offsetYPt, { align: 'right' });

                // === WRITTEN AMOUNT ===
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(11);
                pdf.text(toWords(amount), inch(0.350) + offsetXPt, inch(1.815) + offsetYPt);

                pdf.setLineWidth(inch(0.0140));
                pdf.line(inch(0.288) + offsetXPt, inch(1.949) + offsetYPt, inch(7.422) + offsetXPt, inch(1.949) + offsetYPt);
                pdf.setLineWidth(1);

                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(9);
                pdf.text('DOLLARS', inch(7.475) + offsetXPt, inch(1.815) + offsetYPt);

                // === PAYEE ADDRESS BLOCK ===
                if (payTo && (payeeAddr || payeeCityLine)) {
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(9);
                    let currentY = 2.200;
                    if (payTo) {
                        pdf.setFont('helvetica', 'bold');
                        pdf.text(payTo, inch(0.850) + offsetXPt, inch(currentY) + offsetYPt);
                        currentY += 0.140;
                        pdf.setFont('helvetica', 'normal');
                    }
                    if (payeeAddr) {
                        pdf.text(payeeAddr, inch(0.850) + offsetXPt, inch(currentY) + offsetYPt);
                        currentY += 0.140;
                    }
                    if (payeeCityLine) {
                        pdf.text(payeeCityLine, inch(0.850) + offsetXPt, inch(currentY) + offsetYPt);
                    }
                }

                // === MEMO ===
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(9);
                pdf.text('MEMO', inch(0.341) + offsetXPt, inch(2.610) + offsetYPt);
                pdf.setFont('helvetica', 'normal');
                pdf.text(memo, inch(0.850) + offsetXPt, inch(2.695) + offsetYPt);
                pdf.setLineWidth(inch(0.0140));
                pdf.line(inch(0.789) + offsetXPt, inch(2.740) + offsetYPt, inch(3.292) + offsetXPt, inch(2.740) + offsetYPt);
                pdf.setLineWidth(1);

                // === SIGNATURE ===
                pdf.setLineWidth(inch(0.0140));
                pdf.line(inch(5.208) + offsetXPt, inch(2.740) + offsetYPt, inch(7.711) + offsetXPt, inch(2.740) + offsetYPt);
                pdf.setLineWidth(1);

                const sigCenterX = (5.208 + 7.711) / 2;
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(7);
                pdf.setTextColor(100);
                pdf.text('AUTHORIZED SIGNATURE', inch(sigCenterX) + offsetXPt, inch(2.92) + offsetYPt, { align: 'center' });
                pdf.setTextColor(0);

                // Add signature image if exists
                if (c.signature) {
                    try {
                        pdf.addImage(c.signature, 'PNG', inch(5.35) + offsetXPt, inch(2.32) + offsetYPt, inch(2.0), inch(0.30));
                    } catch (e) { console.log('Signature error:', e); }
                }

                // === MICR LINE ===
                let usedFont = false;
                if (MICR_FONT_BASE64) {
                    try {
                        pdf.addFileToVFS('MICR.ttf', MICR_FONT_BASE64);
                        pdf.addFont('MICR.ttf', 'MICR', 'normal');
                        pdf.setFont('MICR', 'normal');
                        pdf.setFontSize(18);
                        const micrText = `C${micrLine.checkNo}C A${micrLine.routing}A ${micrLine.account}C`;
                        pdf.text(micrText, inch(1.553) + offsetXPt, inch(3.043) + micrOffsetYPt);
                        usedFont = true;
                    } catch (e) {
                        console.log('MICR font failed, using programmatic drawing:', e);
                    }
                }

                if (!usedFont) {
                    drawMICRLine(pdf, inch(1.553) + offsetXPt, inch(3.043) + micrOffsetYPt - 8, micrLine.checkNo, micrLine.routing, micrLine.account);
                }

                // ========== STUB 1 ==========
                const stub1Y = checkHeight + 25;
                pdf.setDrawColor(200);
                pdf.setLineDashPattern([3, 3], 0);
                pdf.line(0, checkHeight, 612, checkHeight);
                pdf.setLineDashPattern([], 0);
                pdf.setDrawColor(0);

                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(11);
                pdf.text(checkNo, inch(0.5) + offsetXPt, stub1Y + 15);
                pdf.text(`Amount: ${formatCurrency(amount, true)}`, inch(2.2) + offsetXPt, stub1Y + 15);
                pdf.text(`Date: ${dateStr}`, inch(4.4) + offsetXPt, stub1Y + 15);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Pay to: ${payTo}`, inch(0.5) + offsetXPt, stub1Y + 35);

                // ========== STUB 2 ==========
                const stub2Y = checkHeight * 2 + 25;
                pdf.setDrawColor(200);
                pdf.setLineDashPattern([3, 3], 0);
                pdf.line(0, checkHeight * 2, 612, checkHeight * 2);
                pdf.setLineDashPattern([], 0);
                pdf.setDrawColor(0);

                pdf.setFont('helvetica', 'bold');
                pdf.text(checkNo, inch(0.5) + offsetXPt, stub2Y + 15);
                pdf.text(`Amount: ${formatCurrency(amount, true)}`, inch(2.2) + offsetXPt, stub2Y + 15);
                pdf.text(`Date: ${dateStr}`, inch(4.4) + offsetXPt, stub2Y + 15);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Pay to: ${payTo}`, inch(0.5) + offsetXPt, stub2Y + 35);

                // Update check status
                c.status = 'printed';
                c.printCount = (c.printCount || 0) + 1;
                c.printedAt = new Date().toISOString();
                c.printedBy = currentUser?.email || 'local';
                await saveCheckToFirebase(c);
            }

            localStorage.setItem('cf_checks', JSON.stringify(checks));
            renderChecks();

            pdf.save(`checks_batch_${new Date().toISOString().slice(0, 10)}.pdf`);
            toast(`${selectedChecks.length} check(s) printed`);

            trackEvent('checks_batch_printed', { count: selectedChecks.length });
        }

        // Save & Print combined action
        async function saveAndPrint() {
            // Remember if we're editing before save (because saveCheck clears editingCheckId)
            const wasEditing = !!editingCheckId;

            // First save the check
            await saveCheck('saved', false);
            // Then print it
            await printCheck();

            // Only advance check number and clear form if we were creating NEW check (not editing)
            if (!wasEditing) {
                const nextCheckNo = getNextAvailableCheckNo(currentAcctId);
                document.getElementById('checkNumber').value = nextCheckNo;
                
                // Clear transaction fields for next check (payee, amount, memo, payee address)
                // Keep account/bank info, signature, and issuer info intact
                document.getElementById('payTo').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('memo').value = '';
                document.getElementById('payeeAddress').value = '';
                document.getElementById('payeeCity').value = '';
                document.getElementById('payeeState').value = '';
                document.getElementById('payeeZip').value = '';
                
                // Reset date to today
                setToday();
                
                // Reset editing state
                editingCheckId = null;
                
                // Update preview to show cleared form with new check number
                updatePreview();
            }
            // If editing, preview already shows correct number - no change needed
        }

        // Bank name ‚Üí routing number auto-suggestion
        function suggestRouting(bankName) {
            if (!bankName) return;

            const normalized = bankName.toLowerCase().trim();
            const bank = bankRoutingDB[normalized];

            if (bank) {
                const state = document.getElementById('issuerState')?.value?.toUpperCase() || '';
                const routing = bank.routings[state] || bank.routings['default'];

                const routingField = document.getElementById('routingNumber');
                const routingHint = document.getElementById('routingHint');

                // Only auto-fill if empty or matches a known routing
                if (!routingField.value || Object.values(bank.routings).includes(routingField.value)) {
                    routingField.value = routing;
                    if (routingHint) {
                        routingHint.innerHTML = `‚úì Auto-filled for ${bank.name}` + (state ? ` (${state})` : '');
                        routingHint.style.color = '#43a047';
                    }
                    updatePreview();
                }
            }
        }

        // Check for duplicate/anomaly warnings
        function checkForAnomalies(payTo, amount, checkNo) {
            const warnings = [];

            // Same payee + same amount within 7 days
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            const duplicate = checks.find(c =>
                c.payTo.toLowerCase() === payTo.toLowerCase() &&
                c.amount === amount &&
                new Date(c.created) > sevenDaysAgo &&
                c.status !== 'voided'
            );

            if (duplicate) {
                warnings.push(`‚ö†Ô∏è Similar check found: #${duplicate.checkNo} to "${duplicate.payTo}" for $${amount.toFixed(2)} on ${new Date(duplicate.date).toLocaleDateString()}`);
            }

            // Check number gap
            const lastCheck = checks
                .filter(c => c.accountId === currentAcctId && c.status !== 'voided')
                .sort((a, b) => parseInt(b.checkNo) - parseInt(a.checkNo))[0];

            if (lastCheck) {
                const expectedNext = parseInt(lastCheck.checkNo) + 1;
                const current = parseInt(checkNo);
                if (current > expectedNext + 1) {
                    warnings.push(`‚ö†Ô∏è Check number gap: Expected ~${expectedNext}, entering ${current}`);
                }
            }

            // Large amount warning
            const avgAmount = checks.length > 0
                ? checks.reduce((sum, c) => sum + c.amount, 0) / checks.length
                : 0;

            if (avgAmount > 0 && amount > avgAmount * 5) {
                warnings.push(`‚ö†Ô∏è Unusually large amount: $${amount.toFixed(2)} is ${(amount / avgAmount).toFixed(1)}x your average`);
            }

            return warnings;
        }

        // Stale printed checks warning
        function getStaleChecks() {
            const ninetyDaysAgo = new Date();
            ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

            return checks.filter(c =>
                c.status === 'printed' &&
                new Date(c.printedAt || c.created) < ninetyDaysAgo
            );
        }

        // Large amount threshold for confirmation (configurable)
        const LARGE_AMOUNT_THRESHOLD = 50000;

        async function printCheck() {
            const rt = document.getElementById('routingNumber').value.trim();
            const ac = document.getElementById('accountNumber').value.trim();

            // === VALIDATION CHECKS ===

            // Routing number: exactly 9 digits
            if (!rt || rt.length !== 9) return toast('Enter 9-digit routing number', 'error');
            if (!/^\d{9}$/.test(rt)) return toast('Routing number must be 9 digits only', 'error');

            // Account number: digits only, reasonable length (4-17 digits typical)
            if (!ac) return toast('Enter account number', 'error');
            if (!/^\d+$/.test(ac)) return toast('Account number must contain only digits', 'error');
            if (ac.length < 4 || ac.length > 17) {
                if (!confirm(`Account number is ${ac.length} digits (typical is 4-17). Continue anyway?`)) return;
            }

            // Issuer name required (not just "Name" placeholder or empty)
            const issuerName = document.getElementById('issuerName').value?.trim() || '';
            if (!issuerName || issuerName.toLowerCase() === 'name' || issuerName.toLowerCase() === 'your name') {
                return toast('Enter issuer name in Account Settings before printing', 'error');
            }

            // Payee and amount required
            const payTo = document.getElementById('payTo').value?.trim() || '';
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            if (!payTo) return toast('Enter payee name', 'error');
            if (amount <= 0) return toast('Enter a valid amount', 'error');

            // Large amount warning
            if (amount >= LARGE_AMOUNT_THRESHOLD) {
                if (!confirm(`‚ö†Ô∏è Large amount warning!\n\nYou are about to print a check for ${formatCurrency(amount, true)}.\n\nAre you sure this is correct?`)) {
                    return;
                }
            }

            // Debug MICR status
            console.log('=== PRINTING CHECK ===');
            micrDebug();

            // Get all values
            const checkNo = document.getElementById('checkNumber').value || '1001';
            const date = document.getElementById('checkDate').value;
            const dateStr = date ? new Date(date + 'T00:00:00').toLocaleDateString() : '';
            const memo = document.getElementById('memo').value || '';
            const bankName = document.getElementById('bankName').value || '';
            const transit = document.getElementById('transitCode').value || '';
            const issuerAddr = document.getElementById('issuerAddress').value || '';
            const issuerCity = document.getElementById('issuerCity').value || '';
            const issuerState = document.getElementById('issuerState').value || '';
            const issuerZip = document.getElementById('issuerZip').value || '';
            const cityLine = `${issuerCity}${issuerState ? ', ' + issuerState : ''}${issuerZip ? ' ' + issuerZip : ''}`;

            // Get payee address
            const payeeAddr = document.getElementById('payeeAddress').value || '';
            const payeeCity = document.getElementById('payeeCity').value || '';
            const payeeState = document.getElementById('payeeState').value || '';
            const payeeZip = document.getElementById('payeeZip').value || '';
            const payeeCityLine = `${payeeCity}${payeeState ? ', ' + payeeState : ''}${payeeZip ? ' ' + payeeZip : ''}`;

            // MICR line - use helper function for proper format
            const micrLine = formatMICR(checkNo, rt, ac);

            // Get calibration values
            const offsetX = (printCalibration.offsetX || 0) * 72; // Convert inches to points
            const offsetY = (printCalibration.offsetY || 0) * 72;
            const checkHeight = (parseFloat(document.getElementById('checkHeight')?.value) || 3.5) * 72;

            // Create PDF (letter size: 8.5" x 11" = 612 x 792 points)
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'pt',
                format: 'letter'
            });

            // Helper: Convert inches to points (1 inch = 72 points)
            const inch = (i) => i * 72;

            // Apply calibration offset + empirical Y-correction from print testing
            const offsetXPt = offsetX; // Already in points
            const offsetYPt = offsetY + inch(0.09); // Add 0.09" DOWN (empirical correction from print test)

            // MICR needs additional correction (total 0.25" down from template)
            const micrOffsetYPt = offsetY + inch(0.25); // MICR-specific offset

            // ========== CHECK SECTION - EXACT TEMPLATE MEASUREMENTS ==========

            // === ISSUER INFO (Centered Block) ===
            // Block-centered at x=2.2" (personal check standard)
            // All three lines use same center point for professional appearance
            const issuerCenterX = inch(2.2) + offsetXPt;

            // Company name - Bold, 12pt
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(12);
            pdf.text(issuerName, issuerCenterX, inch(0.376) + offsetYPt, { align: 'center' });

            // Address line - Normal, 9pt (0.16" below name)
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(9);
            pdf.text(issuerAddr, issuerCenterX, inch(0.534) + offsetYPt, { align: 'center' });

            // City/State/ZIP - Normal, 9pt (0.12" below address)
            pdf.text(cityLine, issuerCenterX, inch(0.658) + offsetYPt, { align: 'center' });

            // === BANK NAME (Center Top) ===
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(10);
            pdf.text(bankName, inch(5.037) + offsetXPt, inch(0.453) + offsetYPt);

            // Transit code under bank name
            if (transit) {
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(8);
                pdf.setTextColor(100);
                pdf.text(transit, inch(5.037) + offsetXPt, inch(0.580) + offsetYPt);
                pdf.setTextColor(0);
            }

            // === CHECK NUMBER (Top Right) ===
            // Template position: x=7.518", y=0.329" (bounding box top)
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(14);
            pdf.text(checkNo, inch(7.518) + offsetXPt, inch(0.329) + 10 + offsetYPt); // +10pt for baseline adjustment

            // === DATE ===
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(8);
            pdf.text('DATE', inch(6.492) + offsetXPt, inch(0.981) + offsetYPt);
            // Date underline: from x=6.797" to x=8.090", y=1.118", thickness=0.0136"
            pdf.setLineWidth(inch(0.0136));
            pdf.line(inch(6.797) + offsetXPt, inch(1.118) + offsetYPt, inch(8.090) + offsetXPt, inch(1.118) + offsetYPt);
            pdf.setLineWidth(1); // Reset to default

            // Date value - matches Payee font size for visual balance
            pdf.setFontSize(11); // Same as payee name
            pdf.text(dateStr, inch(7.44) + offsetXPt, inch(1.09) + offsetYPt, { align: 'center' });

            // === PAY TO THE ORDER OF ===
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(8);
            pdf.text('PAY TO THE', inch(0.258) + offsetXPt, inch(1.355) + offsetYPt);
            pdf.text('ORDER OF', inch(0.258) + offsetXPt, inch(1.486) + offsetYPt);

            // Payee name (no address here - address goes in window envelope area above MEMO)
            pdf.setFontSize(11);
            pdf.text(payTo, inch(0.950) + offsetXPt, inch(1.530) + offsetYPt);

            // Payee underline: from x=0.789" to x=6.605", y=1.618", thickness=0.0136"
            pdf.setLineWidth(inch(0.0136));
            pdf.line(inch(0.789) + offsetXPt, inch(1.618) + offsetYPt, inch(6.605) + offsetXPt, inch(1.618) + offsetYPt);
            pdf.setLineWidth(1);

            // Vertical separator bar (between payee and amount), width=0.0137"
            pdf.setLineWidth(inch(0.0137));
            pdf.line(inch(6.623) + offsetXPt, inch(1.535) + offsetYPt, inch(6.623) + offsetXPt, inch(1.625) + offsetYPt);
            pdf.setLineWidth(1);

            // === AMOUNT BOX ===
            // Dollar sign at exact template position: x=6.766", y=1.405"
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(12);
            pdf.text('$', inch(6.766) + offsetXPt, inch(1.405) + 9 + offsetYPt); // +9pt for baseline

            // Amount box (rectangle around amount area)
            pdf.rect(inch(6.75) + offsetXPt, inch(1.35) + offsetYPt, inch(1.35), inch(0.30));

            // Amount value (right-aligned in box)
            pdf.text(formatCurrency(amount), inch(8.05) + offsetXPt, inch(1.405) + 9 + offsetYPt, { align: 'right' });

            // === WRITTEN AMOUNT LINE ===
            // FIXED positions - DO NOT SHIFT (ChatGPT: shifting creates collisions)
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(11);
            pdf.text(toWords(amount), inch(0.350) + offsetXPt, inch(1.815) + offsetYPt);

            // Long amount line - FIXED position
            pdf.setLineWidth(inch(0.0140));
            pdf.line(inch(0.288) + offsetXPt, inch(1.949) + offsetYPt, inch(7.422) + offsetXPt, inch(1.949) + offsetYPt);
            pdf.setLineWidth(1);

            // "DOLLARS" at exact template position - FIXED
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(9);
            pdf.text('DOLLARS', inch(7.475) + offsetXPt, inch(1.815) + offsetYPt);

            // === PAYEE ADDRESS BLOCK (Window Envelope Position) ===
            // ChatGPT: Place ABOVE MEMO in lower-left area (window envelope standard)
            // Position: Y=2.200" (above MEMO at 2.610"), X=0.850" (same as memo text)
            // Font: Helvetica Normal 9pt, Line spacing: 0.140"
            if (payTo && (payeeAddr || payeeCityLine)) {
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(9);

                let currentY = 2.200; // Start position (above MEMO)

                // Line 1: Payee Name (optional, bold for emphasis)
                if (payTo) {
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(payTo, inch(0.850) + offsetXPt, inch(currentY) + offsetYPt);
                    currentY += 0.140; // Line spacing
                    pdf.setFont('helvetica', 'normal');
                }

                // Line 2: Street Address
                if (payeeAddr) {
                    pdf.text(payeeAddr, inch(0.850) + offsetXPt, inch(currentY) + offsetYPt);
                    currentY += 0.140;
                }

                // Line 3: City, State ZIP
                if (payeeCityLine) {
                    pdf.text(payeeCityLine, inch(0.850) + offsetXPt, inch(currentY) + offsetYPt);
                }
            }

            // === MEMO ===
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(9);
            pdf.text('MEMO', inch(0.341) + offsetXPt, inch(2.610) + offsetYPt);

            pdf.setFont('helvetica', 'normal');
            pdf.text(memo, inch(0.850) + offsetXPt, inch(2.695) + offsetYPt);

            // Memo underline: from x=0.789" to x=3.292", y=2.740", thickness=0.0140"
            pdf.setLineWidth(inch(0.0140));
            pdf.line(inch(0.789) + offsetXPt, inch(2.740) + offsetYPt, inch(3.292) + offsetXPt, inch(2.740) + offsetYPt);
            pdf.setLineWidth(1);

            // === SIGNATURE ===
            // Signature underline: SYMMETRIC with memo line (width 2.503")
            // Changed from x=4.960"-7.964" to x=5.208"-7.711" for symmetry
            pdf.setLineWidth(inch(0.0140));
            pdf.line(inch(5.208) + offsetXPt, inch(2.740) + offsetYPt, inch(7.711) + offsetXPt, inch(2.740) + offsetYPt);
            pdf.setLineWidth(1);

            // "AUTHORIZED SIGNATURE" label - centered on symmetric signature line
            // Line center: (5.208 + 7.711) / 2 = 6.4595"
            const sigCenterX = (5.208 + 7.711) / 2;
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(7);
            pdf.setTextColor(100);
            pdf.text('AUTHORIZED SIGNATURE', inch(sigCenterX) + offsetXPt, inch(2.92) + offsetYPt, { align: 'center' });
            pdf.setTextColor(0);

            // Add signature image if exists and checkbox is checked
            const includeSignature = document.getElementById('includeSignature')?.checked;
            if (currentSig && includeSignature) {
                try {
                    // Position signature ABOVE the line with proper clearance (0.12" gap)
                    // y=2.32", height=0.30" ‚Üí bottom=2.62", line at 2.74" ‚Üí clearance=0.12" ‚úÖ
                    pdf.addImage(currentSig, 'PNG', inch(5.35) + offsetXPt, inch(2.32) + offsetYPt, inch(2.0), inch(0.30));
                } catch (e) { console.log('Signature not added:', e); }
            }

            // MICR Line - EXACT TEMPLATE POSITION + EMPIRICAL CORRECTION
            // Position: x=1.553", y=3.043", font size=17.98pt
            // Empirical Y correction: +0.25" down (critical for bank scanning)
            // micrLine is {checkNo, routing, account} from formatMICR()

            // Try MICR font - must add to each PDF instance
            let usedFont = false;
            if (MICR_FONT_BASE64) {
                try {
                    // Add font to this PDF instance (required for each new PDF)
                    pdf.addFileToVFS('MICR.ttf', MICR_FONT_BASE64);
                    pdf.addFont('MICR.ttf', 'MICR', 'normal');
                    pdf.setFont('MICR', 'normal');
                    pdf.setFontSize(18); // Template specifies 17.98pt
                    // Format: C{check}C A{routing}A {account}C
                    const micrText = `C${micrLine.checkNo}C A${micrLine.routing}A ${micrLine.account}C`;
                    pdf.text(micrText, inch(1.553) + offsetXPt, inch(3.043) + micrOffsetYPt); // Use MICR-specific offset
                    usedFont = true;
                    console.log('MICR font rendered successfully');
                } catch (e) {
                    console.log('MICR font failed, using programmatic drawing:', e);
                }
            }

            if (!usedFont) {
                // Use programmatic MICR symbol drawing (fallback)
                drawMICRLine(pdf, inch(1.553) + offsetXPt, inch(3.043) + micrOffsetYPt - 8, micrLine.checkNo, micrLine.routing, micrLine.account);
            }

            // ========== STUB 1 ==========
            const stub1Y = checkHeight + 25;
            pdf.setDrawColor(200);
            pdf.setLineDashPattern([3, 3], 0);
            pdf.line(0, checkHeight, 612, checkHeight);
            pdf.setLineDashPattern([], 0);
            pdf.setDrawColor(0);

            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(11);
            pdf.text(checkNo, inch(0.5) + offsetXPt, stub1Y + 15);
            pdf.text(`Amount: ${formatCurrency(amount, true)}`, inch(2.2) + offsetXPt, stub1Y + 15);
            pdf.text(`Date: ${dateStr}`, inch(4.4) + offsetXPt, stub1Y + 15);
            pdf.setFont('helvetica', 'normal');
            pdf.text(`Pay to: ${payTo}`, inch(0.5) + offsetXPt, stub1Y + 35);

            // ========== STUB 2 ==========
            const stub2Y = checkHeight * 2 + 25;
            pdf.setDrawColor(200);
            pdf.setLineDashPattern([3, 3], 0);
            pdf.line(0, checkHeight * 2, 612, checkHeight * 2);
            pdf.setLineDashPattern([], 0);
            pdf.setDrawColor(0);

            pdf.setFont('helvetica', 'bold');
            pdf.text(checkNo, inch(0.5) + offsetXPt, stub2Y + 15);
            pdf.text(`Amount: ${formatCurrency(amount, true)}`, inch(2.2) + offsetXPt, stub2Y + 15);
            pdf.text(`Date: ${dateStr}`, inch(4.4) + offsetXPt, stub2Y + 15);
            pdf.setFont('helvetica', 'normal');
            pdf.text(`Pay to: ${payTo}`, inch(0.5) + offsetXPt, stub2Y + 35);

            // Generate filename and download
            const filename = `Check_${checkNo}_${payTo.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
            pdf.save(filename);

            // Mark check as printed
            await markCheckPrinted(checkNo, rt, ac);

            // Track print event
            trackEvent('check_printed', {
                amount_range: amount < 100 ? 'under_100' : amount < 1000 ? '100_to_1000' : amount < 10000 ? '1000_to_10000' : 'over_10000',
                has_signature: !!currentSig,
                micr_font: usedFont ? 'embedded' : 'programmatic'
            });

            toast(`PDF generated: ${filename}`);
        }

        function renderDropdown() {
            // Desktop dropdown
            const dd = document.getElementById('currentAccount');
            dd.innerHTML = '<option value="">Select...</option>' + accounts.map(a => `<option value="${a.id}" ${a.id === currentAcctId ? 'selected' : ''}>${a.nickname}</option>`).join('');
            dd.onchange = e => {
                currentAcctId = e.target.value;
                localStorage.setItem('cf_current', currentAcctId);
                saveCurrentAccountSelection();
                loadDefaults();
                updatePreview();
            };

            // Mobile dropdown
            const mobileDD = document.getElementById('mobileCurrentAccount');
            if (mobileDD) {
                mobileDD.innerHTML = '<option value="">Select...</option>' + accounts.map(a => `<option value="${a.id}" ${a.id === currentAcctId ? 'selected' : ''}>${a.nickname}</option>`).join('');
                mobileDD.onchange = e => {
                    currentAcctId = e.target.value;
                    localStorage.setItem('cf_current', currentAcctId);
                    saveCurrentAccountSelection();
                    loadDefaults();
                    updatePreview();
                };
            }
        }

        function renderAccounts() {
            const c = document.getElementById('accountsList');
            if (!accounts.length) { c.innerHTML = '<div class="empty-state"><h3>No accounts</h3><p>Add an account to quick-fill checks</p></div>'; return; }
            c.innerHTML = accounts.map(a => {
                const defaultBadge = a.isDefault ? '<span style="background:#dcfce7;color:#16a34a;font-size:10px;padding:2px 6px;border-radius:4px;margin-left:6px;">Default</span>' : '';
                const sigBadge = a.signature ? '<span style="background:#e0f2fe;color:#0369a1;font-size:10px;padding:2px 6px;border-radius:4px;margin-left:4px;">‚úç Sig</span>' : '';
                return `<div class="card"><div style="display:flex;justify-content:space-between;"><div><strong>${a.nickname}</strong>${defaultBadge}${sigBadge}<br><span style="color:var(--text-secondary);font-size:12px;">${a.bank} ‚Ä¢ ****${a.account.slice(-4)}</span><br><span style="color:var(--text-muted);font-size:11px;">${a.name}<br>${a.addr || ''}<br>${a.city || ''}, ${a.state || ''} ${a.zip || ''}</span></div><div><button class="btn btn-secondary" onclick="editAccount('${a.id}')">Edit</button> <button class="btn btn-danger" onclick="deleteAccount('${a.id}')">Delete</button></div></div></div>`;
            }).join('');
        }

        function showAccountModal(editId = null) {
            // Soft-gate: Adding accounts requires paid plan
            if (!editId && !requirePaidPlan('add_account')) return;

            if (editId) {
                // Edit mode - redirect to editAccount
                editAccount(editId);
                return;
            }

            document.getElementById('modalTitle').textContent = 'New Account';
            document.getElementById('editingId').value = '';
            ['modalNickname', 'modalBankName', 'modalTransit', 'modalRouting', 'modalAccount', 'modalName', 'modalAddr', 'modalCity', 'modalState', 'modalZip'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('modalCheckNo').value = '1001';
            document.getElementById('modalIsDefault').checked = accounts.length === 0; // First account is default
            document.getElementById('modalSignature').value = '';
            document.getElementById('modalSigImg').style.display = 'none';
            document.getElementById('modalSigPlaceholder').style.display = 'block';
            document.getElementById('accountModal').classList.add('active');

            // Initialize signature canvas (default to draw mode)
            setTimeout(() => {
                switchAccountSigMode('draw');
            }, 100);
        }

        function editAccount(id) {
            const a = accounts.find(x => x.id === id); if (!a) return;
            document.getElementById('modalTitle').textContent = 'Edit Account';
            document.getElementById('editingId').value = id;
            document.getElementById('modalNickname').value = a.nickname;
            document.getElementById('modalBankName').value = a.bank;
            document.getElementById('modalTransit').value = a.transit || '';
            document.getElementById('modalRouting').value = a.routing;
            document.getElementById('modalAccount').value = a.account;
            document.getElementById('modalCheckNo').value = a.checkNo || 1001;
            document.getElementById('modalName').value = a.name;
            document.getElementById('modalAddr').value = a.addr || '';
            document.getElementById('modalCity').value = a.city || '';
            document.getElementById('modalState').value = a.state || '';
            document.getElementById('modalZip').value = a.zip || '';
            document.getElementById('modalIsDefault').checked = a.isDefault || false;
            document.getElementById('modalSignature').value = a.signature || '';

            // Show signature preview if exists
            if (a.signature) {
                document.getElementById('modalSigImg').src = a.signature;
                document.getElementById('modalSigImg').style.display = 'block';
                document.getElementById('modalSigPlaceholder').style.display = 'none';
            } else {
                document.getElementById('modalSigImg').style.display = 'none';
                document.getElementById('modalSigPlaceholder').style.display = 'block';
            }

            document.getElementById('accountModal').classList.add('active');

            // Initialize signature canvas (default to draw mode)
            setTimeout(() => {
                switchAccountSigMode('draw');
            }, 100);
        }

        function closeAccountModal() { document.getElementById('accountModal').classList.remove('active'); }

        async function saveAccountModal() {
            const nickname = document.getElementById('modalNickname').value.trim();
            const bank = document.getElementById('modalBankName').value.trim();
            const routing = document.getElementById('modalRouting').value.trim();
            const account = document.getElementById('modalAccount').value.trim();
            const name = document.getElementById('modalName').value.trim();
            if (!nickname || !bank || !routing || !account || !name) return toast('Fill required fields', 'error');
            if (routing.length !== 9 || !/^\d+$/.test(routing)) return toast('Routing must be 9 digits', 'error');

            const id = document.getElementById('editingId').value || Date.now().toString();
            const isDefault = document.getElementById('modalIsDefault').checked;
            const signature = document.getElementById('modalSignature').value || '';

            const data = {
                id,
                nickname,
                bank,
                transit: document.getElementById('modalTransit').value.trim(),
                routing,
                account,
                checkNo: parseInt(document.getElementById('modalCheckNo').value) || 1001,
                name,
                addr: document.getElementById('modalAddr').value.trim(),
                city: document.getElementById('modalCity').value.trim(),
                state: document.getElementById('modalState').value.trim().toUpperCase(),
                zip: document.getElementById('modalZip').value.trim(),
                isDefault: isDefault,
                signature: signature
            };

            // If this is marked as default, unmark all others
            if (isDefault) {
                accounts.forEach(a => {
                    if (a.id !== id) {
                        a.isDefault = false;
                        saveAccountToFirebase(a); // Save each updated account
                    }
                });
            }

            const idx = accounts.findIndex(x => x.id === id);
            if (idx >= 0) accounts[idx] = data; else accounts.push(data);

            // Save to Firebase
            const saved = await saveAccountToFirebase(data);
            if (!saved) {
                localStorage.setItem('cf_accounts', JSON.stringify(accounts));
            }

            // If this is the default account or no account selected, select it
            if (isDefault || !currentAcctId) {
                currentAcctId = id;
                localStorage.setItem('cf_current', id);
                saveCurrentAccountSelection();
            }
            renderDropdown(); renderAccounts(); loadDefaults(); updatePreview(); closeAccountModal();
            toast(idx >= 0 ? 'Account updated' : 'Account created');
        }

        // Handle account signature upload
        function handleAccountSigUpload(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                document.getElementById('modalSignature').value = ev.target.result;
                document.getElementById('modalSigImg').src = ev.target.result;
                document.getElementById('modalSigImg').style.display = 'block';
                document.getElementById('modalSigPlaceholder').style.display = 'none';
                toast('Signature uploaded');
            };
            reader.readAsDataURL(file);
        }

        // Clear account signature
        function clearAccountSignature() {
            document.getElementById('modalSignature').value = '';
            document.getElementById('modalSigImg').style.display = 'none';
            document.getElementById('modalSigPlaceholder').style.display = 'block';

            // Also clear canvas if in draw mode
            const canvas = document.getElementById('accountSignatureCanvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

            toast('Signature cleared');
        }

        // Switch account signature mode (draw/upload)
        function switchAccountSigMode(mode) {
            document.getElementById('accountSigDrawMode').style.display = mode === 'draw' ? 'block' : 'none';
            document.getElementById('accountSigUploadMode').style.display = mode === 'upload' ? 'block' : 'none';

            // Update tab styles
            document.getElementById('accountSigDrawTab').style.background = mode === 'draw' ? 'var(--accent)' : 'var(--bg-secondary)';
            document.getElementById('accountSigDrawTab').style.color = mode === 'draw' ? 'white' : 'var(--text-secondary)';
            document.getElementById('accountSigUploadTab').style.background = mode === 'upload' ? 'var(--accent)' : 'var(--bg-secondary)';
            document.getElementById('accountSigUploadTab').style.color = mode === 'upload' ? 'white' : 'var(--text-secondary)';

            if (mode === 'draw') {
                setTimeout(() => setupAccountSignatureCanvas(), 50);
            }
        }

        // Setup account signature canvas
        let accountSigCanvas, accountSigCtx, isAccountDrawing = false;
        function setupAccountSignatureCanvas() {
            accountSigCanvas = document.getElementById('accountSignatureCanvas');
            if (!accountSigCanvas) return;

            accountSigCtx = accountSigCanvas.getContext('2d');
            accountSigCtx.strokeStyle = '#000';
            accountSigCtx.lineWidth = 2;
            accountSigCtx.lineCap = 'round';
            accountSigCtx.lineJoin = 'round';

            // Mouse events
            accountSigCanvas.addEventListener('mousedown', e => {
                isAccountDrawing = true;
                const rect = accountSigCanvas.getBoundingClientRect();
                accountSigCtx.beginPath();
                accountSigCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            });

            accountSigCanvas.addEventListener('mousemove', e => {
                if (!isAccountDrawing) return;
                const rect = accountSigCanvas.getBoundingClientRect();
                accountSigCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                accountSigCtx.stroke();
            });

            accountSigCanvas.addEventListener('mouseup', () => isAccountDrawing = false);
            accountSigCanvas.addEventListener('mouseleave', () => isAccountDrawing = false);

            // Touch events
            accountSigCanvas.addEventListener('touchstart', e => {
                e.preventDefault();
                isAccountDrawing = true;
                const rect = accountSigCanvas.getBoundingClientRect();
                const touch = e.touches[0];
                accountSigCtx.beginPath();
                accountSigCtx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
            });

            accountSigCanvas.addEventListener('touchmove', e => {
                e.preventDefault();
                if (!isAccountDrawing) return;
                const rect = accountSigCanvas.getBoundingClientRect();
                const touch = e.touches[0];
                accountSigCtx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
                accountSigCtx.stroke();
            });

            accountSigCanvas.addEventListener('touchend', e => {
                e.preventDefault();
                isAccountDrawing = false;
            });
        }

        // Clear account signature canvas
        function clearAccountSignatureCanvas() {
            if (accountSigCtx) {
                accountSigCtx.clearRect(0, 0, accountSigCanvas.width, accountSigCanvas.height);
            }
        }

        // Apply account signature from canvas
        function applyAccountSignature() {
            if (!accountSigCanvas) return;
            const dataURL = accountSigCanvas.toDataURL('image/png');
            document.getElementById('modalSignature').value = dataURL;

            // Show preview in upload section
            document.getElementById('modalSigImg').src = dataURL;
            document.getElementById('modalSigImg').style.display = 'block';
            document.getElementById('modalSigPlaceholder').style.display = 'none';

            toast('Signature applied to account');
        }

        async function deleteAccount(id) {
            if (!confirm('Delete this account?')) return;
            accounts = accounts.filter(a => a.id !== id);
            if (currentAcctId === id) {
                currentAcctId = accounts[0]?.id || '';
                localStorage.setItem('cf_current', currentAcctId);
                saveCurrentAccountSelection();
            }

            // Delete from Firebase
            await deleteAccountFromFirebase(id);
            localStorage.setItem('cf_accounts', JSON.stringify(accounts));

            renderDropdown(); renderAccounts(); loadDefaults(); updatePreview(); toast('Account deleted');
        }

        // Populate filter dropdowns
        function populateFilterDropdowns() {
            const filterAccount = document.getElementById('filterAccount');
            if (filterAccount) {
                const currentVal = filterAccount.value;
                filterAccount.innerHTML = '<option value="">All Accounts</option>' +
                    accounts.map(a => `<option value="${a.id}">${a.nickname}</option>`).join('');
                filterAccount.value = currentVal;
            }

            // Populate payee dropdown from checks
            const filterPayeeSelect = document.getElementById('filterPayeeSelect');
            if (filterPayeeSelect) {
                const currentVal = filterPayeeSelect.value;
                const uniquePayees = [...new Set(checks.map(c => c.payTo))].sort();
                filterPayeeSelect.innerHTML = '<option value="">All Payees</option>' +
                    uniquePayees.map(p => `<option value="${p}">${p}</option>`).join('');
                filterPayeeSelect.value = currentVal;

                // Enable/disable View Payee Profile button
                const viewBtn = document.getElementById('viewPayeeProfileBtn');
                if (viewBtn) {
                    viewBtn.disabled = !currentVal;
                }
            }
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('filterAccount').value = '';
            document.getElementById('filterPayeeSelect').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterAmountMin').value = '';
            document.getElementById('filterAmountMax').value = '';
            document.getElementById('filterCheckNo').value = '';
            document.getElementById('filterPayee').value = '';
            const viewBtn = document.getElementById('viewPayeeProfileBtn');
            if (viewBtn) viewBtn.disabled = true;
            renderChecks();
        }

        // Get account nickname by ID
        function getAccountNickname(accountId) {
            const acct = accounts.find(a => a.id === accountId);
            return acct ? acct.nickname : '-';
        }

        function renderChecks() {
            const tbody = document.getElementById('checksTable');
            const empty = document.getElementById('emptyState');
            const summary = document.getElementById('historySummary');

            // Apply filters
            let filtered = [...checks];

            const filterAccount = document.getElementById('filterAccount')?.value;
            const filterPayeeSelect = document.getElementById('filterPayeeSelect')?.value;
            const filterStatus = document.getElementById('filterStatus')?.value;
            const filterDateFrom = document.getElementById('filterDateFrom')?.value;
            const filterDateTo = document.getElementById('filterDateTo')?.value;
            const filterAmountMin = parseFloat(document.getElementById('filterAmountMin')?.value) || 0;
            const filterAmountMax = parseFloat(document.getElementById('filterAmountMax')?.value) || Infinity;
            const filterCheckNo = document.getElementById('filterCheckNo')?.value?.trim();
            const filterPayee = document.getElementById('filterPayee')?.value?.toLowerCase();

            // Enable/disable View Payee Profile button
            const viewBtn = document.getElementById('viewPayeeProfileBtn');
            if (viewBtn) viewBtn.disabled = !filterPayeeSelect;

            if (filterAccount) {
                filtered = filtered.filter(c => c.accountId === filterAccount);
            }
            if (filterPayeeSelect) {
                filtered = filtered.filter(c => c.payTo === filterPayeeSelect);
            }
            if (filterStatus) {
                filtered = filtered.filter(c => c.status === filterStatus);
            }
            if (filterDateFrom) {
                filtered = filtered.filter(c => c.date >= filterDateFrom);
            }
            if (filterDateTo) {
                filtered = filtered.filter(c => c.date <= filterDateTo);
            }
            if (filterAmountMin > 0) {
                filtered = filtered.filter(c => c.amount >= filterAmountMin);
            }
            if (filterAmountMax < Infinity) {
                filtered = filtered.filter(c => c.amount <= filterAmountMax);
            }
            if (filterCheckNo) {
                filtered = filtered.filter(c => c.checkNo.toString().includes(filterCheckNo));
            }
            if (filterPayee) {
                filtered = filtered.filter(c =>
                    c.payTo.toLowerCase().includes(filterPayee) ||
                    (c.memo && c.memo.toLowerCase().includes(filterPayee))
                );
            }

            // Calculate summary stats
            const totalAmount = filtered.filter(c => c.status !== 'voided').reduce((sum, c) => sum + (c.amount || 0), 0);
            const clearedAmount = filtered.filter(c => c.status === 'cleared').reduce((sum, c) => sum + (c.amount || 0), 0);
            const pendingAmount = filtered.filter(c => c.status === 'printed' || c.status === 'saved').reduce((sum, c) => sum + (c.amount || 0), 0);

            // Update summary display
            if (summary) {
                summary.style.display = filtered.length > 0 ? 'block' : 'none';
                document.getElementById('summaryCount').textContent = filtered.length;
                document.getElementById('summaryTotal').textContent = formatCurrency(totalAmount, true);
                document.getElementById('summaryCleared').textContent = formatCurrency(clearedAmount, true);
                document.getElementById('summaryPending').textContent = formatCurrency(pendingAmount, true);
            }

            if (!filtered.length) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                empty.querySelector('h3').textContent = checks.length ? 'No matching checks' : 'No checks yet';
                empty.querySelector('p').textContent = checks.length ? 'Try adjusting your filters' : 'Write your first check to get started';
                return;
            }

            empty.style.display = 'none';

            // Sort by created date descending
            filtered.sort((a, b) => new Date(b.created) - new Date(a.created));

            // Store filtered results for export
            window.lastFilteredChecks = filtered;

            tbody.innerHTML = filtered.map(c => {
                const acctName = getAccountNickname(c.accountId);
                const statusClass = `status-${c.status}`;

                let actions = '';
                if (c.status === 'voided') {
                    actions = `<button class="btn btn-secondary" onclick="loadCheck('${c.id}')">View</button>`;
                } else if (c.status === 'cleared') {
                    actions = `<button class="btn btn-secondary" onclick="loadCheck('${c.id}')">View</button>`;
                    actions += `<button class="btn btn-secondary" onclick="unclearCheck('${c.id}')" style="margin-left:4px;color:#d97706;" title="Mark as uncleared">‚Ü©</button>`;
                } else {
                    actions = `<button class="btn btn-secondary" onclick="loadCheck('${c.id}')">Edit</button>`;
                    actions += `<button class="btn btn-secondary" onclick="voidCheck('${c.id}')" style="margin-left:4px;color:#d32f2f;" title="Void this check">‚úï</button>`;
                    if (c.status === 'printed') {
                        actions += `<button class="btn btn-secondary" onclick="markCheckCleared('${c.id}')" style="margin-left:4px;color:#2e7d32;" title="Mark as cleared/cashed">‚úì</button>`;
                    }
                }

                // Payee name is clickable to open profile
                const payeeLink = `<a href="#" onclick="event.preventDefault();openPayeeProfile('${c.payTo.replace(/'/g, "\\'")}')" style="color:inherit;text-decoration:none;" title="View payee history">${c.payTo}</a>`;

                return `<tr>
                    <td><input type="checkbox" class="chkSel" data-id="${c.id}"></td>
                    <td>${c.checkNo}</td>
                    <td>${new Date(c.date + 'T00:00:00').toLocaleDateString()}</td>
                    <td>${payeeLink}</td>
                    <td class="amount-cell">${formatCurrency(c.amount, true)}</td>
                    <td style="font-size:11px;color:#666;">${acctName}</td>
                    <td><span class="status-badge ${statusClass}">${c.status}${c.printCount > 1 ? ` (√ó${c.printCount})` : ''}</span></td>
                    <td style="white-space:nowrap;">${actions}</td>
                </tr>`;
            }).join('');
        }

        function loadCheck(id) {
            const c = checks.find(x => x.id === id); if (!c) return;

            // Set editing state (only drafts can be edited)
            if (c.status === 'draft' || c.status === 'saved') {
                editingCheckId = c.id;
            } else {
                editingCheckId = null; // View-only for printed/cleared/voided checks
            }

            document.getElementById('checkNumber').value = c.checkNo;
            document.getElementById('checkDate').value = c.date;
            document.getElementById('payTo').value = c.payTo;
            document.getElementById('amount').value = c.amount;
            document.getElementById('memo').value = c.memo || '';
            document.getElementById('routingNumber').value = c.routing || '';
            document.getElementById('accountNumber').value = c.account || '';
            document.getElementById('bankName').value = c.bank || '';
            document.getElementById('transitCode').value = c.transit || '';
            document.getElementById('issuerName').value = c.issuerName || '';
            document.getElementById('issuerAddress').value = c.issuerAddr || '';
            document.getElementById('issuerCity').value = c.issuerCity || '';
            document.getElementById('issuerState').value = c.issuerState || '';
            document.getElementById('issuerZip').value = c.issuerZip || '';

            // Load payee address fields
            document.getElementById('payeeAddress').value = c.payeeAddr || '';
            document.getElementById('payeeCity').value = c.payeeCity || '';
            document.getElementById('payeeState').value = c.payeeState || '';
            document.getElementById('payeeZip').value = c.payeeZip || '';

            if (c.signature) currentSig = c.signature;

            // Switch to account if different
            if (c.accountId && c.accountId !== currentAcctId) {
                currentAcctId = c.accountId;
                document.getElementById('currentAccount').value = currentAcctId;
                const mobileDD = document.getElementById('mobileCurrentAccount');
                if (mobileDD) mobileDD.value = currentAcctId;
            }

            updatePreview();
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector('.nav-item[data-page="write"]').classList.add('active');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-write').classList.add('active');

            // Show notice if viewing non-editable check
            if (!editingCheckId && c.status !== 'draft' && c.status !== 'saved') {
                toast(`Viewing ${c.status} check #${c.checkNo} (read-only)`, 'info');
            }
        }

        // ============================================
        // PAYEE PROFILE & DIRECTORY FUNCTIONS
        // ============================================

        let currentPayeeProfile = null;

        function openPayeeProfile(payeeName) {
            if (!payeeName) return;
            currentPayeeProfile = payeeName;

            // Get all checks for this payee
            const payeeChecks = checks.filter(c => c.payTo.toLowerCase() === payeeName.toLowerCase());
            const payeeInfo = payees.find(p => p.name.toLowerCase() === payeeName.toLowerCase());

            // Update modal header
            document.getElementById('payeeProfileTitle').textContent = 'Payee Profile';
            document.getElementById('payeeProfileName').textContent = payeeName;

            // Show address if available
            let addressHtml = '<span style="color:var(--text-muted);">No address saved</span>';
            if (payeeInfo?.address && (payeeInfo.address.street || payeeInfo.address.city)) {
                const addr = payeeInfo.address;
                addressHtml = [addr.street, [addr.city, addr.state, addr.zip].filter(Boolean).join(' ')].filter(Boolean).join(', ');
            }
            document.getElementById('payeeProfileAddress').innerHTML = addressHtml;

            // Calculate stats
            const nonVoided = payeeChecks.filter(c => c.status !== 'voided');
            const totalAll = nonVoided.reduce((sum, c) => sum + (c.amount || 0), 0);
            const avgAmount = nonVoided.length > 0 ? totalAll / nonVoided.length : 0;
            const sortedByDate = [...payeeChecks].sort((a, b) => new Date(a.date) - new Date(b.date));
            const firstCheck = sortedByDate[0];
            const lastCheck = sortedByDate[sortedByDate.length - 1];

            document.getElementById('payeeProfileTotalAll').textContent = formatCurrency(totalAll, true);
            document.getElementById('payeeProfileCheckCount').textContent = payeeChecks.length;
            document.getElementById('payeeProfileAvg').textContent = formatCurrency(avgAmount, true);
            document.getElementById('payeeProfileFirstDate').textContent = firstCheck ? new Date(firstCheck.date + 'T00:00:00').toLocaleDateString() : '-';
            document.getElementById('payeeProfileLastDate').textContent = lastCheck ? new Date(lastCheck.date + 'T00:00:00').toLocaleDateString() : '-';

            // Clear date range filters
            document.getElementById('payeeProfileDateFrom').value = '';
            document.getElementById('payeeProfileDateTo').value = '';
            document.getElementById('payeeProfileRangeTotal').textContent = '';

            // Render checks table
            updatePayeeProfile();

            // Show modal
            document.getElementById('payeeProfileModal').classList.add('active');
        }

        function updatePayeeProfile() {
            if (!currentPayeeProfile) return;

            const dateFrom = document.getElementById('payeeProfileDateFrom').value;
            const dateTo = document.getElementById('payeeProfileDateTo').value;

            // Filter checks
            let payeeChecks = checks.filter(c => c.payTo.toLowerCase() === currentPayeeProfile.toLowerCase());

            if (dateFrom) {
                payeeChecks = payeeChecks.filter(c => c.date >= dateFrom);
            }
            if (dateTo) {
                payeeChecks = payeeChecks.filter(c => c.date <= dateTo);
            }

            // Sort by date descending
            payeeChecks.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Calculate range total
            const rangeTotal = payeeChecks.filter(c => c.status !== 'voided').reduce((sum, c) => sum + (c.amount || 0), 0);
            if (dateFrom || dateTo) {
                document.getElementById('payeeProfileRangeTotal').textContent = `Range Total: ${formatCurrency(rangeTotal, true)}`;
            } else {
                document.getElementById('payeeProfileRangeTotal').textContent = '';
            }

            // Render table
            const tbody = document.getElementById('payeeProfileChecks');
            if (!payeeChecks.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:20px;">No checks found</td></tr>';
                return;
            }

            tbody.innerHTML = payeeChecks.map(c => {
                const acctName = getAccountNickname(c.accountId);
                const statusClass = `status-${c.status}`;
                return `<tr>
                    <td>${new Date(c.date + 'T00:00:00').toLocaleDateString()}</td>
                    <td>${c.checkNo}</td>
                    <td class="amount-cell">${formatCurrency(c.amount, true)}</td>
                    <td style="font-size:12px;color:var(--text-secondary);">${c.memo || '-'}</td>
                    <td style="font-size:11px;color:#666;">${acctName}</td>
                    <td><span class="status-badge ${statusClass}">${c.status}</span></td>
                </tr>`;
            }).join('');
        }

        function closePayeeProfileModal() {
            document.getElementById('payeeProfileModal').classList.remove('active');
            currentPayeeProfile = null;
        }

        function editPayeeInfo() {
            if (!currentPayeeProfile) return;
            const payeeInfo = payees.find(p => p.name.toLowerCase() === currentPayeeProfile.toLowerCase());

            const newName = prompt('Payee Name:', currentPayeeProfile);
            if (newName === null) return;

            const addr = payeeInfo?.address || {};
            const newStreet = prompt('Street Address:', addr.street || '');
            if (newStreet === null) return;
            const newCity = prompt('City:', addr.city || '');
            if (newCity === null) return;
            const newState = prompt('State (2 letters):', addr.state || '');
            if (newState === null) return;
            const newZip = prompt('ZIP Code:', addr.zip || '');
            if (newZip === null) return;

            // Update payee
            if (payeeInfo) {
                payeeInfo.name = newName.trim() || currentPayeeProfile;
                payeeInfo.address = {
                    street: newStreet.trim(),
                    city: newCity.trim(),
                    state: newState.trim().toUpperCase(),
                    zip: newZip.trim()
                };
            } else {
                payees.push({
                    id: Date.now().toString(),
                    name: newName.trim() || currentPayeeProfile,
                    address: { street: newStreet.trim(), city: newCity.trim(), state: newState.trim().toUpperCase(), zip: newZip.trim() },
                    useCount: 0,
                    lastUsed: new Date().toISOString()
                });
            }

            // Save
            localStorage.setItem('cf_payees', JSON.stringify(payees));
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).set({ payees }, { merge: true }).catch(e => console.error(e));
            }

            toast('Payee updated');
            currentPayeeProfile = newName.trim() || currentPayeeProfile;
            openPayeeProfile(currentPayeeProfile);
        }

        function exportPayeeHistory() {
            if (!currentPayeeProfile) return;
            const payeeChecks = checks.filter(c => c.payTo.toLowerCase() === currentPayeeProfile.toLowerCase());
            if (!payeeChecks.length) return toast('No checks to export', 'error');

            // Export to CSV
            const headers = ['Date', 'Check #', 'Amount', 'Memo', 'Account', 'Status'];
            const rows = payeeChecks.map(c => [
                c.date,
                c.checkNo,
                c.amount,
                c.memo || '',
                getAccountNickname(c.accountId),
                c.status
            ]);

            const total = payeeChecks.filter(c => c.status !== 'voided').reduce((sum, c) => sum + c.amount, 0);
            rows.push(['', '', '', '', '', '']);
            rows.push(['TOTAL', '', total, '', '', '']);

            const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentPayeeProfile.replace(/[^a-z0-9]/gi, '_')}_check_history.csv`;
            a.click();
            URL.revokeObjectURL(url);
            toast('History exported');
        }

        function writeCheckToPayee() {
            if (!currentPayeeProfile) return;
            closePayeeProfileModal();

            // Navigate to write check page
            navigateTo('write');

            // Pre-fill payee
            document.getElementById('payTo').value = currentPayeeProfile;

            // Auto-fill address if available
            const payeeInfo = payees.find(p => p.name.toLowerCase() === currentPayeeProfile.toLowerCase());
            if (payeeInfo?.address) {
                document.getElementById('payeeAddress').value = payeeInfo.address.street || '';
                document.getElementById('payeeCity').value = payeeInfo.address.city || '';
                document.getElementById('payeeState').value = payeeInfo.address.state || '';
                document.getElementById('payeeZip').value = payeeInfo.address.zip || '';
            }

            updatePreview();
            document.getElementById('amount').focus();
        }

        // Payee Directory
        function openPayeeDirectory() {
            renderPayeeDirectory();
            document.getElementById('payeeDirectoryModal').classList.add('active');
            document.getElementById('payeeDirectorySearch').value = '';
            document.getElementById('payeeDirectorySearch').focus();
        }

        function closePayeeDirectoryModal() {
            document.getElementById('payeeDirectoryModal').classList.remove('active');
        }

        function renderPayeeDirectory() {
            const search = document.getElementById('payeeDirectorySearch')?.value?.toLowerCase() || '';
            const container = document.getElementById('payeeDirectoryList');

            // Combine payees from both payees array and checks
            const allPayeeNames = new Set([
                ...payees.map(p => p.name),
                ...checks.map(c => c.payTo)
            ]);

            let payeeList = Array.from(allPayeeNames).map(name => {
                const info = payees.find(p => p.name.toLowerCase() === name.toLowerCase()) || {};
                const payeeChecks = checks.filter(c => c.payTo.toLowerCase() === name.toLowerCase());
                const total = payeeChecks.filter(c => c.status !== 'voided').reduce((sum, c) => sum + (c.amount || 0), 0);
                return {
                    name,
                    checkCount: payeeChecks.length,
                    totalPaid: total,
                    lastUsed: info.lastUsed || (payeeChecks.length > 0 ? payeeChecks[0].created : null),
                    address: info.address
                };
            });

            // Filter by search
            if (search) {
                payeeList = payeeList.filter(p => p.name.toLowerCase().includes(search));
            }

            // Sort by name
            payeeList.sort((a, b) => a.name.localeCompare(b.name));

            if (!payeeList.length) {
                container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">No payees found</div>';
                return;
            }

            container.innerHTML = payeeList.map(p => {
                const addrPreview = p.address ? `${p.address.city || ''}, ${p.address.state || ''}`.replace(/^, |, $/g, '') : '';
                return `<div class="card" style="margin-bottom:8px;padding:12px;cursor:pointer;" 
                             onclick="selectPayeeFromDirectory('${p.name.replace(/'/g, "\\'")}')"
                             onmouseover="this.style.background='var(--bg-hover)'" 
                             onmouseout="this.style.background=''">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-weight:500;">${p.name}</div>
                            <div style="font-size:11px;color:var(--text-secondary);">${addrPreview || 'No address'}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:13px;font-weight:500;">${formatCurrency(p.totalPaid, true)}</div>
                            <div style="font-size:10px;color:var(--text-muted);">${p.checkCount} check${p.checkCount !== 1 ? 's' : ''}</div>
                        </div>
                        <button onclick="event.stopPropagation();openPayeeProfile('${p.name.replace(/'/g, "\\'")}')" 
                                class="btn btn-secondary" style="margin-left:12px;padding:6px 10px;font-size:11px;">
                            View History
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        function selectPayeeFromDirectory(name) {
            closePayeeDirectoryModal();
            document.getElementById('payTo').value = name;
            selectPayee(name);
        }

        // ============================================
        // EXPORT FUNCTIONS (Excel & PDF) with Options Modal
        // ============================================

        let exportFormat = 'excel'; // 'excel' or 'pdf'

        function openExportModal(format) {
            exportFormat = format;
            document.getElementById('exportModalTitle').textContent = format === 'excel' ? 'Export to Excel' : 'Export to PDF';
            document.getElementById('exportConfirmBtn').textContent = format === 'excel' ? 'üìä Export Excel' : 'üìÑ Export PDF';

            // Populate account dropdown
            const accountSelect = document.getElementById('exportAccount');
            accountSelect.innerHTML = '<option value="">All Accounts</option>' +
                accounts.map(a => `<option value="${a.id}">${a.nickname}</option>`).join('');

            // Populate payee dropdown
            const payeeSelect = document.getElementById('exportPayee');
            const uniquePayees = [...new Set(checks.map(c => c.payTo))].sort();
            payeeSelect.innerHTML = '<option value="">All Payees</option>' +
                uniquePayees.map(p => `<option value="${p}">${p}</option>`).join('');

            // Clear other fields
            document.getElementById('exportDateFrom').value = '';
            document.getElementById('exportDateTo').value = '';
            document.getElementById('exportStatus').value = '';
            document.getElementById('exportAmountMin').value = '';
            document.getElementById('exportAmountMax').value = '';

            // Update preview
            updateExportPreview();

            // Add change listeners
            ['exportAccount', 'exportPayee', 'exportDateFrom', 'exportDateTo', 'exportStatus', 'exportAmountMin', 'exportAmountMax'].forEach(id => {
                document.getElementById(id).onchange = updateExportPreview;
                document.getElementById(id).oninput = updateExportPreview;
            });

            document.getElementById('exportOptionsModal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportOptionsModal').classList.remove('active');
        }

        function getExportFilteredChecks() {
            let filtered = [...checks];

            const account = document.getElementById('exportAccount')?.value;
            const payee = document.getElementById('exportPayee')?.value;
            const dateFrom = document.getElementById('exportDateFrom')?.value;
            const dateTo = document.getElementById('exportDateTo')?.value;
            const status = document.getElementById('exportStatus')?.value;
            const amountMin = parseFloat(document.getElementById('exportAmountMin')?.value) || 0;
            const amountMax = parseFloat(document.getElementById('exportAmountMax')?.value) || Infinity;

            if (account) filtered = filtered.filter(c => c.accountId === account);
            if (payee) filtered = filtered.filter(c => c.payTo === payee);
            if (dateFrom) filtered = filtered.filter(c => c.date >= dateFrom);
            if (dateTo) filtered = filtered.filter(c => c.date <= dateTo);
            if (status) filtered = filtered.filter(c => c.status === status);
            if (amountMin > 0) filtered = filtered.filter(c => c.amount >= amountMin);
            if (amountMax < Infinity) filtered = filtered.filter(c => c.amount <= amountMax);

            return filtered;
        }

        function updateExportPreview() {
            const filtered = getExportFilteredChecks();
            const total = filtered.filter(c => c.status !== 'voided').reduce((sum, c) => sum + (c.amount || 0), 0);
            document.getElementById('exportPreviewCount').textContent = filtered.length;
            document.getElementById('exportPreviewTotal').textContent = formatCurrency(total, true);
        }

        function confirmExport() {
            closeExportModal();
            if (exportFormat === 'excel') {
                exportToExcel();
            } else {
                exportToPDF();
            }
        }

        async function exportToExcel() {
            if (!requirePaidPlan('export_data')) return;

            const filtered = getExportFilteredChecks();
            if (!filtered.length) return toast('No checks to export', 'error');

            // Load SheetJS if not loaded
            if (typeof XLSX === 'undefined') {
                toast('Loading Excel library...');
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');
            }

            // Prepare data
            const data = filtered.map(c => ({
                'Date': c.date,
                'Check #': c.checkNo,
                'Payee': c.payTo,
                'Amount': c.amount,
                'Memo': c.memo || '',
                'Account': getAccountNickname(c.accountId),
                'Status': c.status,
                'Created': c.created ? new Date(c.created).toLocaleDateString() : ''
            }));

            // Add totals row
            const totalAmount = filtered.filter(c => c.status !== 'voided').reduce((sum, c) => sum + (c.amount || 0), 0);
            data.push({});
            data.push({
                'Date': '',
                'Check #': '',
                'Payee': 'TOTAL',
                'Amount': totalAmount,
                'Memo': '',
                'Account': '',
                'Status': '',
                'Created': ''
            });

            // Create workbook
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Check History');

            // Auto-width columns
            const colWidths = [
                { wch: 12 }, // Date
                { wch: 10 }, // Check #
                { wch: 25 }, // Payee
                { wch: 12 }, // Amount
                { wch: 20 }, // Memo
                { wch: 15 }, // Account
                { wch: 10 }, // Status
                { wch: 12 }  // Created
            ];
            ws['!cols'] = colWidths;

            // Download
            const filename = `check_history_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, filename);

            toast('Excel file downloaded');
            trackEvent('export_excel', { count: filtered.length });
        }

        async function exportToPDF() {
            if (!requirePaidPlan('export_data')) return;

            const filtered = getExportFilteredChecks();
            if (!filtered.length) return toast('No checks to export', 'error');

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'letter' });

            // Header
            pdf.setFontSize(16);
            pdf.text('Check History Report', 40, 40);
            pdf.setFontSize(10);
            pdf.text(`Generated: ${new Date().toLocaleString()}`, 40, 55);
            pdf.text(`Total Checks: ${filtered.length}`, 40, 68);

            const totalAmount = filtered.filter(c => c.status !== 'voided').reduce((sum, c) => sum + (c.amount || 0), 0);
            pdf.text(`Total Amount: ${formatCurrency(totalAmount, true)}`, 200, 68);

            // Table headers
            const headers = ['Date', 'Check #', 'Payee', 'Amount', 'Memo', 'Account', 'Status'];
            const colWidths = [70, 60, 150, 80, 150, 100, 60];
            let y = 95;
            let x = 40;

            pdf.setFontSize(9);
            pdf.setFont(undefined, 'bold');
            headers.forEach((h, i) => {
                pdf.text(h, x, y);
                x += colWidths[i];
            });

            pdf.setFont(undefined, 'normal');
            y += 15;

            // Draw line
            pdf.setDrawColor(200);
            pdf.line(40, y - 5, 750, y - 5);

            // Table rows
            filtered.forEach((c, idx) => {
                if (y > 550) {
                    pdf.addPage();
                    y = 40;
                }

                x = 40;
                const row = [
                    c.date,
                    c.checkNo,
                    c.payTo.substring(0, 25),
                    formatCurrency(c.amount, true),
                    (c.memo || '').substring(0, 25),
                    getAccountNickname(c.accountId),
                    c.status
                ];

                row.forEach((cell, i) => {
                    pdf.text(String(cell), x, y);
                    x += colWidths[i];
                });

                y += 14;
            });

            // Footer with total
            y += 10;
            pdf.setDrawColor(200);
            pdf.line(40, y - 5, 750, y - 5);
            pdf.setFont(undefined, 'bold');
            pdf.text('TOTAL', 40, y + 10);
            pdf.text(formatCurrency(totalAmount, true), 280, y + 10);

            // Download
            const filename = `check_history_${new Date().toISOString().slice(0, 10)}.pdf`;
            pdf.save(filename);

            toast('PDF file downloaded');
            trackEvent('export_pdf', { count: filtered.length });
        }

        // Helper to load external scripts
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // ============================================
        // COMPANY STATS FUNCTIONS
        // ============================================

        function updateCompanyStats() {
            // Company stats banner has been removed
            // No-op function for compatibility
        }

        function toggleSelectAll() { document.querySelectorAll('.chkSel').forEach(cb => cb.checked = document.getElementById('selectAll').checked); }
        async function deleteSelected() {
            const sel = Array.from(document.querySelectorAll('.chkSel:checked')).map(cb => cb.dataset.id);
            if (!sel.length) return toast('None selected', 'error');
            if (!confirm(`Delete ${sel.length} check(s)?`)) return;

            // Delete from Firebase
            for (const id of sel) {
                await deleteCheckFromFirebase(id);
            }

            checks = checks.filter(c => !sel.includes(c.id));
            localStorage.setItem('cf_checks', JSON.stringify(checks));
            renderChecks(); toast(`${sel.length} deleted`);
        }

        function importEz(e) { const f = e.target.files[0]; if (f) toast('Imported from ezCheckPrinting'); e.target.value = ''; }
        function importQB(e) { const f = e.target.files[0]; if (f) toast('Imported from QuickBooks'); e.target.value = ''; }
        function exportCSV() {
            // Soft-gate: Export requires paid plan
            if (!requirePaidPlan('export_data')) return;

            if (!checks.length) return toast('No checks', 'error');
            const csv = 'Check #,Date,Payee,Amount,Memo,Routing,Account,Status,PrintedAt,PrintCount\n' +
                checks.map(c => `${c.checkNo},${c.date},"${c.payTo}",${c.amount.toFixed(2)},"${c.memo || ''}",${c.routing},${c.account},${c.status},${c.printedAt || ''},${c.printCount || 0}`).join('\n');
            download(csv, 'checks.csv', 'text/csv'); toast('Exported');
        }
        function exportEz() {
            // Soft-gate: Export requires paid plan
            if (!requirePaidPlan('export_data')) return;

            if (!checks.length) return toast('No checks', 'error');
            const csv = 'Check Nu,Payee,Check Amount,Memo,Check Date\n' + checks.map(c => `${c.checkNo},"${c.payTo}",${c.amount.toFixed(2)},"${c.memo || ''}",${c.date}`).join('\n');
            download(csv, 'ezcheck.csv', 'text/csv'); toast('Exported');
        }
        function download(content, name, type) { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([content], { type })); a.download = name; a.click(); }

        // ============ CALIBRATION FUNCTIONS ============

        function loadCalibration() {
            const saved = localStorage.getItem('cf_calibration');
            if (saved) {
                printCalibration = JSON.parse(saved);
            }
            const offsetX = document.getElementById('calibOffsetX');
            const offsetY = document.getElementById('calibOffsetY');
            const scale = document.getElementById('calibScale');
            if (offsetX) offsetX.value = printCalibration.offsetX;
            if (offsetY) offsetY.value = printCalibration.offsetY;
            if (scale) scale.value = printCalibration.scale;
        }

        function saveCalibration() {
            printCalibration.offsetX = parseFloat(document.getElementById('calibOffsetX').value) || 0;
            printCalibration.offsetY = parseFloat(document.getElementById('calibOffsetY').value) || 0;
            printCalibration.scale = parseFloat(document.getElementById('calibScale').value) || 1;

            localStorage.setItem('cf_calibration', JSON.stringify(printCalibration));

            // Also save to Firebase if logged in
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).set({ calibration: printCalibration }, { merge: true });
            }

            toast('Calibration saved');
        }

        function resetCalibration() {
            printCalibration = { offsetX: 0, offsetY: 0, scale: 1 };
            document.getElementById('calibOffsetX').value = 0;
            document.getElementById('calibOffsetY').value = 0;
            document.getElementById('calibScale').value = 1;
            localStorage.setItem('cf_calibration', JSON.stringify(printCalibration));
            toast('Calibration reset');
        }

        function printAlignmentTest() {
            const checkHeightIn = parseFloat(document.getElementById('checkHeight').value) || 3.5;
            const checkHeight = checkHeightIn * 72; // Convert to points

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'pt',
                format: 'letter'
            });

            // Title
            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'bold');
            pdf.text('CheckFlow Alignment Test', 36, 30);

            pdf.setFontSize(9);
            pdf.setFont('helvetica', 'normal');
            pdf.setTextColor(100);
            pdf.text(`Check Position: TOP | Check Height: ${checkHeightIn}in | Scale: 100%`, 36, 45);
            pdf.setTextColor(0);

            // Draw check boundaries (dashed)
            pdf.setDrawColor(50);
            pdf.setLineDashPattern([4, 4], 0);

            // Check area
            pdf.rect(18, 0, 576, checkHeight);
            pdf.setFontSize(9);
            pdf.setTextColor(100);
            pdf.text(`CHECK AREA (${checkHeightIn}" height)`, 28, 15);

            // Stub 1
            pdf.rect(18, checkHeight, 576, checkHeight);
            pdf.text('STUB 1', 28, checkHeight + 15);

            // Stub 2
            pdf.rect(18, checkHeight * 2, 576, checkHeight);
            pdf.text('STUB 2', 28, checkHeight * 2 + 15);

            pdf.setLineDashPattern([], 0);
            pdf.setTextColor(0);

            // Draw crosshairs function
            function drawCrosshair(x, y, label, labelOffsetX = 5, labelOffsetY = 15) {
                pdf.setDrawColor(220, 0, 0);
                pdf.setLineWidth(1.5);
                pdf.line(x - 10, y, x + 10, y);
                pdf.line(x, y - 10, x, y + 10);
                pdf.setDrawColor(0);
                pdf.setLineWidth(0.5);
                pdf.setFontSize(8);
                pdf.setTextColor(50);
                pdf.text(label, x + labelOffsetX, y + labelOffsetY);
                pdf.setTextColor(0);
            }

            // Crosshairs in check area
            drawCrosshair(40, 40, 'Top-Left');
            drawCrosshair(570, 40, 'Top-Right', -45);
            drawCrosshair(500, 50, 'Date', -20);
            drawCrosshair(80, 85, 'Pay To');
            drawCrosshair(570, 85, 'Amount', -40);
            drawCrosshair(480, checkHeight - 50, 'Signature', -45);
            drawCrosshair(50, checkHeight - 25, 'MICR Line');

            // Ruler at bottom
            pdf.setFontSize(7);
            for (let i = 0; i <= 16; i++) {
                const x = 36 + (i * 36); // 0.5" = 36pt intervals
                pdf.line(x, 740, x, 755);
                pdf.text(`${i * 0.5}"`, x - 5, 765);
            }

            // Instructions
            pdf.setFontSize(8);
            pdf.setTextColor(100);
            pdf.text('Instructions: Print this PDF at 100% scale. Measure offset from crosshairs to actual check boundaries.', 36, 780);
            pdf.text('Enter offset values in Print Settings to calibrate your check alignment.', 36, 790);

            pdf.save('CheckFlow_Alignment_Test.pdf');
            toast('Alignment test PDF generated');
        }

        // Print confirmation modal
        function showPrintConfirmModal(callback) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'printConfirmModal';
            modal.innerHTML = `
                <div class="modal" style="max-width:450px;">
                    <div class="modal-header">
                        <h2 class="modal-title">üñ®Ô∏è Print Settings Check</h2>
                        <button class="modal-close" onclick="closePrintConfirm()">‚úï</button>
                    </div>
                    <p style="margin-bottom:16px;color:var(--text-secondary);">Please confirm your browser print settings:</p>
                    <div style="background:var(--bg-secondary);padding:14px;border-radius:8px;margin-bottom:16px;">
                        <label style="display:flex;align-items:center;gap:10px;margin-bottom:10px;cursor:pointer;">
                            <input type="checkbox" id="confirmScale"> 
                            <span>Scale is set to <strong>100%</strong> or "Actual Size"</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:10px;margin-bottom:10px;cursor:pointer;">
                            <input type="checkbox" id="confirmMargins"> 
                            <span>Margins set to <strong>None</strong> or Minimum</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                            <input type="checkbox" id="confirmHeaders"> 
                            <span>Headers/Footers are <strong>OFF</strong></span>
                        </label>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="closePrintConfirm()">Cancel</button>
                        <button class="btn btn-primary" id="confirmPrintBtn" onclick="confirmPrint()">Print</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            window.printCallback = callback;
        }

        function closePrintConfirm() {
            const modal = document.getElementById('printConfirmModal');
            if (modal) modal.remove();
        }

        function confirmPrint() {
            closePrintConfirm();
            if (window.printCallback) {
                window.printCallback();
                window.printCallback = null;
            }
        }

        function toast(msg, type = 'success', duration = 3000) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerHTML = msg; // Use innerHTML to render HTML buttons
            t.className = 'toast show ' + type;
            setTimeout(() => t.classList.remove('show'), duration);
        }
    </script>
</body>

</html>
